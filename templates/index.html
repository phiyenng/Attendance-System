<!DOCTYPE html>
<html lang="en">
<head> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Report System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        :root {
            --color-water: #CCF8FE;
            --color-winter-wizard: #99E1F9;
            --color-maya-blue: #6AC3F4;
            --color-brilliant-azure: #4195F4;
            --color-sapphire: #1054BE;
            --color-bg: #f6f7fa;
            --color-card: #fff;
            --color-border: #e0e3ea;
            --color-accent: #4195F4;
            --color-danger: #f47c7c;
            --color-success: #3bb273;
            --color-text: #222;
            --color-muted: #888;
        }
        html {
            font-size: 11.2px;
        }
        body {
            background: var(--color-bg);
            min-height: 100vh;
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--color-text);
        }
        .main-container {
            background: var(--color-card);
            border-radius: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            margin: 16px auto;
            padding: 19px;
            max-width: 1100px;
            border: 1px solid var(--color-border);
        }
        .header {
            text-align: center;
            margin-bottom: 19px;
            color: #111;
            font-weight: bold;
            font-size: 2rem;
        }
        .upload-section {
            background: var(--color-card);
            border-radius: 10px;
            padding: 10px 10px 8px 10px;
            margin-bottom: 10px;
            border: 1.5px solid var(--color-border);
            transition: box-shadow 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.03);
        }
        .upload-section:hover {
            border-color: var(--color-accent);
            box-shadow: 0 2px 8px rgba(65, 149, 244, 0.08);
        }
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }
        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        .upload-btn {
            background: var(--color-accent);
            border: none;
            color: #fff;
            padding: 5px 14px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.8rem;
            transition: background 0.2s;
        }
        .upload-btn:hover {
            background: #1054BE;
        }
        .action-buttons {
            margin: 10px 0 6px 0;
        }
        .btn-action {
            margin: 2px;
            border-radius: 7px;
            font-weight: 600;
            font-size: 0.74rem;
            padding: 4px 10px;
            transition: background 0.15s, color 0.15s;
            border: none;
        }
        .btn-refresh {
            background: var(--color-accent);
            color: #fff;
        }
        .btn-calculate {
            background: #e0e3ea;
            color: #222;
        }
        .btn-clear {
            background: var(--color-danger);
            color: #fff;
        }
        .btn-export {
            background: #08a045;
            color: #fff;
        }
        .btn-action:hover {
            background: #333;
            color: #fff;
        }
        .status-card {
            background: var(--color-card);
            color: #222;
            border-radius: 10px;
            padding: 8px 0;
            margin: 10px 0;
            text-align: center;
            border: 1px solid var(--color-border);
        }
        .status-number {
            font-size: 0.92rem;
            font-weight: 700;
            margin: 4px 0;
            color: #111;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 10px;
        }
        .spinner-border {
            width: 1.3rem;
            height: 1.3rem;
        }
        .alert {
            border-radius: 8px;
            border: none;
            margin: 6px 0;
            font-size: 0.7rem;
        }
        .alert-success {
            background: #eafaf1;
            color: var(--color-success);
        }
        .alert-danger {
            background: #fff0f0;
            color: var(--color-danger);
        }
        .table-container {
            background: var(--color-card);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.03);
            margin-top: 10px;
            border: 1px solid var(--color-border);
        }
        .table {
            margin-bottom: 0;
            font-size: 0.7rem;
        }
        .table th {
            background: #f6f7fa;
            color: #222;
            border: none;
            font-weight: 600;
            text-align: center;
            padding: 6px 4px;
        }
        .table td {
            border: 1px solid var(--color-border);
            padding: 4px 3px;
            vertical-align: middle;
        }
        .data-type-label {
            font-weight: 600;
            color: #222;
            margin-bottom: 4px;
            font-size: 0.8rem;
        }
        .badge.bg-danger {
            background: var(--color-danger) !important;
            color: #fff;
        }
        .badge.bg-warning {
            background: #ffe066 !important;
            color: #222;
        }

        .flatpickr-calendar {
            font-size: 0.9em !important;
            min-width: 0 !important;
            padding: 4px 6px !important;
            width: 345px !important;
            max-width: 100% !important;
        }
        .flatpickr-calendar .flatpickr-days,
        .flatpickr-calendar .flatpickr-months,
        .flatpickr-calendar .flatpickr-weekdays,
        .flatpickr-calendar .flatpickr-time {
            font-size: 0.9em !important;
        }
        .flatpickr-calendar .flatpickr-day {
            padding: 1px 0 !important;
            min-width: 20px !important;
            height: 20px !important;
            line-height: 20px !important;
        }
        /* Optional: Adjust input font size for consistency */
        input.flatpickr-datetime {
            font-size: 1.2em;
            padding: 2px 6px;
        }
        /* Add this CSS to style the special rules table columns smaller */
        .special-rules-table th, .special-rules-table td {
            max-width: 150px;
            width: 90px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-left: 2px;
            padding-right: 2px;
        }
        /* Style for Special Weekend header font size */
        .special-rules-table th.special-weekend-header {
            font-size: 1.2em;
        }
        /* Style for large font size on special rules headers */
        .special-rules-table th.special-rules-header-large {
            font-size: 1.2em;
        }
        
        /* X icon for clearing cell */
        .clear-cell-x {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            color: #d32f2f;
            font-size: 1.1em;
            cursor: pointer;
            z-index: 2;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .clear-cell-x:hover {
            opacity: 1;
        }
        .special-rules-table td {
            position: relative;
        }
        .calendar-cell-icon {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
            font-size: 1.1em;
            cursor: pointer;
            z-index: 2;
            opacity: 0.7;
            transition: opacity 0.2s;
            display: inline-block;
        }
        .calendar-cell-icon:hover {
            opacity: 1;
        }
        .table th, .table td {
            min-width: 90px;
            max-width: 180px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* Loại bỏ ellipsis cho các cột đặc biệt, cho phép xuống dòng */
        .table th.special-multiline, .table td.special-multiline {
            white-space: normal !important;
            overflow: visible !important;
            text-overflow: initial !important;
            max-width: 350px;
        }
        /* Employee List STT column nhỏ và căn giữa */
        #employeeListContent table th:first-child, #employeeListContent table td:first-child {
            min-width: 40px;
            max-width: 50px;
            width: 45px;
            text-align: center;
        }
        /* Special Rules Table: thu nhỏ và căn giữa các cột */
        .special-rules-table th, .special-rules-table td {
            min-width: 120px;
            max-width: 180px;
            width: 140px;
            text-align: center;
        }
        /* Special Rules Table: thu nhỏ và căn giữa các cột, ưu tiên cao */
        #rulesTableContainer .special-rules-table th,
        #rulesTableContainer .special-rules-table td {
            min-width: 90px !important;
            max-width: 140px !important;
            width: 110px !important;
            text-align: center !important;
            vertical-align: middle !important;
        }
        #rulesTableContainer .special-rules-table input.form-control {
            text-align: center !important;
        }
        #lieuFollowupTableContainer table th:first-child, #lieuFollowupTableContainer table td:first-child {
            min-width: 40px;
            max-width: 50px;
            width: 45px;
            text-align: center;
        }
        /* OT Lieu Before: màu nền cho các nhóm cột */
        .ot-payment-col {
            background: #b3e0ff !important;
        }
        .lieu-col {
            background: #fff7b3 !important;
        }
        .timeoff-col {
            background: #b6e7b0 !important;
        }
        #otlieuReportTab table th:first-child,
        #otlieuReportTab table td:first-child {
            min-width: 40px;
            max-width: 50px;
            width: 45px;
            text-align: center;
            vertical-align: middle;
            padding-left: 0;
            padding-right: 0;
        }
        #totalAttendanceDetailTab table th:first-child,
        #totalAttendanceDetailTab table td:first-child {
            min-width: 40px;
            max-width: 50px;
            width: 45px;
            text-align: center;
            vertical-align: middle;
            padding-left: 0;
            padding-right: 0;
        }
    </style>
</head>
<body>
    <!-- Permanent Top Navigation Bar -->
    <nav class="navbar navbar-light bg-white border-bottom mb-3 px-3" style="border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.03);">
        <span class="navbar-brand mb-0 h1" style="font-size:1.2rem;font-weight:bold;">Attendance Report System</span>
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-outline-dark btn-sm nav-tab" id="navRules" onclick="showSection('rulesSection')">Rules</button>
            <button class="btn btn-outline-dark btn-sm nav-tab" id="navEmployeeList" onclick="showSection('employeeListSection')">Employee List</button>
            <button class="btn btn-outline-primary btn-sm nav-tab" id="navMain" onclick="showSection('mainSection')">Data</button>
            <button class="btn btn-outline-secondary btn-sm nav-tab" id="navReport" onclick="showSection('reportSection')">Report</button>
        </div>
    </nav>
    <div class="container-fluid">
        <div class="main-container">
            <div class="header">
                <h1><strong>Attendance Report System</strong></h1>
            </div>
            <div id="alertContainer"></div>
            <div id="loading" class="loading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Processing...</p>
            </div>

            <!-- Employee List Section -->
            <div id="employeeListSection" style="display:none;">
                <div class="mb-3 d-flex flex-wrap gap-2 align-items-center">
                    <form id="employeeImportForm" enctype="multipart/form-data" class="d-flex gap-2 align-items-center">
                        <input type="file" id="employeeImportFile" name="file" accept=".xlsx,.xls,.csv" class="form-control form-control-sm" style="max-width:220px;">
                        <button type="submit" class="btn btn-sm btn-primary"><i class="fas fa-upload"></i> Import</button>
                    </form>
                    <form id="addEmployeeForm" class="d-flex gap-1 flex-wrap align-items-center">
                        <input type="text" name="Name" placeholder="Name" class="form-control form-control-sm" style="width:120px;">
                        <input type="text" name="ID Number" placeholder="ID Number" class="form-control form-control-sm" style="width:110px;">
                        <select name="Dept" class="form-control form-control-sm" style="width:90px;">
                            <option value="">Dept</option>
                            <option value="Admin">Admin</option>
                            <option value="E&S">E&amp;S</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Sales">Sales</option>
                            <option value="Support">Support</option>
                            <option value="Terminal">Terminal</option>
                        </select>
                        <select name="Internship" class="form-control form-control-sm" style="width:110px;">
                            <option value="">Internship</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                        <button type="submit" class="btn btn-sm btn-success"><i class="fas fa-plus"></i> Add</button>
                    </form>
                </div>
                <div id="employeeListContent"></div>
            </div>

            <!-- Main Section -->
            <div id="mainSection" style="display:none;">
                <!-- Data Import Section -->
                <div id="importSection">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="upload-section position-relative" id="signinoutCard">
                                <div class="data-type-label">
                                    <i class="fas fa-sign-in-alt"></i> Sign In/Out Data
                                </div>
                                <div class="file-input-wrapper">
                                    <input type="file" id="signinoutFile" class="file-input" accept=".xlsx,.xls,.csv">
                                    <button class="btn upload-btn" onclick="document.getElementById('signinoutFile').click()">
                                        <i class="fas fa-upload"></i> Choose File
                                    </button>
                                </div>
                                <div id="signinoutStatus" class="mt-2 text-muted"></div>
                                <button type="button" class="btn btn-link btn-sm position-absolute top-0 end-0 m-2 p-0 d-none" id="clearSigninoutBtn" title="Clear Sign In/Out" onclick="clearData('signinout')">
                                    <span style="font-size:1.3rem;color:#f47c7c;">&times;</span>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="upload-section position-relative" id="applyCard">
                                <div class="data-type-label">
                                    <i class="fas fa-file-alt"></i> Apply Data
                                </div>
                                <div class="file-input-wrapper">
                                    <input type="file" id="applyFile" class="file-input" accept=".xlsx,.xls,.csv">
                                    <button class="btn upload-btn" onclick="document.getElementById('applyFile').click()">
                                        <i class="fas fa-upload"></i> Choose File
                                    </button>
                                </div>
                                <div id="applyStatus" class="mt-2 text-muted"></div>
                                <button type="button" class="btn btn-link btn-sm position-absolute top-0 end-0 m-2 p-0 d-none" id="clearApplyBtn" title="Clear Apply" onclick="clearData('apply')">
                                    <span style="font-size:1.3rem;color:#f47c7c;">&times;</span>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="upload-section position-relative" id="otlieuCard">
                                <div class="data-type-label">
                                    <i class="fas fa-clock"></i> OT Lieu Data
                                </div>
                                <div class="file-input-wrapper">
                                    <input type="file" id="otlieuFile" class="file-input" accept=".xlsx,.xls,.csv">
                                    <button class="btn upload-btn" onclick="document.getElementById('otlieuFile').click()">
                                        <i class="fas fa-upload"></i> Choose File
                                    </button>
                                </div>
                                <div id="otlieuStatus" class="mt-2 text-muted"></div>
                                <button type="button" class="btn btn-link btn-sm position-absolute top-0 end-0 m-2 p-0 d-none" id="clearOtlieuBtn" title="Clear OT Lieu" onclick="clearData('otlieu')">
                                    <span style="font-size:1.3rem;color:#f47c7c;">&times;</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Action Buttons -->
                <div class="action-buttons mt-3 mb-2">
                    <button class="btn btn-action btn-calculate" id="calculateBtn" onclick="calculateMain()">
                        <i class="fas fa-calculator"></i> Calculate
                    </button>
                    <button class="btn btn-action btn-export" id="reportBtn" style="display:none; margin-left:8px;" onclick="goToReport()">
                        <i class="fas fa-chart-bar"></i> Report
                    </button>
                </div>
                <!-- Data Table Switcher and Table -->
                <div id="dataTableSwitcherSection" style="display:none;">
                    <div class="mb-2">
                        <label for="dataTableSelect" class="form-label">Select Data Table:</label>
                        <select id="dataTableSelect" class="form-select form-select-sm" style="max-width:200px;display:inline-block;">
                            <option value="signinout">Sign In/Out</option>
                            <option value="apply">Apply</option>
                            <option value="otlieu">OT Lieu</option>
                        </select>
                    </div>
                    <div id="dataTableContainer"></div>
                </div>
            </div>

            <!-- Report Section -->
            <div id="reportSection" style="display:none;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <button class="btn btn-outline-primary btn-sm me-2" id="lieuFollowupBtn">Lieu Followup</button>
                    </div>
                    <div>
                        <button class="btn btn-outline-secondary btn-sm me-2" id="reviewDataBtn"><i class="fas fa-table"></i> Review Data</button>
                        <button class="btn btn-outline-danger btn-sm" id="backToEditBtn"><i class="fas fa-arrow-left"></i> Back to Edit</button>
                        <button class="btn btn-action btn-success btn-sm ms-2" id="exportAttendanceReportBtn" style="background:#43a047;color:#fff;border:none;">
                            <i class="fas fa-file-export"></i> Export
                        </button>
                    </div>
                </div>
                <ul class="nav nav-tabs mb-3" id="reportNavTabs">
                    <li class="nav-item">
                        <a class="nav-link active" id="nav-otlieu-before" data-bs-toggle="tab" href="#otlieuBeforeTab">OT Lieu Before</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="nav-otlieu-report" data-bs-toggle="tab" href="#otlieuReportTab">OT Lieu Report</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="nav-total-attendance" data-bs-toggle="tab" href="#totalAttendanceDetailTab">Total Attendance Detail</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="nav-attendance-report" data-bs-toggle="tab" href="#attendanceReportTab">Attendance Report</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="nav-abnormal" data-bs-toggle="tab" href="#abnormalTab">Abnormal</a>
                    </li>
                </ul>
                <div class="tab-content" id="reportTabContent">
                    <div class="tab-pane fade show active" id="otlieuBeforeTab"> <!-- OT Lieu Before content here --> </div>
                    <div class="tab-pane fade" id="otlieuReportTab"> <!-- OT Lieu Report content here --> </div>
                    <div class="tab-pane fade" id="totalAttendanceDetailTab"> <!-- Total Attendance Detail content here --> </div>
                    <div class="tab-pane fade" id="attendanceReportTab">
                        <div id="attendanceReportHeader" class="d-flex flex-column align-items-center mb-3">
                            <h2 style="font-weight:bold; text-align:center; margin-bottom:10px;">Monthly Attendance Report</h2>
                            <div class="d-flex gap-2 align-items-center">
                                <label for="attendanceMonth" class="form-label mb-0">Month:</label>
                                <select id="attendanceMonth" class="form-select form-select-sm" style="width:80px;"></select>
                                <label for="attendanceYear" class="form-label mb-0">Year:</label>
                                <select id="attendanceYear" class="form-select form-select-sm" style="width:90px;"></select>
                            </div>
                        </div>
                        <div id="attendanceReportTableContainer"></div>
                    </div>
                    <div class="tab-pane fade" id="abnormalTab"> <!-- Abnormal content here --> </div>
                </div>
            </div>

            <!-- Rules Section -->
            <div id="rulesSection" style="display:none;">
                <div class="mb-3">
                    <h4>Attendance Rules</h4>
                    <div style="font-family: 'Segoe UI', 'Roboto', Arial, sans-serif; font-size: 1.08rem; color: #222; line-height: 1.45;">
                      <div style="font-weight: bold; font-size: 1.13rem; margin-bottom: 0.3em;">
                        <span style="font-size:1.2em;vertical-align:-2px;">🕰️</span>
                        Beijing Time (GMT+8), Valid for the Current Day:
                      </div>
                      <ul style="margin-bottom: 0.4em; padding-left: 1.2em;">
                        <li>
                          <span style="font-weight: 500;">Normal clock-in time (morning):</span>
                          <span style="color: #1976d2; font-weight: 500;">07:00 – 09:30</span>
                          <div style="margin-left:1.2em; color:#555; font-size:0.98em; border-left:3px solid #e0e0e0; padding-left:0.7em; margin-top:0.2em;">
                            Clocking in after <span style="color:#d32f2f;font-weight:500;">13:00</span> is considered <span style="color:#d32f2f;font-weight:500;">morning absence</span>
                          </div>
                        </li>
                        <li style="margin-top:0.5em;">
                          <span style="font-weight: 500;">Normal clock-out time (evening):</span>
                          <span style="color: #1976d2; font-weight: 500;">18:30 – 23:59</span>
                          <div style="margin-left:1.2em; color:#555; font-size:0.98em; border-left:3px solid #e0e0e0; padding-left:0.7em; margin-top:0.2em;">
                            Clocking out before <span style="color:#d32f2f;font-weight:500;">14:30</span> is considered <span style="color:#d32f2f;font-weight:500;">afternoon absence</span>
                          </div>
                        </li>
                      </ul>
                      <hr style="margin:1.2em 0 1em 0;">
                      <div style="font-weight: bold; margin-bottom: 0.2em; color:#d32f2f;">
                        <span style="font-size:1.1em;vertical-align:-2px;">📌</span>
                        Status Definitions:
                      </div>
                      <ul style="margin-bottom: 0.4em; padding-left: 1.2em;">
                        <li>
                          <span style="font-weight: 500;">Late:</span>
                          <span style="color: #d32f2f;">Clock-in time after 09:30</span>
                        </li>
                        <li style="margin-top:0.2em;">
                          <span style="font-weight: 500;">Early leave:</span>
                          <span style="color: #d32f2f;">Clock-out time before 18:30</span>
                        </li>
                        <li style="margin-top:0.2em;">
                          <span style="font-weight: 500;">Absent (No attendance):</span>
                          <span style="color: #d32f2f;">No clock-in or clock-out record for the day</span>
                        </li>
                      </ul>
                      <hr style="margin:1.2em 0 1em 0;">
                      <div style="font-weight: bold; margin-bottom: 0.2em; color:#1976d2;">
                        <span style="font-size:1.1em;vertical-align:-2px;">✅</span>
                        Valid Exceptions <span style="font-weight: normal; color:#222;">(must be applied and approved the same day)</span>
                      </div>
                      <ul style="padding-left: 1.2em;">
                        <li>
                          <span style="font-weight: 500;">Business trip:</span>
                          <span>Applied between <span style="color: #1976d2;">09:30 – 18:30</span>, and approved</span>
                        </li>
                        <li style="margin-top:0.2em;">
                          <span style="font-weight: 500;">Leave request:</span>
                          <span>Applied between <span style="color: #1976d2;">09:30 – 18:30</span>, and approved</span>
                        </li>
                        <li style="margin-top:0.2em;">
                          <span style="font-weight: 500;">Supplementary clocking (manual correction):</span>
                          <span>Applied between <span style="color: #1976d2;">09:30 – 18:30</span>, and approved</span>
                        </li>
                      </ul>
                    </div>
                </div>
                <hr style="margin:1.2em 0 1em 0;">
                <div class="mb-3">
                    <h4>Special Rules Table</h4>
                    <div id="rulesTableContainer"></div>
                    <button class="btn btn-sm btn-success mt-2" onclick="addRuleRow()"><i class="fas fa-plus"></i> Add Rule</button>
                    <button class="btn btn-sm btn-primary mt-2 ms-2" id="saveRulesBtn" onclick="saveRulesTable()"><i class="fas fa-save"></i> Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for sheet selection and preview -->
    <div class="modal fade" id="sheetPreviewModal" tabindex="-1" aria-labelledby="sheetPreviewModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="sheetPreviewModalLabel">Preview & Select Sheet</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="sheetSelectContainer" class="mb-3" style="display:none;">
              <label for="sheetSelect" class="form-label">Choose a sheet:</label>
              <select id="sheetSelect" class="form-select" style="max-width: 300px;"></select>
            </div>
            <div id="sheetPreviewTableContainer"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="confirmImportBtn">Import</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Save Completed Dialog Modal -->
    <div class="modal fade" id="saveCompletedModal" tabindex="-1" aria-labelledby="saveCompletedModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="saveCompletedModalLabel">Success</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Save completed!
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Time Format Warning Dialog Modal -->
    <div class="modal fade" id="timeFormatWarningModal" tabindex="-1" aria-labelledby="timeFormatWarningModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="timeFormatWarningModalLabel">Import Error!</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Please use the correct format when importing: <b>HH:MM</b>. For example: <b>09:30</b>, <b>17:45</b>, <b>21:00</b>.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
          </div>
        </div>
      </div>
    </div>

    <!-- OT Lieu Validation Modal -->
    <div class="modal fade" id="otlieuValidationModal" tabindex="-1" aria-labelledby="otlieuValidationModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="otlieuValidationModalLabel">Data Error!</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="otlieuValidationModalBody">
            <!-- Message will be injected here -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal for Review Data Preview -->
    <div class="modal fade" id="reviewDataModal" tabindex="-1" aria-labelledby="reviewDataModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="reviewDataModalLabel">Review Data</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <ul class="nav nav-tabs mb-2" id="reviewDataTabs">
              <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#reviewSigninoutTab">Sign In/Out</a></li>
              <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#reviewApplyTab">Apply</a></li>
              <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#reviewOtlieuTab">OT Lieu</a></li>
            </ul>
            <div class="tab-content">
              <div class="tab-pane fade show active" id="reviewSigninoutTab"> <!-- Preview Sign In/Out here --> </div>
              <div class="tab-pane fade" id="reviewApplyTab"> <!-- Preview Apply here --> </div>
              <div class="tab-pane fade" id="reviewOtlieuTab"> <!-- Preview OT Lieu here --> </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal for Lieu Followup -->
    <div class="modal fade" id="lieuFollowupModal" tabindex="-1" aria-labelledby="lieuFollowupModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="lieuFollowupModalLabel">Lieu Followup</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="d-flex mb-2 gap-2">
              <input type="file" id="lieuFollowupImportFile" accept=".xlsx,.xls" class="form-control form-control-sm" style="max-width:220px;">
              <button class="btn btn-sm btn-primary" id="lieuFollowupImportBtn">Import</button>
              <button class="btn btn-sm btn-success" id="lieuFollowupAddBtn">Add</button>
            </div>
            <div id="lieuFollowupTableContainer"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Missing Data Dialog -->
    <div class="modal fade" id="missingDataModal" tabindex="-1" aria-labelledby="missingDataModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="missingDataModalLabel">Missing Data!</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="missingDataModalBody">
            Please import all required data files (Sign In/Out, Apply, OT Lieu) in the Data tab before viewing the report.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let pendingFile = null;
        let pendingDataType = null;
        let previewData = null;
        let selectedSheet = null;
        let sheetNames = null;
        let sheetModal = new bootstrap.Modal(document.getElementById('sheetPreviewModal'));
        let cachedTables = {signinout: null, apply: null, otlieu: null};

        // Override file upload handlers
        document.getElementById('signinoutFile').addEventListener('change', function(e) {
            handleFilePreview(e.target.files[0], 'signinout');
        });
        document.getElementById('applyFile').addEventListener('change', function(e) {
            handleFilePreview(e.target.files[0], 'apply');
        });
        document.getElementById('otlieuFile').addEventListener('change', function(e) {
            handleFilePreview(e.target.files[0], 'otlieu');
        });

        function handleFilePreview(file, dataType) {
            if (!file) return;
            pendingFile = file;
            pendingDataType = dataType;
            showLoading(true);
            showAlert('', '');
            const formData = new FormData();
            formData.append('file', file);
            fetch('/preview_upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                if (data.success) {
                    previewData = data.preview;
                    sheetNames = data.sheet_names;
                    selectedSheet = sheetNames[0];
                    showSheetPreviewModal();
                } else {
                    showAlert('danger', data.error);
                }
            })
            .catch(error => {
                showLoading(false);
                showAlert('danger', 'Error previewing file: ' + error.message);
            });
        }

        function showSheetPreviewModal() {
            // Populate sheet select if multiple sheets
            const select = document.getElementById('sheetSelect');
            const selectContainer = document.getElementById('sheetSelectContainer');
            if (sheetNames.length > 1) {
                select.innerHTML = '';
                sheetNames.forEach(name => {
                    const opt = document.createElement('option');
                    opt.value = name;
                    opt.textContent = name;
                    select.appendChild(opt);
                });
                select.value = selectedSheet;
                selectContainer.style.display = '';
            } else {
                selectContainer.style.display = 'none';
            }
            renderSheetPreview(selectedSheet);
            select.onchange = function() {
                selectedSheet = select.value;
                renderSheetPreview(selectedSheet);
            };
            sheetModal.show();
        }

        function renderSheetPreview(sheet) {
            const container = document.getElementById('sheetPreviewTableContainer');
            if (!previewData[sheet]) {
                container.innerHTML = '<div class="text-danger">No preview available for this sheet.</div>';
                return;
            }
            const columns = previewData[sheet].columns;
            const rows = previewData[sheet].rows;
            let html = '<div class="table-responsive"><table class="table table-bordered"><thead><tr>';
            columns.forEach(col => html += `<th>${col}</th>`);
            html += '</tr></thead><tbody>';
            rows.forEach(row => {
                html += '<tr>';
                row.forEach(cell => html += `<td>${cell}</td>`);
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        document.getElementById('confirmImportBtn').onclick = function() {
            if (!pendingFile || !pendingDataType || !selectedSheet) return;
            showLoading(true);
            showAlert('', '');
            const formData = new FormData();
            formData.append('file', pendingFile);
            formData.append('data_type', pendingDataType);
            formData.append('sheet_name', selectedSheet);
            fetch('/import_with_sheet', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                sheetModal.hide();
                if (data.success) {
                    showAlert('success', data.message);
                    updateStatus(pendingDataType, data.rows);
                } else {
                    showAlert('danger', data.error);
                }
            })
            .catch(error => {
                showLoading(false);
                sheetModal.hide();
                showAlert('danger', 'Error importing file: ' + error.message);
            });
        };

        function refresh() {
            showLoading(true);
            showAlert('', '');

            fetch('/refresh', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                if (data.success) {
                    showAlert('success', data.message);
                } else {
                    showAlert('danger', data.error);
                }
            })
            .catch(error => {
                showLoading(false);
                showAlert('danger', 'Error refreshing data: ' + error.message);
            });
        }

        function calculateAbnormal() {
            showLoading(true);
            showAlert('', '');

            fetch('/calculate_abnormal', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                if (data.success) {
                    showAlert('success', data.message);
                    loadAbnormalData();
                } else {
                    showAlert('danger', data.error);
                }
            })
            .catch(error => {
                showLoading(false);
                showAlert('danger', 'Error calculating abnormal: ' + error.message);
            });
        }

        function loadAbnormalData() {
            fetch('/get_abnormal_data')
            .then(response => response.json())
            .then(data => {
                if (data.data && data.data.length > 0) {
                    displayAbnormalData(data.data);
                } else {
                    document.getElementById('abnormalTable').style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error loading abnormal data:', error);
            });
        }

        function displayAbnormalData(data) {
            const tableBody = document.getElementById('abnormalTableBody');
            tableBody.innerHTML = '';

            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.Employee}</td>
                    <td>${row.Date}</td>
                    <td>${row.SignIn}</td>
                    <td>${row.SignOut}</td>
                    <td><span class="badge bg-${row.Status === 'Late' ? 'danger' : 'warning'}">${row.Status}</span></td>
                    <td>${row.LateMinutes}</td>
                `;
                tableBody.appendChild(tr);
            });

            document.getElementById('abnormalTable').style.display = 'block';
        }

        function clearData(dataType) {
            if (!confirm(`Are you sure you want to clear ${dataType} data?`)) {
                return;
            }

            showLoading(true);
            showAlert('', '');

            fetch(`/clear/${dataType}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                if (data.success) {
                    showAlert('success', data.message);
                    updateStatus(dataType, 0);
                    // Reset upload component UI
                    const statusElement = document.getElementById(`${dataType}Status`);
                    if (statusElement) statusElement.innerHTML = '';
                    const clearBtn = {
                        'signinout': document.getElementById('clearSigninoutBtn'),
                        'apply': document.getElementById('clearApplyBtn'),
                        'otlieu': document.getElementById('clearOtlieuBtn')
                    }[dataType];
                    if (clearBtn) clearBtn.classList.add('d-none');
                    // Reset input file
                    const fileInput = {
                        'signinout': document.getElementById('signinoutFile'),
                        'apply': document.getElementById('applyFile'),
                        'otlieu': document.getElementById('otlieuFile')
                    }[dataType];
                    if (fileInput) fileInput.value = '';
                } else {
                    showAlert('danger', data.error);
                }
            })
            .catch(error => {
                showLoading(false);
                showAlert('danger', 'Error clearing data: ' + error.message);
            });
        }

        function updateStatus(dataType, count) {
            const statusElement = document.getElementById(`${dataType}Status`);
            const clearBtn = {
                'signinout': document.getElementById('clearSigninoutBtn'),
                'apply': document.getElementById('clearApplyBtn'),
                'otlieu': document.getElementById('clearOtlieuBtn')
            }[dataType];
            if (count > 0) {
                statusElement.innerHTML = `<i class="fas fa-check text-success"></i> ${count} records loaded`;
                if (clearBtn) clearBtn.classList.remove('d-none');
            } else {
                if (clearBtn) clearBtn.classList.add('d-none');
            }
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showAlert(type, message) {
            const alertContainer = document.getElementById('alertContainer');
            if (message) {
                alertContainer.innerHTML = `
                    <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
            } else {
                alertContainer.innerHTML = '';
            }
        }

        // Auto-hide alerts after 5 seconds
        setInterval(() => {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            });
        }, 5000);

        // NAVIGATION LOGIC
        function showSection(sectionId) {
            // Hide all
            document.getElementById('rulesSection').style.display = 'none';
            document.getElementById('employeeListSection').style.display = 'none';
            document.getElementById('mainSection').style.display = 'none';
            document.getElementById('reportSection').style.display = 'none';
            // Remove active from all navs
            document.getElementById('navRules').classList.remove('active');
            document.getElementById('navEmployeeList').classList.remove('active');
            document.getElementById('navMain').classList.remove('active');
            document.getElementById('navReport').classList.remove('active');
            // Show selected
            document.getElementById(sectionId).style.display = '';
            // Set active nav
            if(sectionId==='rulesSection') document.getElementById('navRules').classList.add('active');
            if(sectionId==='employeeListSection') document.getElementById('navEmployeeList').classList.add('active');
            if(sectionId==='mainSection') document.getElementById('navMain').classList.add('active');
            if(sectionId==='reportSection') document.getElementById('navReport').classList.add('active');
            // Special: reload employee list if needed
            if(sectionId==='employeeListSection') reloadEmployeeList();
            if(sectionId==='rulesSection') loadRulesTable();
        }
        
        // Default to Main
        showSection('mainSection');

        // Calculate button logic for Main
        function calculateMain() {
            showLoading(true);
            showAlert('', '');
            fetch('/calculate_abnormal', {method: 'POST'})
                .then(res => res.json())
                .then(data => {
                    showLoading(false);
                    if(data.success) {
                        showAlert('success', data.message);
                        // Fetch all 3 data tables and cache
                        Promise.all([
                            fetch('/get_signinout_data').then(res=>res.json()),
                            fetch('/get_apply_data').then(res=>res.json()),
                            fetch('/get_otlieu_data').then(res=>res.json())
                        ]).then(([signinout, apply, otlieu]) => {
                            cachedTables.signinout = signinout;
                            cachedTables.apply = apply;
                            cachedTables.otlieu = otlieu;
                            document.getElementById('dataTableSwitcherSection').style.display = '';
                            document.getElementById('reportBtn').style.display = '';
                            renderSelectedTable();
                        });
                    } else {
                        showAlert('danger', data.error);
                    }
                })
                .catch(() => {
                    showLoading(false);
                    showAlert('danger', 'Error calculating.');
                });
        }
        document.getElementById('dataTableSelect').onchange = renderSelectedTable;
        
        // --- Render Selected Table ---
        function renderSelectedTable() {
            const type = document.getElementById('dataTableSelect').value;
            if (type === 'signinout') {
                renderTable('dataTableContainer', cachedTables.signinout.columns, cachedTables.signinout.data);
            } else if (type === 'apply') {
                renderTable('dataTableContainer', cachedTables.apply.columns, cachedTables.apply.data, ['Type','Results','Leave Type']);
            } else if (type === 'otlieu') {
                renderTable('dataTableContainer', cachedTables.otlieu.columns, cachedTables.otlieu.data);
            }
        }
        
        // --- Dropdown for Type & Leave Type in Apply Table ---
        let applyColumnOptions = {};
        fetch('/get_apply_column_options').then(res => res.json()).then(data => { applyColumnOptions = data; });
        
        // --- Scroll position persistence ---
        let lastScrollTop = 0;
        let lastScrollLeft = 0;
        
        // Enhanced renderTable: highlight new columns if provided
        function renderTable(containerId, columns, rows, highlightCols=[]) {
            const pageSize = 50;
            let currentPage = 1;
            const totalPages = Math.ceil(rows.length / pageSize);
            let editingRow = null;
            
            function renderPage(page) {
                const container = document.getElementById(containerId);
                // Restore scroll position if available
                setTimeout(function() {
                    container.scrollTop = lastScrollTop;
                    container.scrollLeft = lastScrollLeft;
                }, 0);

                let html = '<div class="table-responsive"><table class="table table-bordered"><thead>';
                html += '<tr>';
                columns.forEach(col => {
                    if (highlightCols && highlightCols.includes(col)) {
                        html += `<th style="background:#d0f0ff;">${col}</th>`;
                    } else {
                        html += `<th>${col}</th>`;
                    }
                });
                html += '</tr>';
                html += '</thead><tbody>';
                const start = (page - 1) * pageSize;
                const end = Math.min(start + pageSize, rows.length);
                for (let i = start; i < end; i++) {
                    const realIdx = i; // realIdx là index thực tế trong toàn bảng
                    html += '<tr>';
                    let row = rows[i];
                    for (let j = 0; j < columns.length; j++) {
                        const col = columns[j];
                        const cell = row[j];
                        const displayValue = (cell && typeof cell === 'object' && 'value' in cell) ? cell.value : cell;
                        // Xác định các cột đặc biệt cho phép xuống dòng
                        const multilineCols = [
                            'Title',
                            'Application Type',
                            'Note',
                            'Proof about leaders arrange (2) Capture screen call/messages',
                            'Capture Screen (3) Check in and check out time',
                            'HRcheck (edit by HR) Tran ThiQuynhTrang00268175',
                            'Proof for pre-approval',
                            'Chek in/out screen capture'
                        ];
                        const isMultiline = multilineCols.some(name => col && col.toLowerCase().includes(name.toLowerCase()));
                        const tdClass = isMultiline ? 'special-multiline' : '';
                        // --- RED ERROR CELL LOGIC ---
                        if (cell && typeof cell === 'object' && cell.error) {
                            html += `<td class="${tdClass}" style="background:#ffeaea;position:relative;">`;
                            html += `<input type="text" class="form-control form-control-sm" value="${displayValue}" style="border:1.5px solid #d32f2f;color:#d32f2f;display:inline-block;width:70px;">`;
                            if (cell.suggest !== undefined && cell.suggest !== null) {
                                html += `<div style="font-size:0.7em;color:#888;">Correct value: <span style="color:#1976d2;font-weight:bold;">${cell.suggest}</span></div>`;
                            }
                            html += `<button class="btn btn-sm btn-success" style="position:absolute;right:2px;top:2px;font-size:0.7em;padding:1px 6px;" onclick="saveErrorCell('${containerId}',${realIdx},${j},this)"><i class='fas fa-check'></i></button>`;
                            html += '</td>';
                        } else if (cell && typeof cell === 'object' && cell.warning && ["OT From","OT To","Lieu From","Lieu To","OTSum","LieuSum"].some(cn => col && col.toLowerCase().replace(/\s/g,'') === cn.toLowerCase().replace(/\s/g,''))) {
                            // --- YELLOW WARNING CELL LOGIC ---
                            html += `<td class="${tdClass}" style="background:#fffbe6;position:relative;">`;
                            html += `<input type="text" class="form-control form-control-sm" value="${displayValue}" style="border:1.5px solid #e6b800;color:#b38f00;display:inline-block;width:90px;">`;
                            html += `<button class="btn btn-sm btn-success" style="position:absolute;right:2px;top:2px;font-size:0.7em;padding:1px 6px;" onclick="saveErrorCell('${containerId}',${realIdx},${j},this)" title="Lưu chỉnh sửa"><i class='fas fa-check'></i></button>`;
                            html += `<div style='font-size:0.7em;color:#b38f00;margin-top:2px;'>Format: <b>HH:MM</b></div>`;
                            html += '</td>';
                        } else if (cell && typeof cell === 'object' && cell.gray) {
                            // --- GRAY CELL LOGIC ---
                            html += `<td class="${tdClass}" style="background:#f2f2f2;color:#888;">${displayValue}</td>`;
                        } else if (columns.includes('Results') && editingRow === realIdx) {
                            // Nếu là dòng đang edit trong bảng Apply
                            if (col === 'Type') {
                                html += `<td><select class="form-select form-select-sm" id="edit_Type_${realIdx}">`;
                                (applyColumnOptions.Type || []).forEach(opt => {
                                    html += `<option value="${opt}" ${cell === opt ? 'selected' : ''}>${opt}</option>`;
                                });
                                html += `</select></td>`;
                            } else if (col === 'Leave Type') {
                                html += `<td><select class="form-select form-select-sm" id="edit_Leave_Type_${realIdx}">`;
                                (applyColumnOptions["Leave Type"] || []).forEach(opt => {
                                    html += `<option value="${opt}" ${cell === opt ? 'selected' : ''}>${opt}</option>`;
                                });
                                html += `</select></td>`;
                            } else if (col === 'Results') {
                                html += `<td><select class="form-select form-select-sm" id="editResults_${realIdx}">
                                    <option value="Approved" ${cell === "Approved" ? "selected" : ""}>Approved</option>
                                    <option value="Pending" ${cell === "Pending" ? "selected" : ""}>Pending</option>
                                    <option value="Reject" ${cell === "Reject" ? "selected" : ""}>Reject</option>
                                </select></td>`;
                            } else {
                                html += `<td class="${tdClass}">${displayValue}</td>`;
                            }
                        } else {
                            html += `<td class="${tdClass}">${displayValue}</td>`;
                        }
                    }
                    if (columns.includes('Results')) {
                        if (editingRow === realIdx) {
                            html += `<td><button class='btn btn-sm btn-success' onclick='saveEditRow(${realIdx})'>Save</button> <button class='btn btn-sm btn-secondary' onclick='cancelEditRow()'>Cancel</button></td>`;
                        } else {
                            html += `<td><button class='btn btn-sm btn-outline-primary' onclick='editRow(${realIdx})'>Edit</button></td>`;
                        }
                    }
                    html += '</tr>';
                }
                html += '</tbody></table></div>';
                html += `<div class='d-flex justify-content-between align-items-center mt-2'>`;
                html += `<span>Page ${page} of ${totalPages}</span>`;
                html += `<div>`;
                html += `<button class='btn btn-sm btn-outline-secondary me-1' ${page === 1 ? 'disabled' : ''} id='${containerId}_prevPageBtn'>Prev</button>`;
                html += `<button class='btn btn-sm btn-outline-secondary' ${page === totalPages ? 'disabled' : ''} id='${containerId}_nextPageBtn'>Next</button>`;
                html += `</div></div>`;
                container.innerHTML = html;

                // Save scroll position on scroll
                container.onscroll = function() {
                    lastScrollTop = container.scrollTop;
                    lastScrollLeft = container.scrollLeft;
                };

                document.getElementById(`${containerId}_prevPageBtn`).onclick = function() {
                    if (currentPage > 1) {
                        renderPage(currentPage - 1);
                    }
                };
                document.getElementById(`${containerId}_nextPageBtn`).onclick = function() {
                    if (currentPage < totalPages) {
                        renderPage(currentPage + 1);
                    }
                };
            }
            // --- Save error cell handler ---
            window.saveErrorCell = function(containerId, rowIdx, colIdx, btn) {
                const table = btn.closest('table');
                const input = btn.closest('td').querySelector('input');
                const newValue = input.value;
                // Nếu là cell warning (bôi vàng) và vẫn sai định dạng thời gian, cảnh báo và không gửi API
                const td = btn.closest('td');
                if (td && td.style.background === 'rgb(255, 251, 230)') { // #fffbe6
                    // Kiểm tra định dạng HH:MM 24h
                    const time24hRegex = /^([01]?\d|2[0-3]):[0-5]\d$/;
                    if (!time24hRegex.test(newValue.trim())) {
                        var timeFormatModal = new bootstrap.Modal(document.getElementById('timeFormatWarningModal'));
                        document.querySelector('#timeFormatWarningModal .modal-body').innerHTML =
                            'Please use the correct format when importing: <b>HH:MM</b>. For example: <b>09:30</b>, <b>17:45</b>, <b>21:00</b>.';
                        timeFormatModal.show();
                        return;
                    }
                }
                // Kiểm tra ô Sum (OT Sum, Lieu Sum): chỉ chấp nhận số thập phân, không dấu phẩy, không chữ
                const columns = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
                const colName = columns[colIdx] || '';
                if (/sum/i.test(colName)) {
                    if (!/^[0-9]+(\.[0-9]+)?$/.test(newValue.trim())) {
                        var timeFormatModal = new bootstrap.Modal(document.getElementById('timeFormatWarningModal'));
                        document.querySelector('#timeFormatWarningModal .modal-body').innerHTML =
                            'Please enter a valid decimal number for Sum. Example: <b>8.5</b>, <b>2</b>, <b>10.0</b>';
                        timeFormatModal.show();
                        return;
                    }
                }
                // Xác định bảng OT Lieu hay Apply
                let type = 'otlieu';
                if (containerId.includes('apply')) type = 'apply';
                // Gửi API update
                fetch(type === 'apply' ? '/update_apply_row' : '/update_otlieu_row', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({index: rowIdx, column: columns[colIdx], value: newValue})
                })
                .then(res => res.json())
                .then(data => {
                    console.log('API response:', data, 'Value sent:', newValue, 'Index:', rowIdx, 'Col:', columns[colIdx]);
                    if (data.success) {
                        // Chỉ update lại cell/dòng vừa chỉnh sửa, không render lại toàn bảng
                        // Cập nhật cache
                        if (type === 'apply') {
                            cachedTables.apply.data[rowIdx][colIdx] = newValue;
                        } else {
                            cachedTables.otlieu.data[rowIdx][colIdx] = newValue;
                        }
                        // Update DOM cell
                        const allRows = table.querySelectorAll('tbody tr');
                        if (allRows[rowIdx]) {
                            const tds = allRows[rowIdx].querySelectorAll('td');
                            if (tds[colIdx]) {
                                let cell = (type === 'apply' ? cachedTables.apply.data[rowIdx][colIdx] : cachedTables.otlieu.data[rowIdx][colIdx]);
                                let displayValue = (cell && typeof cell === 'object' && 'value' in cell) ? cell.value : cell;
                                if (cell && typeof cell === 'object' && cell.error) {
                                    tds[colIdx].outerHTML = `<td style="background:#ffeaea;position:relative;"><input type="text" class="form-control form-control-sm" value="${displayValue}" style="border:1.5px solid #d32f2f;color:#d32f2f;display:inline-block;width:70px;"><div style=\"font-size:0.7em;color:#888;\">Correct value: <span style=\"color:#1976d2;font-weight:bold;\">${cell.suggest ?? ''}</span></div><button class=\"btn btn-sm btn-success\" style=\"position:absolute;right:2px;top:2px;font-size:0.7em;padding:1px 6px;\"><i class='fas fa-check'></i></button></td>`;
                                    // Gán lại event handler cho nút tick (dùng setTimeout để đảm bảo DOM đã cập nhật)
                                    setTimeout(function() {
                                        const newTd = allRows[rowIdx].querySelectorAll('td')[colIdx];
                                        const btn = newTd && newTd.querySelector('button.btn-success');
                                        if (btn) {
                                            btn.onclick = function() {
                                                saveErrorCell(containerId, rowIdx, colIdx, btn);
                                            };
                                        }
                                    }, 0);
                                } else if (cell && typeof cell === 'object' && cell.warning) {
                                    tds[colIdx].outerHTML = `<td style=\"background:#fffbe6;position:relative;\"><input type=\"text\" class=\"form-control form-control-sm\" value=\"${displayValue}\" style=\"border:1.5px solid #e6b800;color:#b38f00;display:inline-block;width:90px;\"><button class=\"btn btn-sm btn-success\" style=\"position:absolute;right:2px;top:2px;font-size:0.7em;padding:1px 6px;\" title=\"Lưu chỉnh sửa\"><i class='fas fa-check'></i></button><div style='font-size:0.7em;color:#b38f00;margin-top:2px;'>Format: <b>HH:MM</b></div></td>`;
                                } else if (cell && typeof cell === 'object' && cell.gray) {
                                    tds[colIdx].outerHTML = `<td style=\"background:#f2f2f2;color:#888;\">${displayValue}</td>`;
                                } else {
                                    tds[colIdx].outerHTML = `<td>${displayValue}</td>`;
                                }
                            }
                        }
                        // Nếu backend trả về updated (sum), update luôn cell sum
                        if (type === 'otlieu' && data.updated) {
                            Object.entries(data.updated).forEach(([sumCol, sumVal]) => {
                                const sumIdx = columns.indexOf(sumCol);
                                if (sumIdx !== -1 && allRows[rowIdx]) {
                                    cachedTables.otlieu.data[rowIdx][sumIdx] = sumVal;
                                    const tds = allRows[rowIdx].querySelectorAll('td');
                                    let cell = sumVal;
                                    let displayValue = (cell && typeof cell === 'object' && 'value' in cell) ? cell.value : cell;
                                    if (cell && typeof cell === 'object' && cell.error) {
                                        tds[sumIdx].outerHTML = `<td style=\"background:#ffeaea;position:relative;\"><input type=\"text\" class=\"form-control form-control-sm\" value=\"${displayValue}\" style=\"border:1.5px solid #d32f2f;color:#d32f2f;display:inline-block;width:70px;\"><div style=\\\"font-size:0.7em;color:#888;\\">Correct value: <span style=\\\"color:#1976d2;font-weight:bold;\\">${cell.suggest ?? ''}</span></div><button class=\\\"btn btn-sm btn-success\\\" style=\\\"position:absolute;right:2px;top:2px;font-size:0.7em;padding:1px 6px;\\"><i class='fas fa-check'></i></button></td>`;
                                        // Gán lại event handler cho nút tick (dùng setTimeout để đảm bảo DOM đã cập nhật)
                                        setTimeout(function() {
                                            const newTd = allRows[rowIdx].querySelectorAll('td')[sumIdx];
                                            const btn = newTd && newTd.querySelector('button.btn-success');
                                            if (btn) {
                                                btn.onclick = function() {
                                                    saveErrorCell(containerId, rowIdx, sumIdx, btn);
                                                };
                                            }
                                        }, 0);
                                    } else {
                                        tds[sumIdx].outerHTML = `<td>${displayValue}</td>`;
                                    }
                                }
                            });
                        }
                    } else {
                        alert('Update failed: ' + (data.error||''));
                    }
                });
            };
            window.editRow = function(idx) {
                // Save scroll position before re-render
                const container = document.getElementById(containerId);
                lastScrollTop = container.scrollTop;
                lastScrollLeft = container.scrollLeft;
                editingRow = idx;
                renderPage(Math.floor(idx / pageSize) + 1);
            };
            window.cancelEditRow = function() {
                // Save scroll position before re-render
                const container = document.getElementById(containerId);
                lastScrollTop = container.scrollTop;
                lastScrollLeft = container.scrollLeft;
                editingRow = null;
                renderPage(currentPage);
            };
            window.saveEditRow = function(idx) {
                const updates = {};
                if (document.getElementById(`edit_Type_${idx}`)) {
                    updates['Type'] = document.getElementById(`edit_Type_${idx}`).value;
                }
                if (document.getElementById(`edit_Leave_Type_${idx}`)) {
                    updates['Leave Type'] = document.getElementById(`edit_Leave_Type_${idx}`).value;
                }
                if (document.getElementById(`editResults_${idx}`)) {
                    updates['Results'] = document.getElementById(`editResults_${idx}`).value;
                }
                // Gửi từng update
                const updatePromises = Object.entries(updates).map(([col, value]) =>
                    fetch('/update_apply_row', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({index: idx, column: col, value: value})
                    }).then(res => res.json())
                );
                Promise.all(updatePromises).then(results => {
                    let ok = results.every(r => r.success);
                    if (ok) {
                        if ('Type' in updates) rows[idx][columns.indexOf('Type')] = updates['Type'];
                        if ('Leave Type' in updates) rows[idx][columns.indexOf('Leave Type')] = updates['Leave Type'];
                        if ('Results' in updates) rows[idx][columns.indexOf('Results')] = updates['Results'];
                        editingRow = null;
                        renderPage(Math.floor(idx / pageSize) + 1);
                    } else {
                        alert('Update failed!');
                    }
                });
            };
            renderPage(currentPage);
        }
        
        // EMPLOYEE IMPORT FORM HANDLER
        (function() {
            const importForm = document.getElementById('employeeImportForm');
            if(importForm) {
                importForm.onsubmit = function(e) {
                    e.preventDefault();
                    const fileInput = document.getElementById('employeeImportFile');
                    if (!fileInput.files[0]) return alert('Choose a file.');
                    const formData = new FormData();
                    formData.append('file', fileInput.files[0]);
                    fetch('/upload_employee_list', {
                        method: 'POST',
                        body: formData
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message);
                            reloadEmployeeList();
                        } else {
                            alert(data.error);
                        }
                    });
                };
            }
        })();
        // Ensure reloadEmployeeList is defined
        function reloadEmployeeList() {
            fetch('/employee_list')
                .then(res => res.text())
                .then(html => {
                    document.getElementById('employeeListContent').innerHTML = html;
                });
        }
        // EMPLOYEE ADD FORM HANDLER
        (function() {
            const addForm = document.getElementById('addEmployeeForm');
            if(addForm) {
                addForm.onsubmit = function(e) {
                    e.preventDefault();
                    const name = addForm.elements['Name'].value.trim();
                    const idNumber = addForm.elements['ID Number'].value.trim();
                    const dept = addForm.elements['Dept'].value.trim();
                    let internship = addForm.elements['Internship'].value.trim();
                    if (!name || !idNumber) {
                        alert('Name and ID Number are required!');
                        return;
                    }
                    // Convert Internship: Yes -> 'Intern', No/blank -> ''
                    if (internship === 'Yes') internship = 'Intern';
                    else internship = '';
                    fetch('/add_employee', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({Name: name, 'ID Number': idNumber, Dept: dept, Internship: internship})
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            reloadEmployeeList();
                            addForm.reset();
                        } else {
                            alert(data.error);
                        }
                    });
                };
            }
        })();
        function removeEmployee(idx) {
            if (!confirm('Are you sure you want to delete this employee?')) return;
            fetch('/remove_employee', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({index: idx})
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    reloadEmployeeList();
                } else {
                    alert(data.error);
                }
            });
        }

        // RULES TABLE LOGIC
        let rulesTableData = {columns: [], rows: []};
        let rulesTableEdits = {};
        function loadRulesTable() {
            fetch('/get_rules_table')
                .then(res => res.json())
                .then(data => {
                    rulesTableData = data;
                    rulesTableEdits = {};
                    renderRulesTable(data.columns, data.rows);
                });
        }

        function renderRulesTable(columns, rows) {
            let html = '<div class="table-responsive"><table class="table table-bordered special-rules-table"><thead><tr>';
            columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr></thead><tbody>';
            const hyperlinkColumns = [
                "chek in/out screen capture",
                "proof for pre-approval",
                "capture screen (3) check in and check out time",
                "proof about leaders arrange (2) capture screen call/messages",
                "title"
            ];
            function normalizeColName(name) {
                return String(name).trim().toLowerCase();
            }
            rows.forEach((row, idx) => {
                html += '<tr>';
                row.forEach((cell, j) => {
                    const colName = columns[j];
                    const normColName = normalizeColName(colName);
                    // Hyperlink logic for specific columns (case-insensitive, trimmed)
                    if (hyperlinkColumns.includes(normColName)) {
                        const cellStr = String(cell).trim();
                        // If it's a URL, render as link
                        if (cellStr.startsWith('http://') || cellStr.startsWith('https://')) {
                            html += `<td><a href="${cellStr}" target="_blank" rel="noopener noreferrer">${cellStr}</a></td>`;
                        }
                        // If it's a PDF or image filename, link to /uploads/
                        else if (/\.(pdf|jpg|jpeg|png|gif)$/i.test(cellStr)) {
                            html += `<td><a href="/uploads/${encodeURIComponent(cellStr)}" target="_blank" rel="noopener noreferrer">${cellStr}</a></td>`;
                        }
                        else {
                            html += `<td>${cellStr}</td>`;
                        }
                        return;
                    }
                    const colNameLower = normColName;
                    if (
                        colNameLower.includes('date') ||
                        colNameLower === 'holiday date in this year' ||
                        colNameLower === 'special weekend' ||
                        colNameLower === 'special work day'
                    ) {
                        html += `<td style="position:relative;">
                            <input type="text" class="form-control form-control-sm flatpickr-datetime" value="${cell}" onchange="trackRuleEdit(${idx},${j},this.value)">
                            <span class="clear-cell-x" onclick="clearCell(${idx},${j}, this)" title="Clear" style="display:${cell ? 'inline' : 'none'};">&times;</span>
                            <span class="calendar-cell-icon" style="display:${cell ? 'none' : 'inline'};" title="Pick date">
                              <i class='fas fa-calendar-alt'></i>
                            </span>
                        </td>`;
                    } else {
                        html += `<td style="position:relative;" contenteditable="true" oninput="trackRuleEdit(${idx},${j},this.innerText)">
                            ${cell}
                            <span class="clear-cell-x" onclick="clearCell(${idx},${j}, this)" title="Clear">&times;</span>
                        </td>`;
                    }
                });
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            document.getElementById('rulesTableContainer').innerHTML = html;
            // Add class to Special Weekend, Holiday Date in This Year, Special Work Day headers
            setTimeout(function() {
                document.querySelectorAll('.special-rules-table th').forEach(th => {
                    const header = th.textContent.trim();
                    if (
                        header === 'Special Weekend' ||
                        header === 'Holiday Date in This Year' ||
                        header === 'Special Work Day'
                    ) {
                        th.classList.add('special-rules-header-large');
                    }
                });
                // Initialize Flatpickr on all relevant inputs
                document.querySelectorAll('.flatpickr-datetime').forEach(el => {
                    flatpickr(el, {
                        enableTime: true,
                        dateFormat: "Y-m-d H:i",
                        time_24hr: true,
                        allowInput: true
                    });
                    el.addEventListener('input', function() {
                        const td = el.closest('td');
                        const xIcon = td.querySelector('.clear-cell-x');
                        const calIcon = td.querySelector('.calendar-cell-icon');
                        if (el.value) {
                            xIcon.style.display = 'inline';
                            calIcon.style.display = 'none';
                        } else {
                            xIcon.style.display = 'none';
                            calIcon.style.display = 'inline';
                        }
                    });
                    // Trigger once on load
                    el.dispatchEvent(new Event('input'));
                });
            }, 0);
        }

        function trackRuleEdit(rowIdx, colIdx, value) {
            if (!rulesTableEdits[rowIdx]) rulesTableEdits[rowIdx] = {};
            rulesTableEdits[rowIdx][colIdx] = value;
        }

        function saveRulesTable() {
            // Gather all edits and send in one request
            const edits = [];
            for (const row in rulesTableEdits) {
                for (const col in rulesTableEdits[row]) {
                    edits.push({row: parseInt(row), col: parseInt(col), value: rulesTableEdits[row][col]});
                }
            }
            if (edits.length === 0) {
                showAlert('warning', 'No changes to save.');
                return;
            }
            fetch('/batch_update_rule_cells', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({edits: edits})
            }).then(res => res.json()).then(data => {
                if (data.success) {
                    showAlert('success', 'Rules saved successfully!');
                    var saveModal = new bootstrap.Modal(document.getElementById('saveCompletedModal'));
                    saveModal.show();
                    loadRulesTable();
                } else {
                    showAlert('danger', 'Save failed: ' + (data.error || ''));
                }
            });
        }
        
        function deleteRuleRow(idx) {
            fetch('/delete_rule_row', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({row: idx})
            }).then(res => res.json()).then(data => {
                if (data.success) loadRulesTable();
                else alert('Delete failed!');
            });
        }
        
        function addRuleRow() {
            fetch('/add_rule_row', {method: 'POST'})
                .then(res => res.json())
                .then(data => { if (data.success) loadRulesTable(); else alert('Add failed!'); });
        }

        function clearCell(rowIdx, colIdx, el) {
            // Find the input or contenteditable in the same cell and clear it
            const td = el.closest('td');
            const input = td.querySelector('input');
            if (input) {
                input.value = '';
                input.dispatchEvent(new Event('change'));
                // Reset UI: ẩn X, hiện lại icon calendar
                const xIcon = td.querySelector('.clear-cell-x');
                const calIcon = td.querySelector('.calendar-cell-icon');
                if (xIcon) xIcon.style.display = 'none';
                if (calIcon) calIcon.style.display = 'inline';
            } else {
                td.innerText = '';
                trackRuleEdit(rowIdx, colIdx, '');
                // Re-add the X icon after clearing
                td.appendChild(el);
            }
        }

        // Go to Report Tab
        function goToReport() {
            // Check OT Lieu data for error/warning cells
            const otlieu = cachedTables.otlieu && cachedTables.otlieu.data ? cachedTables.otlieu.data : [];
            let hasError = false, hasWarning = false;
            for (let i = 0; i < otlieu.length; i++) {
                for (let j = 0; j < otlieu[i].length; j++) {
                    const cell = otlieu[i][j];
                    if (cell && typeof cell === 'object') {
                        if (cell.error) hasError = true;
                        if (cell.warning) hasWarning = true;
                    }
                }
            }
            if (hasError || hasWarning) {
                let msg = 'Please resolve all highlighted cells in OT Lieu data before proceeding to the report.<br>';
                if (hasError) msg += '- <b>Red cells</b>: Invalid or inconsistent values.<br>';
                if (hasWarning) msg += '- <b>Yellow cells</b>: Invalid or missing time format (should be HH:MM).';
                document.getElementById('otlieuValidationModalBody').innerHTML = msg;
                var otlieuModal = new bootstrap.Modal(document.getElementById('otlieuValidationModal'));
                otlieuModal.show();
                return;
            }
            // Optionally: save/export data before switching tab (call /export to save)
            showLoading(true);
            fetch('/export')
                .then(response => {
                    showLoading(false);
                    if (!response.ok) throw new Error('Failed to save data before report');
                    // Switch to report tab
                    showSection('reportSection');
                })
                .catch(() => {
                    showLoading(false);
                    showAlert('danger', 'Failed to save data before report.');
                });
        }

        // Back to Edit
        if(document.getElementById('backToEditBtn')) {
            document.getElementById('backToEditBtn').onclick = function() {
                showSection('mainSection');
            };
        }
        
        // Review Data
        if(document.getElementById('reviewDataBtn')) {
            document.getElementById('reviewDataBtn').onclick = function() {
                var reviewModal = new bootstrap.Modal(document.getElementById('reviewDataModal'));
                reviewModal.show();
                // Fetch và render dữ liệu từ file tạm vào các tab
                Promise.all([
                    fetch('/get_temp_signinout_data').then(res=>res.json()),
                    fetch('/get_temp_apply_data').then(res=>res.json()),
                    fetch('/get_temp_otlieu_data').then(res=>res.json())
                ]).then(([signinout, apply, otlieu]) => {
                    renderPreviewTable('reviewSigninoutTab', signinout.columns, signinout.data);
                    renderPreviewTable('reviewApplyTab', apply.columns, apply.data);
                    renderPreviewTable('reviewOtlieuTab', otlieu.columns, otlieu.data);
                });
            };
        }
      
        function renderPreviewTable(containerId, columns, rows) {
            const container = document.getElementById(containerId);
            if (!columns || columns.length === 0) {
                container.innerHTML = '<div class="text-muted">No data loaded.</div>';
                return;
            }
            const pageSize = 50;
            let currentPage = 1;
            const totalPages = Math.ceil(rows.length / pageSize);


            function renderPage(page) {
                let html = '<div class="table-responsive"><table class="table table-bordered">';

                // Total Attendance Detail Tab Logic
                if (containerId === 'totalAttendanceDetailTab') {
                    const baseCols = [
                        'No', '14 Digits Employee ID', "Employee's name", 'Group'
                    ];
                    const attendanceCols = [
                        'Normal working days',
                        'Annual leave (100% salary)',
                        'Sick leave (50% salary)',
                        'Unpaid leave (0% salary)',
                        'Welfare leave (100% salary)'
                    ];
                    const violationCols = [
                        'Total',
                        'Late/Leave early (mins)',
                        'Late/Leave early (times)',
                        'Forget scanning',
                        'Violation'
                    ];
                    const remainCols = [
                        'Remark',
                        'Attendance for salary payment'
                    ];

                    html += '<thead><tr>';
                    baseCols.forEach(c => html += `<th rowspan="2">${c}</th>`);
                    html += `<th colspan="5" style="background:#e0f7fa;">Attendance</th>`;
                    html += `<th colspan="5" style="background:#ffeaea;">Violation</th>`;
                    remainCols.forEach(c => html += `<th rowspan="2">${c}</th>`);
                    html += '</tr><tr>';
                    attendanceCols.forEach(c => html += `<th style="background:#e0f7fa;">${c}</th>`);
                    violationCols.forEach(c => html += `<th style="background:#ffeaea;">${c}</th>`);
                    html += '</tr></thead>';
                }
                
                // OT Lieu Report Tab Logic
                else if (containerId === 'otlieuReportTab') {
                    // Xác định nhóm cột
                    const baseCols = ['No', 'Employee ID', 'Employee Name'];
                    const otPayCols = ['OT weekday 150%', 'OT weekday night 200%', 'OT weekly holiday 200%', 'OT weekly holiday night 270%', 'OT public holiday 300%', 'OT public holiday night 390%'];
                    const otLieuCols = ['OT weekday 150% (lieu)', 'OT weekday night 200% (lieu)', 'OT weekly holiday 200% (lieu)', 'OT weekly holiday night 270% (lieu)', 'OT public holiday 300% (lieu)', 'OT public holiday night 390% (lieu)', 'Transferred to normal working hours'];
                    const timeoffCols = ['Date', 'Total used hours in month'];
                    const remainCols = ['Remain unused time off in lieu', 'Total OT paid'];

                    // Header dòng 1
                    html += '<thead><tr>';
                    baseCols.forEach(c => html += `<th rowspan="2">${c}</th>`);
                    html += `<th colspan="6" class="ot-payment-col">OVERTIME (For payment)</th>`;
                    html += `<th colspan="7" class="lieu-col">OVERTIME (No pay, For later time in lieu)</th>`;
                    html += `<th colspan="2" class="timeoff-col">Time off in lieu (hour)</th>`;
                    remainCols.forEach(c => html += `<th rowspan="2">${c}</th>`);
                    html += '</tr><tr>';
                    otPayCols.forEach(c => html += `<th class="ot-payment-col">${c}</th>`);
                    otLieuCols.forEach(c => html += `<th class="lieu-col">${c}</th>`);
                    timeoffCols.forEach(c => html += `<th class="timeoff-col">${c}</th>`);
                    html += '</tr></thead>';
                }
                
                // OT Lieu Before tab logic
                else if (containerId === 'otlieuBeforeTab') {
                    // Xác định nhóm cột
                    // Giả sử: OT Payment là các cột có "OT" hoặc "Payment", Change in Lieu là các cột có "Lieu" hoặc "Change"
                    const otPaymentCols = [];
                    const changeInLieuCols = [];
                    const otherCols = [];
                    columns.forEach((col, idx) => {
                        if (col.startsWith('OT Payment: ')) otPaymentCols.push(idx);
                        else if (col.startsWith('Change in lieu: ')) changeInLieuCols.push(idx);
                        else otherCols.push(idx);
                    });

                    // Header dòng 1
                    html += '<thead><tr>';
                    // Các cột đầu (nếu có)
                    if (otherCols.length > 0) {
                        otherCols.forEach(idx => {
                            html += `<th rowspan="2">${columns[idx]}</th>`;
                        });
                    }
                    if (otPaymentCols.length > 0) {
                        html += `<th colspan="${otPaymentCols.length}" style="background:#b3e0ff;">OT Payment</th>`;
                    }
                    if (changeInLieuCols.length > 0) {
                        html += `<th colspan="${changeInLieuCols.length}" style="background:#fff7b3;">Change in Lieu</th>`;
                    }
                    html += '</tr><tr>';
                    // Dòng 2: tên cột con
                    if (otPaymentCols.length > 0) {
                        otPaymentCols.forEach(idx => {
                            html += `<th style="background:#e3f2fd;">${columns[idx].replace('OT Payment: ', '')}</th>`;
                        });
                    }
                    if (changeInLieuCols.length > 0) {
                        changeInLieuCols.forEach(idx => {
                            html += `<th style="background:#fffde7;">${columns[idx].replace('Change in lieu: ', '')}</th>`;
                        });
                    }
                    html += '</tr></thead>';
                    // Body
                    html += '<tbody>';
                    const start = (page - 1) * pageSize;
                    const end = Math.min(start + pageSize, rows.length);
                    for (let i = start; i < end; i++) {
                        html += '<tr>';
                        // Other cols
                        otherCols.forEach(idx => {
                            let displayValue = (rows[i][idx] && typeof rows[i][idx] === 'object' && 'value' in rows[i][idx]) ? rows[i][idx].value : rows[i][idx];
                            html += `<td>${displayValue}</td>`;
                        });
            // OT Payment
            otPaymentCols.forEach(idx => {
                let displayValue = (rows[i][idx] && typeof rows[i][idx] === 'object' && 'value' in rows[i][idx]) ? rows[i][idx].value : rows[i][idx];
                if (
                    displayValue === '' || displayValue === null || displayValue === undefined ||
                    (typeof displayValue === 'number' && isNaN(displayValue)) ||
                    parseFloat(displayValue) === 0
                ) {
                    displayValue = '-';
                }
                html += `<td>${displayValue}</td>`;
            });
            // Change in Lieu
            changeInLieuCols.forEach(idx => {
                let displayValue = (rows[i][idx] && typeof rows[i][idx] === 'object' && 'value' in rows[i][idx]) ? rows[i][idx].value : rows[i][idx];
                if (
                    displayValue === '' || displayValue === null || displayValue === undefined ||
                    (typeof displayValue === 'number' && isNaN(displayValue)) ||
                    parseFloat(displayValue) === 0
                ) {
                    displayValue = '-';
                }
                html += `<td>${displayValue}</td>`;
            });
                        html += '</tr>';
                    }
                    html += '</tbody></table></div>';
                    html += `<div class='d-flex justify-content-between align-items-center mt-2'>`;
                    html += `<span>Page ${page} of ${totalPages}</span>`;
                    html += `<div>`;
                    html += `<button class='btn btn-sm btn-outline-secondary me-1' ${page === 1 ? 'disabled' : ''} id='${containerId}_prevPageBtn'>Prev</button>`;
                    html += `<button class='btn btn-sm btn-outline-secondary' ${page === totalPages ? 'disabled' : ''} id='${containerId}_nextPageBtn'>Next</button>`;
                    html += `</div></div>`;
                    container.innerHTML = html;
                    document.getElementById(`${containerId}_prevPageBtn`).onclick = function() {
                        if (currentPage > 1) renderPage(currentPage - 1);
                    };
                    document.getElementById(`${containerId}_nextPageBtn`).onclick = function() {
                        if (currentPage < totalPages) renderPage(currentPage + 1);
                    };
                    return; // Dừng ở đây, không render các tab khác
                }


                // Attendance Report Tab Logic
                else if (containerId === 'attendanceReportTab') {
                    // Giả sử columns = ['Department', 'Name', ...30 ngày..., 'Normal', 'Leave', ...]
                    // rows = [ [dep, name, ...30 trạng thái..., tổng hợp...], ... ]
                    // Bạn có thể điều chỉnh lại columns/rows cho phù hợp backend thực tế

                    // Tính số ngày động (giả sử 30 ngày)
                    const dayStartIdx = 2; // sau Department, Name
                    const dayEndIdx = columns.length - 8; // 8 cột tổng hợp cuối
                    const dayCols = columns.slice(dayStartIdx, dayEndIdx);

                    // Header 1
                    html += `<thead><tr>
                        <th rowspan="3" style="position:sticky;left:0;z-index:2;background:#fff;">Department</th>
                        <th rowspan="3" style="position:sticky;left:80px;z-index:2;background:#fff;">Name</th>
                        <th colspan="${dayCols.length}">Date</th>
                        <th rowspan="3" style="background:#388e3c;color:#fff;">Normal<br><span style="font-size:0.8em;">Times</span></th>
                        <th rowspan="3" style="background:#fbc02d;">Leave<br><span style="font-size:0.8em;">Times</span></th>
                        <th rowspan="3" style="background:#b39ddb;">Trip<br><span style="font-size:0.8em;">Times</span></th>
                        <th rowspan="3" style="background:#e57373;">Miss<br><span style="font-size:0.8em;">Times</span></th>
                        <th rowspan="3" style="background:#29b6f6;">Late/Soon<br><span style="font-size:0.8em;">Times</span></th>
                        <th rowspan="3" style="background:#ffd54f;">Lieu<br><span style="font-size:0.8em;">Hours</span></th>
                        <th rowspan="3" style="background:#ffb74d;">OT<br><span style="font-size:0.8em;">Hours</span></th>
                        <th rowspan="3" style="background:#4dd0e1;">Supplement<br><span style="font-size:0.8em;">Times</span></th>
                    </tr><tr>`;

                    // Header 2: thứ trong tuần
                    dayCols.forEach((col, idx) => {
                        // col có thể là "2024-07-20" hoặc "20/07" hoặc số ngày, bạn cần chuyển sang thứ
                        let d = new Date(col); // hoặc parse lại nếu backend trả string ngày
                        let wd = isNaN(d) ? '' : ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()];
                        let color = '';
                        if (wd === 'Sat') color = 'background:#d0f8ce;';
                        if (wd === 'Sun') color = 'background:#ffcdd2;';
                        html += `<th style="text-align:center;${color}">${wd}</th>`;
                    });
                    html += `</tr><tr>`;
                    // Header 3: ngày số
                    dayCols.forEach((col, idx) => {
                        let d = new Date(col);
                        let color = '';
                        if (d.getDay && d.getDay() === 6) color = 'background:#d0f8ce;';
                        if (d.getDay && d.getDay() === 0) color = 'background:#ffcdd2;';
                        html += `<th style="text-align:center;${color}">${d.getDate ? d.getDate() : col}</th>`;
                    });
                    html += `</tr></thead><tbody>`;

                    // Body: mỗi nhân viên 2 dòng (sáng/chiều)
                    const start = (page - 1) * pageSize;
                    const end = Math.min(start + pageSize, rows.length);
                    for (let i = start; i < end; i++) {
                        let row = rows[i];
                        for (let shift = 0; shift < 2; shift++) {
                            html += `<tr>`;
                            if (shift === 0) {
                                html += `<td rowspan="2" style="position:sticky;left:0;z-index:1;background:#fff;vertical-align:middle;text-align:center;">${row[0]}</td>`;
                                html += `<td rowspan="2" style="position:sticky;left:80px;z-index:1;background:#fff;vertical-align:middle;text-align:center;">${row[1]}</td>`;
                            }
                            for (let d = dayStartIdx; d < dayEndIdx; d++) {
                                let val = row[d] && Array.isArray(row[d]) ? row[d][shift] : '';
                                let cellColor = '';
                                if (val === 'L') cellColor = 'background:#fbc02d;';
                                if (val === 'T') cellColor = 'background:#b39ddb;';
                                if (val === 'M') cellColor = 'background:#e57373;';
                                if (val === 'LS') cellColor = 'background:#29b6f6;';
                                if (val === 'LE') cellColor = 'background:#ffd54f;';
                                if (val === 'OT') cellColor = 'background:#ffb74d;';
                                if (val === 'S') cellColor = 'background:#4dd0e1;';
                                if (val === 'N') cellColor = 'background:#388e3c;color:#fff;';
                                html += `<td style="text-align:center;${cellColor}">${val||''}</td>`;
                            }
                            // Tổng hợp
                            if (shift === 0) {
                                for (let d = dayEndIdx; d < columns.length; d++) {
                                    html += `<td rowspan="2" style="text-align:center;">${row[d]}</td>`;
                                }
                            }
                            html += `</tr>`;
                        }
                    }
                    html += `</tbody></table></div>`;
                    html += `<div class='d-flex justify-content-between align-items-center mt-2'>`;
                    html += `<span>Page ${page} of ${totalPages}</span>`;
                    html += `<div>`;
                    html += `<button class='btn btn-sm btn-outline-secondary me-1' ${page === 1 ? 'disabled' : ''} id='${containerId}_prevPageBtn'>Prev</button>`;
                    html += `<button class='btn btn-sm btn-outline-secondary' ${page === totalPages ? 'disabled' : ''} id='${containerId}_nextPageBtn'>Next</button>`;
                    html += `</div></div>`;
                    container.innerHTML = html;
                    document.getElementById(`${containerId}_prevPageBtn`).onclick = function() {
                        if (currentPage > 1) renderPage(currentPage - 1);
                    };
                    document.getElementById(`${containerId}_nextPageBtn`).onclick = function() {
                        if (currentPage < totalPages) renderPage(currentPage + 1);
                    };
                    return; // Dừng ở đây, không render các tab khác
                }

                else {
                    html += '<thead><tr>';
                    columns.forEach(col => html += `<th>${col}</th>`);
                    html += '</tr></thead>';
                }
                
                html += '<tbody>';
                const start = (page - 1) * pageSize;
                const end = Math.min(start + pageSize, rows.length);
                for (let i = start; i < end; i++) {
                    html += '<tr>';
                    let row = rows[i];
                    for (let j = 0; j < columns.length; j++) {
                        let displayValue = (row[j] && typeof row[j] === 'object' && 'value' in row[j]) ? row[j].value : row[j];
                        html += `<td>${displayValue}</td>`;
                    }
                    html += '</tr>';
                }
                html += '</tbody></table></div>';
                html += `<div class='d-flex justify-content-between align-items-center mt-2'>`;
                html += `<span>Page ${page} of ${totalPages}</span>`;
                html += `<div>`;
                html += `<button class='btn btn-sm btn-outline-secondary me-1' ${page === 1 ? 'disabled' : ''} id='${containerId}_prevPageBtn'>Prev</button>`;
                html += `<button class='btn btn-sm btn-outline-secondary' ${page === totalPages ? 'disabled' : ''} id='${containerId}_nextPageBtn'>Next</button>`;
                html += `</div></div>`;
                container.innerHTML = html;
                document.getElementById(`${containerId}_prevPageBtn`).onclick = function() {
                    if (currentPage > 1) renderPage(currentPage - 1);
                };
                document.getElementById(`${containerId}_nextPageBtn`).onclick = function() {
                    if (currentPage < totalPages) renderPage(currentPage + 1);
                };
            }
            renderPage(currentPage);
        }

        // Lieu Followup modal logic
        if(document.getElementById('lieuFollowupBtn')) {
            document.getElementById('lieuFollowupBtn').onclick = function() {
                var modal = new bootstrap.Modal(document.getElementById('lieuFollowupModal'));
                loadLieuFollowupTable();
                modal.show();
            };
        }
        function loadLieuFollowupTable() {
            fetch('/get_lieu_followup').then(res=>res.json()).then(data => {
                renderLieuFollowupTable(data.columns, data.data);
            });
        }
        function renderLieuFollowupTable(columns, rows) {
            const container = document.getElementById('lieuFollowupTableContainer');
            if (!columns || columns.length === 0) {
                container.innerHTML = '<div class="text-muted">No data loaded.</div>';
                return;
            }
            let html = '<div class="table-responsive"><table class="table table-bordered"><thead><tr>';
            columns.forEach(col => html += `<th>${col}</th>`);
            html += '<th>Action</th></tr></thead><tbody>';
            rows.forEach((row, idx) => {
                html += '<tr>';
                row.forEach((cell, j) => {
                    if (columns[j] === 'Lieu remain previous month') {
                        html += `<td><input type="number" class="form-control form-control-sm" value="${cell}" onchange="updateLieuFollowupRow(${idx},'${columns[j]}',this.value)"></td>`;
                    } else if (columns[j] === 'Name') {
                        html += `<td><input type="text" class="form-control form-control-sm" value="${cell}" onchange="updateLieuFollowupRow(${idx},'${columns[j]}',this.value)"></td>`;
                    } else {
                        html += `<td>${cell}</td>`;
                    }
                });
                html += `<td><button class='btn btn-sm btn-danger' onclick='deleteLieuFollowupRow(${idx})'>Delete</button></td>`;
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }
        function updateLieuFollowupRow(idx, col, value) {
            fetch('/update_lieu_followup_row', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({index: idx, column: col, value: value})
            }).then(res => res.json()).then(data => {
                if (!data.success) alert(data.error||'Update failed!');
            });
        }
        function deleteLieuFollowupRow(idx) {
            if (!confirm('Delete this row?')) return;
            fetch('/delete_lieu_followup_row', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({index: idx})
            }).then(res => res.json()).then(data => {
                if (data.success) loadLieuFollowupTable();
                else alert(data.error||'Delete failed!');
            });
        }
        document.getElementById('lieuFollowupImportBtn').onclick = function() {
            const fileInput = document.getElementById('lieuFollowupImportFile');
            if (!fileInput.files[0]) return alert('Choose a file.');
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            fetch('/import_lieu_followup', {
                method: 'POST',
                body: formData
            }).then(res => res.json()).then(data => {
                if (data.success) loadLieuFollowupTable();
                else alert(data.error||'Import failed!');
            });
        };
        document.getElementById('lieuFollowupAddBtn').onclick = function() {
            const name = prompt('Employee name?');
            if (!name) return;
            const remain = prompt('Lieu remain previous month?', '0');
            fetch('/add_lieu_followup_row', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({Name: name, 'Lieu remain previous month': remain})
            }).then(res => res.json()).then(data => {
                if (data.success) loadLieuFollowupTable();
                else alert(data.error||'Add failed!');
            });
        };

        // OT Lieu Before tab logic
        function loadOtlieuBeforeTab() {
            const container = document.getElementById('otlieuBeforeTab');
            container.innerHTML = '<div class="text-muted">Loading...</div>';
            fetch('/get_otlieu_before').then(res=>res.json()).then(data => {
                renderPreviewTable('otlieuBeforeTab', data.columns, data.data);
            });
        }
        // Gọi khi chuyển tab OT Lieu Before
        if(document.getElementById('nav-otlieu-before')) {
            document.getElementById('nav-otlieu-before').addEventListener('shown.bs.tab', loadOtlieuBeforeTab);
        }

        // Chặn chuyển sang tab Report nếu thiếu dữ liệu
        if(document.getElementById('navReport')) {
            document.getElementById('navReport').onclick = function(e) {
                // Kiểm tra cachedTables đã có dữ liệu chưa
                if (!cachedTables.signinout || !cachedTables.signinout.data || cachedTables.signinout.data.length === 0 ||
                    !cachedTables.apply || !cachedTables.apply.data || cachedTables.apply.data.length === 0 ||
                    !cachedTables.otlieu || !cachedTables.otlieu.data || cachedTables.otlieu.data.length === 0) {
                    e.preventDefault();
                    var modal = new bootstrap.Modal(document.getElementById('missingDataModal'));
                    modal.show();
                    return false;
                }
                // Nếu đủ dữ liệu thì cho chuyển tab
                showSection('reportSection');
            };
        }

        // OT Lieu Report tab logic
        function loadOtlieuReportTab() {
            const container = document.getElementById('otlieuReportTab');
            container.innerHTML = '<div class="text-muted">Loading...</div>';
            fetch('/get_otlieu_report').then(res=>res.json()).then(data => {
                renderPreviewTable('otlieuReportTab', data.columns, data.data);
            });
        }
        if(document.getElementById('nav-otlieu-report')) {
            document.getElementById('nav-otlieu-report').addEventListener('shown.bs.tab', loadOtlieuReportTab);
        }

        // Total Attendance Detail tab logic
        function loadTotalAttendanceDetailTab() {
            const container = document.getElementById('totalAttendanceDetailTab');
            container.innerHTML = '<div class="text-muted">Loading...</div>';
            fetch('/get_total_attendance_detail').then(res=>res.json()).then(data => {
                renderPreviewTable('totalAttendanceDetailTab', data.columns, data.data);
            });
        }
        if(document.getElementById('nav-total-attendance')) {
            document.getElementById('nav-total-attendance').addEventListener('shown.bs.tab',loadTotalAttendanceDetailTab)
        }

        // Attendance Report Tab Logic
        function loadAttendanceReportTab() {
            const monthSel = document.getElementById('attendanceMonth');
            const yearSel = document.getElementById('attendanceYear');
            if (monthSel && monthSel.options.length === 0) {
                for (let m = 1; m <= 12; m++) {
                    monthSel.innerHTML += `<option value="${m}">${m}</option>`;
                }
                const now = new Date();
                for (let y = now.getFullYear() - 1; y <= now.getFullYear() + 1; y++) {
                    yearSel.innerHTML += `<option value="${y}">${y}</option>`;
                }
                monthSel.value = now.getMonth() + 1;
                yearSel.value = now.getFullYear();
            }
            monthSel.onchange = loadAttendanceReportTable;
            yearSel.onchange = loadAttendanceReportTable;
            loadAttendanceReportTable();
        }

        function loadAttendanceReportTable() {
            const month = document.getElementById('attendanceMonth').value;
            const year = document.getElementById('attendanceYear').value;
            fetch(`/get_attendance_report?month=${month}&year=${year}`)
                .then(res => res.json())
                .then(data => {
                    renderPreviewTable('attendanceReportTab', data.columns, data.rows);
                });
        }

        if(document.getElementById('nav-attendance-report')) {
            document.getElementById('nav-attendance-report').addEventListener('shown.bs.tab', loadAttendanceReportTab)
        }

    </script>
</body>
</html> 