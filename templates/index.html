<!DOCTYPE html>
<html lang="en">
<head> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Report System</title>
    
    <!-- Favicon and Browser Tab Icons -->
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='icon.svg') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="shortcut icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='favicon.png') }}">
    
    <!-- Meta tags for better browser tab experience -->
    <meta name="description" content="Modern Attendance Report System - Import, process, and export attendance data with beautiful interface">
    <meta name="keywords" content="attendance, report, system, employee, management">
    <meta name="author" content="Attendance Report System">
    <meta name="theme-color" content="#4195F4">
    
    <!-- Open Graph tags for social sharing -->
    <meta property="og:title" content="Attendance Report System">
    <meta property="og:description" content="Modern Attendance Report System - Import, process, and export attendance data">
    <meta property="og:type" content="website">
    <meta property="og:url" content="">
    <meta property="og:image" content="{{ url_for('static', filename='favicon.ico') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        :root {
            --color-water: #CCF8FE;
            --color-winter-wizard: #99E1F9;
            --color-maya-blue: #6AC3F4;
            --color-brilliant-azure: #4195F4;
            --color-sapphire: #1054BE;
            --color-bg: #f6f7fa;
            --color-card: #fff;
            --color-border: #e0e3ea;
            --color-accent: #4195F4;
            --color-danger: #f47c7c;
            --color-success: #3bb273;
            --color-text: #222;
            --color-muted: #888;
        }
        html {
            font-size: 12.2px; /* Increased by +1px */
        }
        body {
            background: var(--color-bg);
            min-height: 100vh;
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--color-text);
        }
        .main-container {
            background: var(--color-card);
            border-radius: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            margin: 16px auto;
            padding: 19px;
            max-width: 1100px;
            border: 1px solid var(--color-border);
        }
        .header {
            text-align: center;
            margin-bottom: 19px;
            color: #111;
            font-weight: bold;
            font-size: 2.1rem; /* Increased by +1px equivalent */
        }
        .upload-section {
            background: var(--color-card);
            border-radius: 10px;
            padding: 10px 10px 8px 10px;
            margin-bottom: 10px;
            border: 1.5px solid var(--color-border);
            transition: box-shadow 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.03);
        }
        .upload-section:hover {
            border-color: var(--color-accent);
            box-shadow: 0 2px 8px rgba(65, 149, 244, 0.08);
        }
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }
        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        .upload-btn {
            background: var(--color-accent);
            border: none;
            color: #fff;
            padding: 5px 14px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem; /* Increased by +1px equivalent */
            transition: background 0.2s;
        }
        .upload-btn:hover {
            background: #1054BE;
        }
        .action-buttons {
            margin: 10px 0 6px 0;
        }
        .btn-action {
            margin: 2px;
            border-radius: 7px;
            font-weight: 600;
            font-size: 0.79rem; /* Increased by +1px equivalent */
            padding: 4px 10px;
            transition: background 0.15s, color 0.15s;
            border: none;
        }
        .btn-refresh {
            background: var(--color-accent);
            color: #fff;
        }
        .btn-calculate {
            background: #e0e3ea;
            color: #222;
        }
        
        /* Attendance Report Table Styling - Complete Reset */
        #attendanceReportTab .table-responsive {
            overflow-x: auto;
        }
        
        #attendanceReportTab .table-responsive table {
            table-layout: fixed !important;
            width: auto !important;
            min-width: 100% !important;
        }
        
        /* Scale columns by name using data attributes */
        #attendanceReportTab .table-responsive th[data-col="Department"],
        #attendanceReportTab .table-responsive td[data-col="Department"] {
            width: 60px !important;
            min-width: 60px !important;
            max-width: 60px !important;
            white-space: nowrap !important;
        }
        
        #attendanceReportTab .table-responsive th[data-col="Name"],
        #attendanceReportTab .table-responsive td[data-col="Name"] {
            width: 160px !important;
            min-width: 160px !important;
            max-width: 160px !important;
            padding: 4px !important;
            white-space: nowrap !important;
        }
        
        /* Date columns - all columns that are dates (YYYY-MM-DD format) */
        #attendanceReportTab .table-responsive th[data-col^="20"],
        #attendanceReportTab .table-responsive td[data-col^="20"] {
            width: 35px !important;
            min-width: 35px !important;
            max-width: 35px !important;
            font-size: 10px !important;
            padding: 2px !important;
            text-align: center !important;
            white-space: nowrap !important;
        }
        
        /* Summary columns by name */
        #attendanceReportTab .table-responsive th[data-col="Normal"],
        #attendanceReportTab .table-responsive td[data-col="Normal"],
        #attendanceReportTab .table-responsive th[data-col="Leave"],
        #attendanceReportTab .table-responsive td[data-col="Leave"],
        #attendanceReportTab .table-responsive th[data-col="Trip"],
        #attendanceReportTab .table-responsive td[data-col="Trip"],
        #attendanceReportTab .table-responsive th[data-col="Miss"],
        #attendanceReportTab .table-responsive td[data-col="Miss"],
        #attendanceReportTab .table-responsive th[data-col="Late/Soon"],
        #attendanceReportTab .table-responsive td[data-col="Late/Soon"],
        #attendanceReportTab .table-responsive th[data-col="Lieu"],
        #attendanceReportTab .table-responsive td[data-col="Lieu"],
        #attendanceReportTab .table-responsive th[data-col="OT"],
        #attendanceReportTab .table-responsive td[data-col="OT"],
        #attendanceReportTab .table-responsive th[data-col="Supplement"],
        #attendanceReportTab .table-responsive td[data-col="Supplement"] {
            width: 60px !important;
            min-width: 60px !important;
            max-width: 60px !important;
            font-size: 10px !important;
            padding: 4px !important;
            text-align: center !important;
            white-space: nowrap !important;
        }
        
        #attendanceReportTab .table-responsive tbody tr {
            height: 25px !important;
            min-height: 25px !important;
            line-height: 25px !important;
        }
        
        #attendanceReportTab .table-responsive tbody td {
            height: 25px !important;
            min-height: 25px !important;
            vertical-align: middle !important;
            padding: 4px 2px !important;
            font-size: 10px !important;
            line-height: 1.2 !important;
        }
        
        /* ƒê·∫£m b·∫£o c√°c √¥ header c√≥ chi·ªÅu cao ƒë·ªìng ƒë·ªÅu */
        #attendanceReportTab .table-responsive thead th {
            height: 25px !important;
            min-height: 25px !important;
            vertical-align: middle !important;
            padding: 8px 2px !important;
        }
        
        
        #attendanceReportTab .table-responsive tbody tr:nth-child(4n+3),
        #attendanceReportTab .table-responsive tbody tr:nth-child(4n+4) {
            background-color: #f8f9fa !important;
        }
        .btn-clear {
            background: var(--color-danger);
            color: #fff;
        }
        .btn-export {
            background: #08a045;
            color: #fff;
        }
        .btn-action:hover {
            background: #333;
            color: #fff;
        }
        .status-card {
            background: var(--color-card);
            color: #222;
            border-radius: 10px;
            padding: 8px 0;
            margin: 10px 0;
            text-align: center;
            border: 1px solid var(--color-border);
        }
        .status-number {
            font-size: 0.92rem;
            font-weight: 700;
            margin: 4px 0;
            color: #111;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 10px;
        }
        .spinner-border {
            width: 1.3rem;
            height: 1.3rem;
        }
        .alert {
            border-radius: 8px;
            border: none;
            margin: 6px 0;
            font-size: 0.7rem;
        }
        .alert-success {
            background: #eafaf1;
            color: var(--color-success);
        }
        .alert-danger {
            background: #fff0f0;
            color: var(--color-danger);
        }
        .table-container {
            background: var(--color-card);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.03);
            margin-top: 10px;
            border: 1px solid var(--color-border);
        }
        .table {
            margin-bottom: 0;
            font-size: 0.7rem;
        }
        .table th {
            background: #f6f7fa;
            color: #222;
            border: none;
            font-weight: 600;
            text-align: center;
            padding: 6px 4px;
        }
        .table td {
            border: 1px solid var(--color-border);
            padding: 4px 3px;
            vertical-align: middle;
        }
        .data-type-label {
            font-weight: 600;
            color: #222;
            margin-bottom: 4px;
            font-size: 0.8rem;
        }
        .badge.bg-danger {
            background: var(--color-danger) !important;
            color: #fff;
        }
        .badge.bg-warning {
            background: #ffe066 !important;
            color: #222;
        }

        .flatpickr-calendar {
            font-size: 0.9em !important;
            min-width: 0 !important;
            padding: 4px 6px !important;
            width: 345px !important;
            max-width: 100% !important;
        }
        .flatpickr-calendar .flatpickr-days,
        .flatpickr-calendar .flatpickr-months,
        .flatpickr-calendar .flatpickr-weekdays,
        .flatpickr-calendar .flatpickr-time {
            font-size: 0.9em !important;
        }
        .flatpickr-calendar .flatpickr-day {
            padding: 1px 0 !important;
            min-width: 20px !important;
            height: 20px !important;
            line-height: 20px !important;
        }
        /* Optional: Adjust input font size for consistency */
        input.flatpickr-datetime {
            font-size: 1.2em;
            padding: 2px 6px;
        }
        /* Add this CSS to style the special rules table columns smaller */
        .special-rules-table th, .special-rules-table td {
            max-width: 150px;
            width: 90px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-left: 2px;
            padding-right: 2px;
        }
        /* Style for Special Weekend header font size */
        .special-rules-table th.special-weekend-header {
            font-size: 1.2em;
        }
        /* Style for large font size on special rules headers */
        .special-rules-table th.special-rules-header-large {
            font-size: 1.2em;
        }
        
        /* X icon for clearing cell */
        .clear-cell-x {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            color: #d32f2f;
            font-size: 1.1em;
            cursor: pointer;
            z-index: 2;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .clear-cell-x:hover {
            opacity: 1;
        }
        .special-rules-table td {
            position: relative;
        }
        .calendar-cell-icon {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
            font-size: 1.1em;
            cursor: pointer;
            z-index: 2;
            opacity: 0.7;
            transition: opacity 0.2s;
            display: inline-block;
        }
        .calendar-cell-icon:hover {
            opacity: 1;
        }
        .table th, .table td {
            min-width: 70px;
            max-width: 140px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Cho ph√©p ti√™u ƒë·ªÅ xu·ªëng h√†ng */
        .table th {
            white-space: normal !important;
            word-wrap: break-word;
            word-break: break-word;
            line-height: 1.2;
            vertical-align: middle;
            padding: 6px 4px;
        }
        /* Lo·∫°i b·ªè ellipsis cho c√°c c·ªôt ƒë·∫∑c bi·ªát, cho ph√©p xu·ªëng d√≤ng */
        .table th.special-multiline, .table td.special-multiline {
            white-space: normal !important;
            overflow: visible !important;
            text-overflow: initial !important;
            max-width: 250px;
        }
        /* Employee List STT column nh·ªè v√† cƒÉn gi·ªØa */
        #employeeListContent table th:first-child, #employeeListContent table td:first-child {
            min-width: 40px;
            max-width: 50px;
            width: 45px;
            text-align: center;
        }
        /* Special Rules Table: thu nh·ªè v√† cƒÉn gi·ªØa c√°c c·ªôt */
        .special-rules-table th, .special-rules-table td {
            min-width: 100px;
            max-width: 150px;
            width: 120px;
            text-align: center;
        }
        /* Special Rules Table: thu nh·ªè v√† cƒÉn gi·ªØa c√°c c·ªôt, ∆∞u ti√™n cao */
        #rulesTableContainer .special-rules-table th,
        #rulesTableContainer .special-rules-table td {
            min-width: 90px !important;
            max-width: 140px !important;
            width: 110px !important;
            text-align: center !important;
            vertical-align: middle !important;
        }
        #rulesTableContainer .special-rules-table input.form-control {
            text-align: center !important;
        }
        #lieuFollowupTableContainer table th:first-child, #lieuFollowupTableContainer table td:first-child {
            min-width: 40px;
            max-width: 50px;
            width: 45px;
            text-align: center;
        }
        /* OT Lieu Before: m√†u n·ªÅn cho c√°c nh√≥m c·ªôt */
        .ot-payment-col {
            background: #b3e0ff !important;
        }
        .lieu-col {
            background: #fff7b3 !important;
        }
        .timeoff-col {
            background: #b6e7b0 !important;
        }
        #otlieuReportTab table th:first-child,
        #otlieuReportTab table td:first-child {
            min-width: 40px;
            max-width: 50px;
            width: 45px;
            text-align: center;
            vertical-align: middle;
            padding-left: 0;
            padding-right: 0;
        }
        #totalAttendanceDetailTab table th:first-child,
        #totalAttendanceDetailTab table td:first-child {
            min-width: 40px;
            max-width: 50px;
            width: 45px;
            text-align: center;
            vertical-align: middle;
            padding-left: 0;
            padding-right: 0;
        }
        
        /* Multi-file import styles */
        .file-list-container {
            max-height: 120px;
            overflow-y: auto;
            border: 1px solid #e0e3ea;
            border-radius: 6px;
            padding: 8px;
            background: #f8f9fa;
            margin-top: 8px;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4px 8px;
            margin: 2px 0;
            background: white;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            font-size: 0.75rem;
        }
        
        .file-item:hover {
            background: #f8f9fa;
        }
        
        .file-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 8px;
        }
        
        .file-remove-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8rem;
            transition: background-color 0.2s;
        }
        
        .file-remove-btn:hover {
            background-color: #dc3545;
            color: white;
        }
        
        .file-upload-btn {
            background: var(--color-accent);
            border: none;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-top: 8px;
            transition: background 0.2s;
        }
        
        .file-upload-btn:hover {
            background: #1054BE;
        }
        
        .file-upload-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        /* Employee List Filter Styles */
        .filter-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .filter-section:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .filter-section h6 {
            color: #495057;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .filter-section .form-label {
            font-weight: 500;
            color: #6c757d;
        }
        
        .filter-section .form-control,
        .filter-section .form-select {
            border: 1px solid #ced4da;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        
        .filter-section .form-control:focus,
        .filter-section .form-select:focus {
            border-color: #4195F4;
            box-shadow: 0 0 0 0.2rem rgba(65, 149, 244, 0.25);
        }
        
        .alert-sm {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 0.375rem;
        }
        
        /* Edit Mode Styles */
        .edit-mode-active {
            background-color: #f8f9fa !important;
            border: 1px solid #dee2e6 !important;
        }
        
        .edit-indicator {
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        
        .edit-indicator:hover {
            opacity: 1;
        }
        
        .table input.form-control-sm {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }
        
        .table input.form-control-sm:focus {
            border-color: #4195F4;
            box-shadow: 0 0 0 0.2rem rgba(65, 149, 244, 0.25);
        }
        
        /* Hover Delete Button Styles */
        .hover-delete-btn {
            opacity: 0;
            transition: opacity 0.2s ease;
            background: none;
            border: none;
            color: #6c757d;
            font-size: 1.05rem; /* Increased by +1px equivalent */
            cursor: pointer;
            padding: 1px 3px;
            border-radius: 2px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .hover-delete-btn:hover {
            background-color: #dc3545;
            color: white;
        }
        
        tr:hover .hover-delete-btn {
            opacity: 1;
        }
        
        /* Employee List Table Column Widths */
        .employee-table th:nth-child(1), .employee-table td:nth-child(1) {
            width: 60px; /* STT */
            min-width: 60px;
            max-width: 60px;
        }
        
        .employee-table th:nth-child(2), .employee-table td:nth-child(2) {
            width: 200px; /* Name */
            min-width: 150px;
            max-width: 250px;
        }
        
        .employee-table th:nth-child(3), .employee-table td:nth-child(3) {
            width: 120px; /* ID Number */
            min-width: 100px;
            max-width: 140px;
        }
        
        .employee-table th:nth-child(4), .employee-table td:nth-child(4) {
            width: 100px; /* Dept */
            min-width: 80px;
            max-width: 120px;
        }
        
        .employee-table th:nth-child(5), .employee-table td:nth-child(5) {
            width: 100px; /* Internship */
            min-width: 80px;
            max-width: 120px;
        }
        
        .employee-table th:nth-child(6), .employee-table td:nth-child(6) {
            width: 30px; /* Delete button column */
            min-width: 30px;
            max-width: 30px;
            text-align: center;
            padding: 0.25rem 0.1rem;
        }
        
        .employee-table {
            table-layout: fixed;
            width: 100%;
        }
        
        .employee-table td {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0.5rem 0.25rem;
        }
        
        .employee-table th {
            padding: 0.5rem 0.25rem;
            font-size: 0.925rem; /* Increased by +1px equivalent */
        }
        
        /* Report Loading Screen */
        .report-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            border: 1px solid #e0e3ea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .report-loading .spinner-border {
            width: 3rem;
            height: 3rem;
            margin-bottom: 1.5rem;
            color: var(--color-accent);
        }
        
        .report-loading .loading-text {
            font-size: 1.2rem;
            color: #495057;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .report-loading .loading-subtext {
            font-size: 0.95rem;
            color: #6c757d;
            text-align: center;
            max-width: 300px;
        }
        
        .report-loading .loading-progress {
            width: 200px;
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            margin-top: 1rem;
            overflow: hidden;
        }
        
        .report-loading .loading-progress-bar {
            height: 100%;
            background: var(--color-accent);
            border-radius: 2px;
            transition: width 0.3s ease;
            animation: loading-pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes loading-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body>
    <!-- Permanent Top Navigation Bar -->
    <nav class="navbar navbar-light bg-white border-bottom mb-3 px-3" style="border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.03);">
        <span class="navbar-brand mb-0 h1" style="font-size:1.2rem;font-weight:bold;">Attendance Report System</span>
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-outline-dark btn-sm nav-tab" id="navRules" onclick="showSection('rulesSection')">Rules</button>
            <button class="btn btn-outline-dark btn-sm nav-tab" id="navEmployeeList" onclick="showSection('employeeListSection')">Employee List</button>
            <button class="btn btn-outline-primary btn-sm nav-tab" id="navMain" onclick="showSection('mainSection')">Data</button>
            <button class="btn btn-outline-secondary btn-sm nav-tab" id="navReport" onclick="showSection('reportSection')">Report</button>
        </div>
    </nav>
    <div class="container-fluid">
        <div class="main-container">
            <div class="header">
                <h1><strong>Attendance Report System</strong></h1>
                <!-- Dropdown ch·ªçn th√°ng/nƒÉm cho Attendance Report -->
                <div id="attendanceMonthYearContainer" style="display:none; justify-content:center; align-items:center; gap:10px; margin-top:10px;">
                    <label for="attendanceMonth" class="form-label mb-0">Month:</label>
                    <select id="attendanceMonth" class="form-select form-select-sm" style="width:80px;"></select>
                    <label for="attendanceYear" class="form-label mb-0">Year:</label>
                    <select id="attendanceYear" class="form-select form-select-sm" style="width:90px;"></select>
                </div>
            </div>
            <div id="alertContainer"></div>
            <div id="loading" class="loading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Processing...</p>
            </div>

            <!-- Employee List Section -->
            <div id="employeeListSection" style="display:none;">
                <div class="mb-3 d-flex flex-wrap gap-2 align-items-center">
                    <form id="employeeImportForm" enctype="multipart/form-data" class="d-flex gap-2 align-items-center">
                        <input type="file" id="employeeImportFile" name="file" accept=".xlsx,.xls,.csv" class="form-control form-control-sm" style="max-width:220px;">
                        <button type="submit" class="btn btn-sm btn-primary"><i class="fas fa-upload"></i> Import</button>
                    </form>
                    <form id="addEmployeeForm" class="d-flex gap-1 flex-wrap align-items-center">
                        <input type="text" name="Name" placeholder="Name" class="form-control form-control-sm" style="width:120px;">
                        <input type="text" name="ID Number" placeholder="ID Number" class="form-control form-control-sm" style="width:110px;">
                        <select name="Dept" class="form-control form-control-sm" style="width:90px;">
                            <option value="">Dept</option>
                            <option value="Admin">Admin</option>
                            <option value="E&S">E&amp;S</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Sales">Sales</option>
                            <option value="Support">Support</option>
                            <option value="Terminal">Terminal</option>
                        </select>
                        <select name="Internship" class="form-control form-control-sm" style="width:110px;">
                            <option value="">Internship</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                        <button type="submit" class="btn btn-sm btn-success"><i class="fas fa-plus"></i> Add</button>
                    </form>
                </div>
                <!-- Filter Section -->
                <div class="mb-3 p-3 filter-section">
                    <h6 class="mb-2"><i class="fas fa-filter"></i> Filter Options</h6>
                    <div class="d-flex flex-wrap gap-3 align-items-end">
                        <div>
                            <label for="filterDept" class="form-label small mb-1">Department:</label>
                            <select id="filterDept" class="form-select form-select-sm" style="width:120px;">
                                <option value="">All Departments</option>
                                <option value="Admin">Admin</option>
                                <option value="E&S">E&S</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Sales">Sales</option>
                                <option value="Support">Support</option>
                                <option value="Terminal">Terminal</option>
                            </select>
                        </div>
                        <div>
                            <label for="filterIntern" class="form-label small mb-1">Intern:</label>
                            <select id="filterIntern" class="form-select form-select-sm" style="width:100px;">
                                <option value="">All</option>
                                <option value="Intern">Intern</option>
                                <option value="Regular">Regular</option>
                            </select>
                        </div>
                        <div>
                            <button type="button" class="btn btn-sm btn-primary" onclick="applyEmployeeFilter()">
                                <i class="fas fa-search"></i> Apply Filter
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-1" onclick="clearEmployeeFilter()">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>
                    </div>
                </div>
                <div id="employeeListContent"></div>
            </div>

            <!-- Main Section -->
            <div id="mainSection" style="display:none;">
                <!-- Data Import Section -->
                <div id="importSection">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="upload-section position-relative" id="signinoutCard">
                                <div class="data-type-label">
                                    <i class="fas fa-sign-in-alt"></i> Sign In/Out Data
                                </div>
                                <div class="file-input-wrapper">
                                    <input type="file" id="signinoutFile" class="file-input" accept=".xlsx,.xls,.csv" multiple>
                                    <button class="btn upload-btn" onclick="document.getElementById('signinoutFile').click()">
                                        <i class="fas fa-upload"></i> Choose Files
                                    </button>
                                </div>
                                <div id="signinoutFileList" class="mt-2"></div>
                                <div id="signinoutStatus" class="mt-2 text-muted"></div>
                                <button type="button" class="btn btn-link btn-sm position-absolute top-0 end-0 m-2 p-0 d-none" id="clearSigninoutBtn" title="Clear Sign In/Out" onclick="clearData('signinout')">
                                    <span style="font-size:1.3rem;color:#f47c7c;">&times;</span>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="upload-section position-relative" id="applyCard">
                                <div class="data-type-label">
                                    <i class="fas fa-file-alt"></i> Apply Data
                                </div>
                                <div class="file-input-wrapper">
                                    <input type="file" id="applyFile" class="file-input" accept=".xlsx,.xls,.csv" multiple>
                                    <button class="btn upload-btn" onclick="document.getElementById('applyFile').click()">
                                        <i class="fas fa-upload"></i> Choose Files
                                    </button>
                                </div>
                                <div id="applyFileList" class="mt-2"></div>
                                <div id="applyStatus" class="mt-2 text-muted"></div>
                                <button type="button" class="btn btn-link btn-sm position-absolute top-0 end-0 m-2 p-0 d-none" id="clearApplyBtn" title="Clear Apply" onclick="clearData('apply')">
                                    <span style="font-size:1.3rem;color:#f47c7c;">&times;</span>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="upload-section position-relative" id="otlieuCard">
                                <div class="data-type-label">
                                    <i class="fas fa-clock"></i> OT Lieu Data
                                </div>
                                <div class="file-input-wrapper">
                                    <input type="file" id="otlieuFile" class="file-input" accept=".xlsx,.xls,.csv" multiple>
                                    <button class="btn upload-btn" onclick="document.getElementById('otlieuFile').click()">
                                        <i class="fas fa-upload"></i> Choose Files
                                    </button>
                                </div>
                                <div id="otlieuFileList" class="mt-2"></div>
                                <div id="otlieuStatus" class="mt-2 text-muted"></div>
                                <button type="button" class="btn btn-link btn-sm position-absolute top-0 end-0 m-2 p-0 d-none" id="clearOtlieuBtn" title="Clear OT Lieu" onclick="clearData('otlieu')">
                                    <span style="font-size:1.3rem;color:#f47c7c;">&times;</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Date Range Filter Section -->
                <div class="mb-3 p-3 filter-section">
                    <h6 class="mb-2"><i class="fas fa-calendar-alt"></i> Calculation Date Range</h6>
                    <div class="d-flex flex-wrap gap-3 align-items-end">
                        <div>
                            <label for="dataStartDate" class="form-label small mb-1">Start Date:</label>
                            <input type="date" id="dataStartDate" class="form-control form-control-sm" style="width:140px;">
                        </div>
                        <div>
                            <label for="dataEndDate" class="form-label small mb-1">End Date:</label>
                            <input type="date" id="dataEndDate" class="form-control form-control-sm" style="width:140px;">
                        </div>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="setDefaultDateRange()">
                                <i class="fas fa-calendar-week"></i> Set Default Range
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-1" onclick="clearDateRange()">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> 
                            Default range: 20th of previous month to 19th of current month
                        </small>
                        <div id="dateRangeStatus" class="mt-1" style="display:none;">
                            <small class="text-info">
                                <i class="fas fa-calendar-check"></i> 
                                <span id="currentDateRange"></span>
                            </small>
                        </div>
                    </div>
                </div>
                <!-- Action Buttons -->
                <div class="action-buttons mt-3 mb-2">
                    <button class="btn btn-action btn-calculate" id="calculateBtn" onclick="calculateMain()">
                        <i class="fas fa-calculator"></i> Calculate
                    </button>
                    <button class="btn btn-action btn-export" id="reportBtn" style="display:none; margin-left:8px;" onclick="goToReport()">
                        <i class="fas fa-chart-bar"></i> Report
                    </button>
                </div>
                <!-- Data Table Tabs and Table -->
                <div id="dataTableSwitcherSection" style="display:none;">
                    <ul class="nav nav-tabs mb-3" id="dataNavTabs">
                        <li class="nav-item">
                            <a class="nav-link active" id="nav-signinout" data-bs-toggle="tab" href="#signinoutTab">Sign In/Out</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="nav-apply" data-bs-toggle="tab" href="#applyTab">Apply</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="nav-otlieu" data-bs-toggle="tab" href="#otlieuTab">OT Lieu</a>
                        </li>
                    </ul>
                    <!-- Edit Controls -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <button class="btn btn-outline-primary btn-sm me-2" id="lieuFollowupBtn">Lieu Followup</button>
                            <button class="btn btn-outline-primary btn-sm me-2" id="editDataBtn" onclick="toggleEditMode()">
                                <i class="fas fa-edit"></i> Edit Mode
                            </button>
                            <button class="btn btn-outline-success btn-sm me-2" id="saveChangesBtn" onclick="saveAllChanges()" style="display:none;">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" id="cancelEditBtn" onclick="cancelEditMode()" style="display:none;">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                    </div>
                        <div>
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> 
                                <span id="editModeInfo">Click "Edit Mode" to enable editing</span>
                            </small>
                        </div>
                    </div>
                    <div class="tab-content" id="dataTabContent">
                        <div class="tab-pane fade show active" id="signinoutTab">
                            <div id="signinoutTableContainer"></div>
                        </div>
                        <div class="tab-pane fade" id="applyTab">
                            <div id="applyTableContainer"></div>
                        </div>
                        <div class="tab-pane fade" id="otlieuTab">
                            <div id="otlieuTableContainer"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Report Section -->
            <div id="reportSection" style="display:none;">
                <!-- Report Loading Screen -->
                <div id="reportLoadingScreen" class="report-loading" style="display:none;">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="loading-text">Loading Reports...</div>
                    <div class="loading-subtext">Please wait while we prepare your data</div>
                    <div class="loading-progress">
                        <div class="loading-progress-bar" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Report Content (hidden initially) -->
                <div id="reportContent" style="display:none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <!-- <div>
                            <button class="btn btn-outline-primary btn-sm me-2" id="lieuFollowupBtn">Lieu Followup</button>
                        </div> -->
                        <div>
                            <button class="btn btn-outline-secondary btn-sm me-2" id="reviewDataBtn"><i class="fas fa-table"></i> Review Data</button>
                            <button class="btn btn-outline-danger btn-sm" id="backToEditBtn"><i class="fas fa-arrow-left"></i> Back to Edit</button>
                            <button class="btn btn-action btn-success btn-sm ms-2" id="exportAttendanceReportBtn" style="background:#43a047;color:#fff;border:none;">
                                <i class="fas fa-file-export"></i> Export
                            </button>
                        </div>
                    </div>
                    <ul class="nav nav-tabs mb-3" id="reportNavTabs">
                        <li class="nav-item">
                            <a class="nav-link active" id="nav-otlieu-before" data-bs-toggle="tab" href="#otlieuBeforeTab">OT Lieu Before</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="nav-otlieu-report" data-bs-toggle="tab" href="#otlieuReportTab">OT Lieu Report</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="nav-total-attendance" data-bs-toggle="tab" href="#totalAttendanceDetailTab">Total Attendance Detail</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="nav-attendance-report" data-bs-toggle="tab" href="#attendanceReportTab">Attendance Report</a>
                        </li>
                    </ul>
                    <div class="tab-content" id="reportTabContent">
                        <div class="tab-pane fade show active" id="otlieuBeforeTab"> <!-- OT Lieu Before content here --> </div>
                        <div class="tab-pane fade" id="otlieuReportTab"> <!-- OT Lieu Report content here --> </div>
                        <div class="tab-pane fade" id="totalAttendanceDetailTab"> <!-- Total Attendance Detail content here --> </div>
                        <div class="tab-pane fade" id="attendanceReportTab"></div>
                    </div>
                </div>
            </div>

            <!-- Rules Section -->
            <div id="rulesSection" style="display:none;">
                <div class="mb-3">
                    <h4>Attendance Rules</h4>
                    <div style="font-family: 'Segoe UI', 'Roboto', Arial, sans-serif; font-size: 1.08rem; color: #222; line-height: 1.45;">
                      <div style="font-weight: bold; font-size: 1.13rem; margin-bottom: 0.3em;">
                        <span style="font-size:1.2em;vertical-align:-2px;">üï∞Ô∏è</span>
                        Beijing Time (GMT+8), Valid for the Current Day:
                      </div>
                      <ul style="margin-bottom: 0.4em; padding-left: 1.2em;">
                        <li>
                          <span style="font-weight: 500;">Normal clock-in time (morning):</span>
                          <span style="color: #1976d2; font-weight: 500;">07:00 ‚Äì 09:30</span>
                          <div style="margin-left:1.2em; color:#555; font-size:0.98em; border-left:3px solid #e0e0e0; padding-left:0.7em; margin-top:0.2em;">
                            Clocking in after <span style="color:#d32f2f;font-weight:500;">13:00</span> is considered <span style="color:#d32f2f;font-weight:500;">morning absence</span>
                          </div>
                        </li>
                        <li style="margin-top:0.5em;">
                          <span style="font-weight: 500;">Normal clock-out time (evening):</span>
                          <span style="color: #1976d2; font-weight: 500;">18:30 ‚Äì 23:59</span>
                          <div style="margin-left:1.2em; color:#555; font-size:0.98em; border-left:3px solid #e0e0e0; padding-left:0.7em; margin-top:0.2em;">
                            Clocking out before <span style="color:#d32f2f;font-weight:500;">14:30</span> is considered <span style="color:#d32f2f;font-weight:500;">afternoon absence</span>
                          </div>
                        </li>
                      </ul>
                      <hr style="margin:1.2em 0 1em 0;">
                      <div style="font-weight: bold; margin-bottom: 0.2em; color:#d32f2f;">
                        <span style="font-size:1.1em;vertical-align:-2px;">üìå</span>
                        Status Definitions:
                      </div>
                      <ul style="margin-bottom: 0.4em; padding-left: 1.2em;">
                        <li>
                          <span style="font-weight: 500;">Late:</span>
                          <span style="color: #d32f2f;">Clock-in time after 09:30</span>
                        </li>
                        <li style="margin-top:0.2em;">
                          <span style="font-weight: 500;">Early leave:</span>
                          <span style="color: #d32f2f;">Clock-out time before 18:30</span>
                        </li>
                        <li style="margin-top:0.2em;">
                          <span style="font-weight: 500;">Absent (No attendance):</span>
                          <span style="color: #d32f2f;">No clock-in or clock-out record for the day</span>
                        </li>
                      </ul>
                      <hr style="margin:1.2em 0 1em 0;">
                      <div style="font-weight: bold; margin-bottom: 0.2em; color:#1976d2;">
                        <span style="font-size:1.1em;vertical-align:-2px;">‚úÖ</span>
                        Valid Exceptions <span style="font-weight: normal; color:#222;">(must be applied and approved the same day)</span>
                      </div>
                      <ul style="padding-left: 1.2em;">
                        <li>
                          <span style="font-weight: 500;">Business trip:</span>
                          <span>Applied between <span style="color: #1976d2;">09:30 ‚Äì 18:30</span>, and approved</span>
                        </li>
                        <li style="margin-top:0.2em;">
                          <span style="font-weight: 500;">Leave request:</span>
                          <span>Applied between <span style="color: #1976d2;">09:30 ‚Äì 18:30</span>, and approved</span>
                        </li>
                        <li style="margin-top:0.2em;">
                          <span style="font-weight: 500;">Supplementary clocking (manual correction):</span>
                          <span>Applied between <span style="color: #1976d2;">09:30 ‚Äì 18:30</span>, and approved</span>
                        </li>
                      </ul>
                    </div>
                </div>
                <hr style="margin:1.2em 0 1em 0;">
                <div class="mb-3">
                    <h4>Special Rules Table</h4>
                    <div id="rulesTableContainer"></div>
                    <button class="btn btn-sm btn-success mt-2" onclick="addRuleRow()"><i class="fas fa-plus"></i> Add Rule</button>
                    <button class="btn btn-sm btn-primary mt-2 ms-2" id="saveRulesBtn" onclick="saveRulesTable()"><i class="fas fa-save"></i> Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for sheet selection and preview -->
    <div class="modal fade" id="sheetPreviewModal" tabindex="-1" aria-labelledby="sheetPreviewModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="sheetPreviewModalLabel">Preview & Select Sheet</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="sheetSelectContainer" class="mb-3" style="display:none;">
              <label for="sheetSelect" class="form-label">Choose a sheet:</label>
              <select id="sheetSelect" class="form-select" style="max-width: 300px;"></select>
            </div>
            <div id="sheetPreviewTableContainer"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="confirmImportBtn">Import</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Save Completed Dialog Modal -->
    <div class="modal fade" id="saveCompletedModal" tabindex="-1" aria-labelledby="saveCompletedModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="saveCompletedModalLabel">Success</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Save completed!
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Time Format Warning Dialog Modal -->
    <div class="modal fade" id="timeFormatWarningModal" tabindex="-1" aria-labelledby="timeFormatWarningModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="timeFormatWarningModalLabel">Import Error!</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Please use the correct format when importing: <b>HH:MM</b>. For example: <b>09:30</b>, <b>17:45</b>, <b>21:00</b>.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
          </div>
        </div>
      </div>
    </div>

    <!-- OT Lieu Validation Modal -->
    <div class="modal fade" id="otlieuValidationModal" tabindex="-1" aria-labelledby="otlieuValidationModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="otlieuValidationModalLabel">Data Error!</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="otlieuValidationModalBody">
            <!-- Message will be injected here -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal for Review Data Preview -->
    <div class="modal fade" id="reviewDataModal" tabindex="-1" aria-labelledby="reviewDataModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="reviewDataModalLabel">Review Data</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <ul class="nav nav-tabs mb-2" id="reviewDataTabs">
              <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#reviewSigninoutTab">Sign In/Out</a></li>
              <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#reviewApplyTab">Apply</a></li>
              <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#reviewOtlieuTab">OT Lieu</a></li>
            </ul>
            <div class="tab-content">
              <div class="tab-pane fade show active" id="reviewSigninoutTab"> <!-- Preview Sign In/Out here --> </div>
              <div class="tab-pane fade" id="reviewApplyTab"> <!-- Preview Apply here --> </div>
              <div class="tab-pane fade" id="reviewOtlieuTab"> <!-- Preview OT Lieu here --> </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal for Lieu Followup -->
    <div class="modal fade" id="lieuFollowupModal" tabindex="-1" aria-labelledby="lieuFollowupModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="lieuFollowupModalLabel">Lieu Followup</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="d-flex mb-2 gap-2">
              <input type="file" id="lieuFollowupImportFile" accept=".xlsx,.xls" class="form-control form-control-sm" style="max-width:220px;">
              <button class="btn btn-sm btn-primary" id="lieuFollowupImportBtn">Import</button>
              <button class="btn btn-sm btn-success" id="lieuFollowupAddBtn">Add</button>
            </div>
            <div id="lieuFollowupTableContainer"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Missing Data Dialog -->
    <div class="modal fade" id="missingDataModal" tabindex="-1" aria-labelledby="missingDataModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="missingDataModalLabel">Missing Data!</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="missingDataModalBody">
            Please import all required data files (Sign In/Out, Apply, OT Lieu) in the Data tab before viewing the report.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let pendingFile = null;
        let pendingDataType = null;
        let previewData = null;
        let selectedSheet = null;
        let sheetNames = null;
        let sheetModal = new bootstrap.Modal(document.getElementById('sheetPreviewModal'));
        let cachedTables = {signinout: null, apply: null, otlieu: null};
        
        // Multi-file import state
        let selectedFiles = {
            signinout: [],
            apply: [],
            otlieu: []
        };

        // Override file upload handlers for multi-file selection
        document.getElementById('signinoutFile').addEventListener('change', function(e) {
            handleMultiFileSelection(e.target.files, 'signinout');
        });
        document.getElementById('applyFile').addEventListener('change', function(e) {
            handleMultiFileSelection(e.target.files, 'apply');
        });
        document.getElementById('otlieuFile').addEventListener('change', function(e) {
            handleMultiFileSelection(e.target.files, 'otlieu');
        });

        function handleMultiFileSelection(files, dataType) {
            if (!files || files.length === 0) return;
            
            // Convert FileList to Array and filter valid files
            const validFiles = Array.from(files).filter(file => 
                file.name.toLowerCase().endsWith('.xlsx') || 
                file.name.toLowerCase().endsWith('.xls') || 
                file.name.toLowerCase().endsWith('.csv')
            );
            
            if (validFiles.length === 0) {
                showAlert('danger', 'No valid files selected. Please select .xlsx, .xls, or .csv files.');
                return;
            }
            
            // Add files to selected files list
            selectedFiles[dataType] = [...selectedFiles[dataType], ...validFiles];
            
            // Update file list display
            updateFileListDisplay(dataType);
            
            // Show upload button
            showUploadButton(dataType);
            
            // Show success message for file selection
            const statusElement = document.getElementById(`${dataType}Status`);
            const hasExistingData = statusElement && statusElement.innerHTML.trim() !== '';
            const appendText = hasExistingData ? ' (will append to existing data)' : '';
            showAlert('success', `${validFiles.length} file(s) selected for ${dataType} data${appendText}`);
        }
        
        function updateFileListDisplay(dataType) {
            const fileListContainer = document.getElementById(`${dataType}FileList`);
            const files = selectedFiles[dataType];
            
            if (files.length === 0) {
                fileListContainer.innerHTML = '';
                return;
            }
            
            let html = '<div class="file-list-container">';
            html += `<div class="text-muted small mb-2">Selected files (${files.length}):</div>`;
            files.forEach((file, index) => {
                const fileSize = (file.size / 1024).toFixed(1); // KB
                html += `
                    <div class="file-item">
                        <div class="d-flex flex-column">
                            <span class="file-name" title="${file.name}">${file.name}</span>
                            <small class="text-muted">${fileSize} KB</small>
                        </div>
                        <button class="file-remove-btn" onclick="removeFileFromList('${dataType}', ${index})" title="Remove file">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            });
            html += '</div>';
            
            fileListContainer.innerHTML = html;
        }
        
        function removeFileFromList(dataType, index) {
            selectedFiles[dataType].splice(index, 1);
            updateFileListDisplay(dataType);
            
            if (selectedFiles[dataType].length === 0) {
                hideUploadButton(dataType);
            } else {
                // Update upload button text
                showUploadButton(dataType);
            }
        }
        
        function showUploadButton(dataType) {
            const fileListContainer = document.getElementById(`${dataType}FileList`);
            const existingButton = fileListContainer.querySelector('.file-upload-btn');
            
            // Check if there's existing data
            const statusElement = document.getElementById(`${dataType}Status`);
            const hasExistingData = statusElement && statusElement.innerHTML.trim() !== '';
            
            if (!existingButton) {
                const uploadBtn = document.createElement('button');
                uploadBtn.className = 'file-upload-btn';
                const fileCount = selectedFiles[dataType].length;
                const appendText = hasExistingData ? ' (Append)' : '';
                uploadBtn.innerHTML = `<i class="fas fa-upload"></i> Import ${fileCount} File${fileCount > 1 ? 's' : ''}${appendText}`;
                uploadBtn.onclick = () => importMultipleFiles(dataType);
                fileListContainer.appendChild(uploadBtn);
            } else {
                // Update existing button text
                const fileCount = selectedFiles[dataType].length;
                const appendText = hasExistingData ? ' (Append)' : '';
                existingButton.innerHTML = `<i class="fas fa-upload"></i> Import ${fileCount} File${fileCount > 1 ? 's' : ''}${appendText}`;
            }
        }
        
        function hideUploadButton(dataType) {
            const fileListContainer = document.getElementById(`${dataType}FileList`);
            const uploadBtn = fileListContainer.querySelector('.file-upload-btn');
            if (uploadBtn) {
                uploadBtn.remove();
            }
            
            // Clear file list display
            updateFileListDisplay(dataType);
        }
        
        function importMultipleFiles(dataType) {
            const files = selectedFiles[dataType];
            if (files.length === 0) return;
            
            showLoading(true);
            showAlert('', '');
            
            const formData = new FormData();
            formData.append('data_type', dataType);
            files.forEach(file => {
                formData.append('files[]', file);
            });
            
            fetch('/import_multiple_files', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                if (data.success) {
                    const message = data.imported_files.length > 1 ? 
                        `${data.message} (Files appended to existing data)` :
                        data.message;
                    showAlert('success', message);
                    updateStatus(dataType, data.total_rows);
                    
                    // Clear selected files
                    selectedFiles[dataType] = [];
                    updateFileListDisplay(dataType);
                    hideUploadButton(dataType);
                    
                    // Reset file input
                    document.getElementById(`${dataType}File`).value = '';
                } else {
                    showAlert('danger', data.error);
                }
            })
            .catch(error => {
                showLoading(false);
                showAlert('danger', 'Error importing files: ' + error.message);
            });
        }
        
        function handleFilePreview(file, dataType) {
            if (!file) return;
            pendingFile = file;
            pendingDataType = dataType;
            showLoading(true);
            showAlert('', '');
            const formData = new FormData();
            formData.append('file', file);
            fetch('/preview_upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                if (data.success) {
                    previewData = data.preview;
                    sheetNames = data.sheet_names;
                    selectedSheet = sheetNames[0];
                    showSheetPreviewModal();
                } else {
                    showAlert('danger', data.error);
                }
            })
            .catch(error => {
                showLoading(false);
                showAlert('danger', 'Error previewing file: ' + error.message);
            });
        }

        function showSheetPreviewModal() {
            // Populate sheet select if multiple sheets
            const select = document.getElementById('sheetSelect');
            const selectContainer = document.getElementById('sheetSelectContainer');
            if (sheetNames.length > 1) {
                select.innerHTML = '';
                sheetNames.forEach(name => {
                    const opt = document.createElement('option');
                    opt.value = name;
                    opt.textContent = name;
                    select.appendChild(opt);
                });
                select.value = selectedSheet;
                selectContainer.style.display = '';
            } else {
                selectContainer.style.display = 'none';
            }
            renderSheetPreview(selectedSheet);
            select.onchange = function() {
                selectedSheet = select.value;
                renderSheetPreview(selectedSheet);
            };
            sheetModal.show();
        }

        function renderSheetPreview(sheet) {
            const container = document.getElementById('sheetPreviewTableContainer');
            if (!previewData[sheet]) {
                container.innerHTML = '<div class="text-danger">No preview available for this sheet.</div>';
                return;
            }
            const columns = previewData[sheet].columns;
            const rows = previewData[sheet].rows;
            let html = '<div class="table-responsive"><table class="table table-bordered"><thead><tr>';
            columns.forEach(col => html += `<th>${col}</th>`);
            html += '</tr></thead><tbody>';
            rows.forEach(row => {
                html += '<tr>';
                row.forEach(cell => html += `<td>${cell}</td>`);
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        document.getElementById('confirmImportBtn').onclick = function() {
            if (!pendingFile || !pendingDataType || !selectedSheet) return;
            showLoading(true);
            showAlert('', '');
            const formData = new FormData();
            formData.append('file', pendingFile);
            formData.append('data_type', pendingDataType);
            formData.append('sheet_name', selectedSheet);
            fetch('/import_with_sheet', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                sheetModal.hide();
                if (data.success) {
                    showAlert('success', data.message);
                    updateStatus(pendingDataType, data.rows);
                } else {
                    showAlert('danger', data.error);
                }
            })
            .catch(error => {
                showLoading(false);
                sheetModal.hide();
                showAlert('danger', 'Error importing file: ' + error.message);
            });
        };

        function refresh() {
            showLoading(true);
            showAlert('', '');

            fetch('/refresh', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                if (data.success) {
                    showAlert('success', data.message);
                } else {
                    showAlert('danger', data.error);
                }
            })
            .catch(error => {
                showLoading(false);
                showAlert('danger', 'Error refreshing data: ' + error.message);
            });
        }

        function calculateAbnormal() {
            showLoading(true);
            showAlert('', '');

            fetch('/calculate_abnormal', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                if (data.success) {
                    showAlert('success', data.message);
                    loadAbnormalData();
                } else {
                    showAlert('danger', data.error);
                }
            })
            .catch(error => {
                showLoading(false);
                showAlert('danger', 'Error calculating abnormal: ' + error.message);
            });
        }

        function loadAbnormalData() {
            fetch('/get_abnormal_data')
            .then(response => response.json())
            .then(data => {
                if (data.data && data.data.length > 0) {
                    displayAbnormalData(data.data);
                } else {
                    document.getElementById('abnormalTable').style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error loading abnormal data:', error);
            });
        }

        function displayAbnormalData(data) {
            const tableBody = document.getElementById('abnormalTableBody');
            tableBody.innerHTML = '';

            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.Employee}</td>
                    <td>${row.Date}</td>
                    <td>${row.SignIn}</td>
                    <td>${row.SignOut}</td>
                    <td><span class="badge bg-${row.Status === 'Late' ? 'danger' : 'warning'}">${row.Status}</span></td>
                    <td>${row.LateMinutes}</td>
                `;
                tableBody.appendChild(tr);
            });

            document.getElementById('abnormalTable').style.display = 'block';
        }

        function clearData(dataType) {
            if (!confirm(`Are you sure you want to clear ${dataType} data?`)) {
                return;
            }

            showLoading(true);
            showAlert('', '');

            fetch(`/clear/${dataType}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                if (data.success) {
                    showAlert('success', data.message);
                    updateStatus(dataType, 0);
                    
                    // Clear selected files
                    selectedFiles[dataType] = [];
                    updateFileListDisplay(dataType);
                    hideUploadButton(dataType);
                    
                    // Reset upload component UI
                    const statusElement = document.getElementById(`${dataType}Status`);
                    if (statusElement) statusElement.innerHTML = '';
                    const clearBtn = {
                        'signinout': document.getElementById('clearSigninoutBtn'),
                        'apply': document.getElementById('clearApplyBtn'),
                        'otlieu': document.getElementById('clearOtlieuBtn')
                    }[dataType];
                    if (clearBtn) clearBtn.classList.add('d-none');
                    // Reset input file
                    const fileInput = {
                        'signinout': document.getElementById('signinoutFile'),
                        'apply': document.getElementById('applyFile'),
                        'otlieu': document.getElementById('otlieuFile')
                    }[dataType];
                    if (fileInput) fileInput.value = '';
                } else {
                    showAlert('danger', data.error);
                }
            })
            .catch(error => {
                showLoading(false);
                showAlert('danger', 'Error clearing data: ' + error.message);
            });
        }

        function updateStatus(dataType, count) {
            const statusElement = document.getElementById(`${dataType}Status`);
            const clearBtn = {
                'signinout': document.getElementById('clearSigninoutBtn'),
                'apply': document.getElementById('clearApplyBtn'),
                'otlieu': document.getElementById('clearOtlieuBtn')
            }[dataType];
            if (count > 0) {
                // Get detailed information about the data
                fetch(`/get_current_data_info?data_type=${dataType}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.has_data) {
                            const columnCount = data.columns ? data.columns.length : 0;
                            statusElement.innerHTML = `
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-check text-success me-2"></i>
                                    <div>
                                        <div><strong>${count} records</strong> loaded</div>
                                        <div class="text-muted small">${columnCount} columns</div>
                                    </div>
                                </div>
                            `;
                        } else {
                            statusElement.innerHTML = '';
                        }
                    })
                    .catch(() => {
                        statusElement.innerHTML = `<i class="fas fa-check text-success"></i> ${count} records loaded`;
                    });
                if (clearBtn) clearBtn.classList.remove('d-none');
            } else {
                statusElement.innerHTML = '';
                if (clearBtn) clearBtn.classList.add('d-none');
            }
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showAlert(type, message) {
            const alertContainer = document.getElementById('alertContainer');
            if (message) {
                alertContainer.innerHTML = `
                    <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
            } else {
                alertContainer.innerHTML = '';
            }
        }

        // Auto-hide alerts after 5 seconds
        setInterval(() => {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            });
        }, 5000);

        // NAVIGATION LOGIC
        function showSection(sectionId) {
            // Hide all
            document.getElementById('rulesSection').style.display = 'none';
            document.getElementById('employeeListSection').style.display = 'none';
            document.getElementById('mainSection').style.display = 'none';
            document.getElementById('reportSection').style.display = 'none';
            // Remove active from all navs
            document.getElementById('navRules').classList.remove('active');
            document.getElementById('navEmployeeList').classList.remove('active');
            document.getElementById('navMain').classList.remove('active');
            document.getElementById('navReport').classList.remove('active');
            // Show selected
            document.getElementById(sectionId).style.display = '';
            // Set active nav
            if(sectionId==='rulesSection') document.getElementById('navRules').classList.add('active');
            if(sectionId==='employeeListSection') document.getElementById('navEmployeeList').classList.add('active');
            if(sectionId==='mainSection') document.getElementById('navMain').classList.add('active');
            if(sectionId==='reportSection') document.getElementById('navReport').classList.add('active');
            // Show/hide month/year dropdown
            if(sectionId==='reportSection') {
                document.getElementById('attendanceMonthYearContainer').style.display = 'flex';
                // Kh√¥ng c·∫ßn g·ªçi showReportLoading ·ªü ƒë√¢y v√¨ ƒë√£ ƒë∆∞·ª£c g·ªçi trong onclick c·ªßa navReport
            } else {
                document.getElementById('attendanceMonthYearContainer').style.display = 'none';
            }
            // Special: reload employee list if needed
            if(sectionId==='employeeListSection') {
                reloadEmployeeList();
                // Clear any active filters when switching to employee list section
                clearEmployeeFilter();
            }
            if(sectionId==='rulesSection') loadRulesTable();
            if(sectionId==='mainSection') initializeDateRange();
        }
        
        // Default to Main
        showSection('mainSection');

        // Date Range Functions for Data Tab
        function setDefaultDateRange() {
            const today = new Date();
            let startDate, endDate;
            
            if (today.getDate() >= 20) {
                // N·∫øu h√¥m nay t·ª´ ng√†y 20 tr·ªü ƒëi, t√≠nh t·ª´ 20 th√°ng tr∆∞·ªõc ƒë·∫øn 19 th√°ng n√†y
                startDate = new Date(today.getFullYear(), today.getMonth() - 1, 20);
                endDate = new Date(today.getFullYear(), today.getMonth(), 19);
            } else {
                // N·∫øu h√¥m nay tr∆∞·ªõc ng√†y 20, t√≠nh t·ª´ 20 th√°ng tr∆∞·ªõc ƒë·∫øn 19 th√°ng tr∆∞·ªõc
                startDate = new Date(today.getFullYear(), today.getMonth() - 2, 20);
                endDate = new Date(today.getFullYear(), today.getMonth() - 1, 19);
            }
            
            document.getElementById('dataStartDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('dataEndDate').value = endDate.toISOString().split('T')[0];
            
            updateDateRangeStatus();
        }

        function clearDateRange() {
            document.getElementById('dataStartDate').value = '';
            document.getElementById('dataEndDate').value = '';
            updateDateRangeStatus();
        }

        function getDateRange() {
            const startDate = document.getElementById('dataStartDate').value;
            const endDate = document.getElementById('dataEndDate').value;
            return { startDate, endDate };
        }

        function validateDateRange() {
            const startDate = document.getElementById('dataStartDate').value;
            const endDate = document.getElementById('dataEndDate').value;
            
            if (startDate && endDate && startDate > endDate) {
                showAlert('danger', 'Start date cannot be later than end date!');
                return false;
            }
            return true;
        }

        // Auto-set default date range when switching to main section
        function initializeDateRange() {
            if (document.getElementById('dataStartDate') && !document.getElementById('dataStartDate').value) {
                setDefaultDateRange();
            }
            updateDateRangeStatus();
        }

        function updateDateRangeStatus() {
            const startDate = document.getElementById('dataStartDate').value;
            const endDate = document.getElementById('dataEndDate').value;
            const statusDiv = document.getElementById('dateRangeStatus');
            const statusText = document.getElementById('currentDateRange');
            
            if (startDate && endDate) {
                statusDiv.style.display = 'block';
                statusText.textContent = `Current range: ${startDate} to ${endDate}`;
            } else if (startDate || endDate) {
                statusDiv.style.display = 'block';
                statusText.textContent = `Partial range: ${startDate || 'Not set'} to ${endDate || 'Not set'}`;
            } else {
                statusDiv.style.display = 'none';
            }
        }

        // Calculate button logic for Main
        function calculateMain() {
            showLoading(true);
            showAlert('', '');
            
            // Validate date range
            if (!validateDateRange()) {
                showLoading(false);
                return;
            }
            
            // Get date range
            const dateRange = getDateRange();
            
            // Create form data with date range
            const formData = new FormData();
            if (dateRange.startDate) formData.append('start_date', dateRange.startDate);
            if (dateRange.endDate) formData.append('end_date', dateRange.endDate);
            
            fetch('/calculate_abnormal', {
                method: 'POST',
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    showLoading(false);
                    if(data.success) {
                        showAlert('success', data.message);
                        // Fetch all 3 data tables and cache
                        Promise.all([
                            fetch('/get_signinout_data').then(res=>res.json()),
                            fetch('/get_apply_data').then(res=>res.json()),
                            fetch('/get_otlieu_data').then(res=>res.json())
                        ]).then(([signinout, apply, otlieu]) => {
                            cachedTables.signinout = signinout;
                            cachedTables.apply = apply;
                            cachedTables.otlieu = otlieu;
                            document.getElementById('dataTableSwitcherSection').style.display = '';
                            document.getElementById('reportBtn').style.display = '';
                            // Render the first tab (Sign In/Out) by default
                            renderTable('signinoutTableContainer', cachedTables.signinout.columns, cachedTables.signinout.data);
                        });
                    } else {
                        showAlert('danger', data.error);
                    }
                })
                .catch(() => {
                    showLoading(false);
                    showAlert('danger', 'Error calculating.');
                });
        }
        
        // --- Data Tab Event Listeners ---
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners for data tabs
            const dataTabs = ['nav-signinout', 'nav-apply', 'nav-otlieu'];
            dataTabs.forEach(tabId => {
                const tab = document.getElementById(tabId);
                if (tab) {
                    tab.addEventListener('click', function() {
                        // Small delay to ensure tab is active
                        setTimeout(() => {
                            renderActiveDataTable();
                        }, 100);
                    });
                }
            });
        });
        
        // --- Render Active Data Table ---
        function renderActiveDataTable() {
            // Check which tab is active
            if (document.getElementById('nav-signinout').classList.contains('active')) {
                renderTable('signinoutTableContainer', cachedTables.signinout.columns, cachedTables.signinout.data);
            } else if (document.getElementById('nav-apply').classList.contains('active')) {
                renderTable('applyTableContainer', cachedTables.apply.columns, cachedTables.apply.data, ['Type','Results','Leave Type']);
            } else if (document.getElementById('nav-otlieu').classList.contains('active')) {
                renderTable('otlieuTableContainer', cachedTables.otlieu.columns, cachedTables.otlieu.data);
            }
        }

        // --- Edit Mode Functions ---
        let isEditMode = false;
        let originalData = {};

        function toggleEditMode() {
            isEditMode = !isEditMode;
            updateEditModeUI();
            
            if (isEditMode) {
                // Store original data for potential rollback
                originalData = {
                    signinout: JSON.parse(JSON.stringify(cachedTables.signinout)),
                    apply: JSON.parse(JSON.stringify(cachedTables.apply)),
                    otlieu: JSON.parse(JSON.stringify(cachedTables.otlieu))
                };
                // Re-render current tab with edit mode
                renderActiveDataTable();
            } else {
                // Exit edit mode, re-render without edit mode
                renderActiveDataTable();
            }
        }

        function updateEditModeUI() {
            const editBtn = document.getElementById('editDataBtn');
            const saveBtn = document.getElementById('saveChangesBtn');
            const cancelBtn = document.getElementById('cancelEditBtn');
            const infoSpan = document.getElementById('editModeInfo');
            
            if (isEditMode) {
                editBtn.innerHTML = '<i class="fas fa-eye"></i> View Mode';
                editBtn.className = 'btn btn-outline-secondary btn-sm me-2';
                saveBtn.style.display = 'inline-block';
                cancelBtn.style.display = 'inline-block';
                infoSpan.textContent = 'Edit mode enabled - you can now edit cells directly';
            } else {
                editBtn.innerHTML = '<i class="fas fa-edit"></i> Edit Mode';
                editBtn.className = 'btn btn-outline-primary btn-sm me-2';
                saveBtn.style.display = 'none';
                cancelBtn.style.display = 'none';
                infoSpan.textContent = 'Click "Edit Mode" to enable editing';
            }
        }

        function saveAllChanges() {
            showLoading(true);
            showAlert('', '');
            
            // Save changes for each data type
            const promises = [];
            
            // Save Apply data changes
            if (cachedTables.apply && cachedTables.apply.data) {
                promises.push(
                    fetch('/save_apply_changes', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({data: cachedTables.apply.data})
                    }).then(res => res.json())
                );
            }
            
            // Save OT Lieu data changes
            if (cachedTables.otlieu && cachedTables.otlieu.data) {
                promises.push(
                    fetch('/save_otlieu_changes', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({data: cachedTables.otlieu.data})
                    }).then(res => res.json())
                );
            }
            
            // Save Sign In/Out data changes
            if (cachedTables.signinout && cachedTables.signinout.data) {
                promises.push(
                    fetch('/save_signinout_changes', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({data: cachedTables.signinout.data})
                    }).then(res => res.json())
                );
            }
            
            Promise.all(promises)
                .then(results => {
                    showLoading(false);
                    const allSuccess = results.every(r => r.success);
                    if (allSuccess) {
                        showAlert('success', 'All changes saved successfully!');
                        // Exit edit mode
                        isEditMode = false;
                        updateEditModeUI();
                        renderActiveDataTable();
                    } else {
                        const errors = results.filter(r => !r.success).map(r => r.error).join(', ');
                        showAlert('danger', 'Some changes failed to save: ' + errors);
                    }
                })
                .catch(error => {
                    showLoading(false);
                    showAlert('danger', 'Error saving changes: ' + error.message);
                });
        }

        function cancelEditMode() {
            if (confirm('Are you sure you want to cancel all changes? This will revert to the original data.')) {
                // Restore original data
                if (originalData.signinout) cachedTables.signinout = originalData.signinout;
                if (originalData.apply) cachedTables.apply = originalData.apply;
                if (originalData.otlieu) cachedTables.otlieu = originalData.otlieu;
                
                // Exit edit mode
                isEditMode = false;
                updateEditModeUI();
                renderActiveDataTable();
                
                showAlert('info', 'Changes cancelled, data restored to original state.');
            }
        }

        function refreshCurrentTable() {
            // Re-render the current active table to reflect changes
            renderActiveDataTable();
        }

        function updateCellValue(containerId, rowIdx, colIdx, newValue) {
            console.log('updateCellValue called:', containerId, rowIdx, colIdx, newValue);
            
            // Determine which data type based on containerId
            let dataType = 'signinout';
            if (containerId.includes('applyTableContainer')) dataType = 'apply';
            else if (containerId.includes('otlieuTableContainer')) dataType = 'otlieu';
            
            console.log('Data type determined:', dataType);
            
            // Update the cached data
            if (cachedTables[dataType] && cachedTables[dataType].data) {
                console.log('Cached data found for:', dataType);
                
                // For OT Lieu, handle special cases
                if (dataType === 'otlieu') {
                    const originalCell = cachedTables[dataType].data[rowIdx][colIdx];
                    console.log('Original cell:', originalCell);
                    
                    // If it was an error cell with suggest value, and user enters the correct value
                    if (originalCell && typeof originalCell === 'object' && originalCell.error && 
                        originalCell.suggest !== undefined && originalCell.suggest !== null) {
                        
                        console.log('Processing error cell with suggest value');
                        // Check if user entered the suggested correct value
                        if (newValue == originalCell.suggest) {
                            console.log('User entered correct value, replacing error object');
                            // Replace the error object with the correct value
                            cachedTables[dataType].data[rowIdx][colIdx] = newValue;
                            // Refresh table to show the corrected cell
                            setTimeout(() => refreshCurrentTable(), 100);
                        } else {
                            console.log('User entered different value, keeping error object');
                            // Keep the error object but update the value
                            cachedTables[dataType].data[rowIdx][colIdx] = {
                                value: newValue,
                                error: true,
                                suggest: originalCell.suggest
                            };
                        }
                    } else if (originalCell && typeof originalCell === 'object' && originalCell.warning) {
                        console.log('Processing warning cell');
                        // For warning cells, update the value but keep warning status
                        cachedTables[dataType].data[rowIdx][colIdx] = {
                            value: newValue,
                            warning: true
                        };
                    } else {
                        console.log('Normal cell update');
                        // Normal update
                        cachedTables[dataType].data[rowIdx][colIdx] = newValue;
                    }
                    
                    console.log('OT Lieu cell updated:', rowIdx, colIdx, newValue);
                } else {
                    console.log('Non-OT Lieu cell update');
                    // For other data types, simple update
                    cachedTables[dataType].data[rowIdx][colIdx] = newValue;
                }
                
                // Show a small indicator that the cell was updated
                const cell = document.querySelector(`#${containerId} input[onchange*="${rowIdx}"][onchange*="${colIdx}"]`);
                if (cell) {
                    cell.style.borderColor = '#28a745';
                    cell.style.backgroundColor = '#f8fff9';
                    setTimeout(() => {
                        // Restore original styling based on cell type
                        if (dataType === 'otlieu') {
                            const originalCell = cachedTables[dataType].data[rowIdx][colIdx];
                            if (originalCell && typeof originalCell === 'object' && originalCell.error) {
                                cell.style.borderColor = '#d32f2f';
                                cell.style.color = '#d32f2f';
                            } else if (originalCell && typeof originalCell === 'object' && originalCell.warning) {
                                cell.style.borderColor = '#e6b800';
                                cell.style.color = '#b38f00';
                            } else {
                                cell.style.borderColor = '#ddd';
                                cell.style.backgroundColor = 'transparent';
                            }
                        } else {
                            cell.style.borderColor = '#ddd';
                            cell.style.backgroundColor = 'transparent';
                        }
                    }, 1000);
                }
            } else {
                console.error('No cached data found for:', dataType);
            }
        }
        
        // --- Dropdown for Type & Leave Type in Apply Table ---
        let applyColumnOptions = {};
        fetch('/get_apply_column_options').then(res => res.json()).then(data => { applyColumnOptions = data; });
        
        // --- Scroll position persistence ---
        let lastScrollTop = 0;
        let lastScrollLeft = 0;
        
        // Enhanced renderTable: highlight new columns if provided
        function renderTable(containerId, columns, rows, highlightCols=[]) {
            const pageSize = 50;
            let currentPage = 1;
            const totalPages = Math.ceil(rows.length / pageSize);
            let editingRow = null;
            
            function renderPage(page) {
                currentPage = page;
                const container = document.getElementById(containerId);
                // Restore scroll position if available
                setTimeout(function() {
                    container.scrollTop = lastScrollTop;
                    container.scrollLeft = lastScrollLeft;
                }, 0);

                let html = '<div class="table-responsive"><table class="table table-bordered"><thead><tr>';
                html += '<tr>';
                columns.forEach(col => {
                    if (highlightCols && highlightCols.includes(col)) {
                        html += `<th style="background:#d0f0ff;">${col}</th>`;
                    } else {
                        html += `<th>${col}</th>`;
                    }
                });
                html += '</tr></thead><tbody>';
                const start = (page - 1) * pageSize;
                const end = Math.min(start + pageSize, rows.length);
                for (let i = start; i < end; i++) {
                    const realIdx = i; // realIdx l√† index th·ª±c t·∫ø trong to√†n b·∫£ng
                    html += '<tr>';
                    let row = rows[i];
                    for (let j = 0; j < columns.length; j++) {
                        const col = columns[j];
                        const cell = row[j];
                        const displayValue = (cell && typeof cell === 'object' && 'value' in cell) ? cell.value : cell;
                        // X√°c ƒë·ªãnh c√°c c·ªôt ƒë·∫∑c bi·ªát cho ph√©p xu·ªëng d√≤ng
                        const multilineCols = [
                            'Title',
                            'Application Type',
                            'Note',
                            'Proof about leaders arrange (2) Capture screen call/messages',
                            'Capture Screen (3) Check in and check out time',
                            'HRcheck (edit by HR) Tran ThiQuynhTrang00268175',
                            'Proof for pre-approval',
                            'Chek in/out screen capture'
                        ];
                        const isMultiline = multilineCols.some(name => col && col.toLowerCase().includes(name.toLowerCase()));
                        const tdClass = isMultiline ? 'special-multiline' : '';
                        // --- RED ERROR CELL LOGIC ---
                        if (cell && typeof cell === 'object' && cell.error) {
                            if (isEditMode) {
                                // In edit mode, use updateCellValue instead of saveErrorCell
                                html += `<td class="${tdClass}" style="background:#ffeaea;position:relative;">`;
                                html += `<input type="text" class="form-control form-control-sm" value="${displayValue}" 
                                       style="border:1.5px solid #d32f2f;color:#d32f2f;" 
                                       onchange="updateCellValue('${containerId}',${realIdx},${j},this.value)">`;
                                if (cell.suggest !== undefined && cell.suggest !== null) {
                                    html += `<div style="font-size:0.7em;color:#888;">Correct value: <span style="color:#1976d2;font-weight:bold;">${cell.suggest}</span></div>`;
                                }
                                html += `<div class="edit-indicator" style="position:absolute;top:2px;right:2px;font-size:0.7em;color:#007bff;">
                                    <i class="fas fa-edit"></i>
                                </div>`;
                                html += '</td>';
                            } else {
                                // Normal mode - use saveErrorCell
                            html += `<td class="${tdClass}" style="background:#ffeaea;position:relative;">`;
                            html += `<input type="text" class="form-control form-control-sm" value="${displayValue}" style="border:1.5px solid #d32f2f;color:#d32f2f;display:inline-block;width:70px;">`;
                            if (cell.suggest !== undefined && cell.suggest !== null) {
                                html += `<div style="font-size:0.7em;color:#888;">Correct value: <span style="color:#1976d2;font-weight:bold;">${cell.suggest}</span></div>`;
                            }
                            html += `<button class="btn btn-sm btn-success" style="position:absolute;right:2px;top:2px;font-size:0.7em;padding:1px 6px;" onclick="saveErrorCell('${containerId}',${realIdx},${j},this)"><i class='fas fa-check'></i></button>`;
                            html += '</td>';
                            }
                        } else if (cell && typeof cell === 'object' && cell.warning && ["OT From","OT To","Lieu From","Lieu To","OTSum","LieuSum"].some(cn => col && col.toLowerCase().replace(/\s/g,'') === cn.toLowerCase().replace(/\s/g,''))) {
                            // --- YELLOW WARNING CELL LOGIC ---
                            if (isEditMode) {
                                // In edit mode, use updateCellValue instead of saveErrorCell
                                html += `<td class="${tdClass}" style="background:#fffbe6;position:relative;">`;
                                html += `<input type="text" class="form-control form-control-sm" value="${displayValue}" 
                                       style="border:1.5px solid #e6b800;color:#b38f00;" 
                                       onchange="updateCellValue('${containerId}',${realIdx},${j},this.value)">`;
                                html += `<div style='font-size:0.7em;color:#b38f00;margin-top:2px;'>Format: <b>HH:MM</b></div>`;
                                html += `<div class="edit-indicator" style="position:absolute;top:2px;right:2px;font-size:0.7em;color:#007bff;">
                                    <i class="fas fa-edit"></i>
                                </div>`;
                                html += '</td>';
                            } else {
                                // Normal mode - use saveErrorCell
                            html += `<td class="${tdClass}" style="background:#fffbe6;position:relative;">`;
                            html += `<input type="text" class="form-control form-control-sm" value="${displayValue}" style="border:1.5px solid #e6b800;color:#b38f00;display:inline-block;width:90px;">`;
                            html += `<button class="btn btn-sm btn-success" style="position:absolute;right:2px;top:2px;font-size:0.7em;padding:1px 6px;" onclick="saveErrorCell('${containerId}',${realIdx},${j},this)" title="L∆∞u ch·ªânh s·ª≠a"><i class='fas fa-check'></i></button>`;
                            html += `<div style='font-size:0.7em;color:#b38f00;margin-top:2px;'>Format: <b>HH:MM</b></div>`;
                            html += '</td>';
                            }
                        } else if (cell && typeof cell === 'object' && cell.gray) {
                            // --- GRAY CELL LOGIC ---
                            html += `<td class="${tdClass}" style="background:#f2f2f2;color:#888;">${displayValue}</td>`;
                        } else if (columns.includes('Results') && editingRow === realIdx) {
                            // N·∫øu l√† d√≤ng ƒëang edit trong b·∫£ng Apply
                            if (col === 'Type') {
                                html += `<td><select class="form-select form-select-sm" id="edit_Type_${realIdx}">`;
                                (applyColumnOptions.Type || []).forEach(opt => {
                                    html += `<option value="${opt}" ${cell === opt ? 'selected' : ''}>${opt}</option>`;
                                });
                                html += `</select></td>`;
                            } else if (col === 'Leave Type') {
                                html += `<td><select class="form-select form-select-sm" id="edit_Leave_Type_${realIdx}">`;
                                (applyColumnOptions["Leave Type"] || []).forEach(opt => {
                                    html += `<option value="${opt}" ${cell === opt ? 'selected' : ''}>${opt}</option>`;
                                });
                                html += `</select></td>`;
                            } else if (col === 'Results') {
                                html += `<td><select class="form-select form-select-sm" id="editResults_${realIdx}">
                                    <option value="Approved" ${cell === "Approved" ? "selected" : ""}>Approved</option>
                                    <option value="Pending" ${cell === "Pending" ? "selected" : ""}>Pending</option>
                                    <option value="Reject" ${cell === "Reject" ? "selected" : ""}>Reject</option>
                                </select></td>`;
                            } else {
                                html += `<td class="${tdClass}">${displayValue}</td>`;
                            }
                        } else if (isEditMode && !columns.includes('Results')) {
                            // Edit mode - make cells editable, but preserve OT Lieu logic
                            if (containerId.includes('otlieuTableContainer')) {
                                // For OT Lieu, preserve the original logic but make editable
                                if (cell && typeof cell === 'object' && cell.error) {
                                    html += `<td class="${tdClass}" style="background:#ffeaea;position:relative;">
                                        <input type="text" class="form-control form-control-sm" value="${displayValue}" 
                                               style="border:1.5px solid #d32f2f;color:#d32f2f;" 
                                               onchange="updateCellValue('${containerId}',${realIdx},${j},this.value)">
                                        ${cell.suggest !== undefined && cell.suggest !== null ? 
                                            `<div style="font-size:0.7em;color:#888;">Correct value: <span style="color:#1976d2;font-weight:bold;">${cell.suggest}</span></div>` : ''}
                                        <div class="edit-indicator" style="position:absolute;top:2px;right:2px;font-size:0.7em;color:#007bff;">
                                            <i class="fas fa-edit"></i>
                                        </div>
                                    </td>`;
                                } else if (cell && typeof cell === 'object' && cell.warning && ["OT From","OT To","Lieu From","Lieu To","OTSum","LieuSum"].some(cn => col && col.toLowerCase().replace(/\s/g,'') === cn.toLowerCase().replace(/\s/g,''))) {
                                    html += `<td class="${tdClass}" style="background:#fffbe6;position:relative;">
                                        <input type="text" class="form-control form-control-sm" value="${displayValue}" 
                                               style="border:1.5px solid #e6b800;color:#b38f00;" 
                                               onchange="updateCellValue('${containerId}',${realIdx},${j},this.value)">
                                        <div style='font-size:0.7em;color:#b38f00;margin-top:2px;'>Format: <b>HH:MM</b></div>
                                        <div class="edit-indicator" style="position:absolute;top:2px;right:2px;font-size:0.7em;color:#007bff;">
                                            <i class="fas fa-edit"></i>
                                        </div>
                                    </td>`;
                                } else if (cell && typeof cell === 'object' && cell.gray) {
                                    html += `<td class="${tdClass}" style="background:#f2f2f2;color:#888;position:relative;">
                                        <input type="text" class="form-control form-control-sm" value="${displayValue}" 
                                               style="border:1px solid #ddd;background:transparent;" 
                                               onchange="updateCellValue('${containerId}',${realIdx},${j},this.value)">
                                        <div class="edit-indicator" style="position:absolute;top:2px;right:2px;font-size:0.7em;color:#007bff;">
                                            <i class="fas fa-edit"></i>
                                        </div>
                                    </td>`;
                                } else {
                                    html += `<td class="${tdClass}" style="position:relative;">
                                        <input type="text" class="form-control form-control-sm" value="${displayValue}" 
                                               style="border:1px solid #ddd;background:transparent;" 
                                               onchange="updateCellValue('${containerId}',${realIdx},${j},this.value)">
                                        <div class="edit-indicator" style="position:absolute;top:2px;right:2px;font-size:0.7em;color:#007bff;">
                                            <i class="fas fa-edit"></i>
                                        </div>
                                    </td>`;
                                }
                            } else {
                                // For other tables, simple editable cells
                                html += `<td class="${tdClass}" style="position:relative;">
                                    <input type="text" class="form-control form-control-sm" value="${displayValue}" 
                                           style="border:1px solid #ddd;background:transparent;" 
                                           onchange="updateCellValue('${containerId}',${realIdx},${j},this.value)">
                                    <div class="edit-indicator" style="position:absolute;top:2px;right:2px;font-size:0.7em;color:#007bff;">
                                        <i class="fas fa-edit"></i>
                                    </div>
                                </td>`;
                            }
                        } else {
                            html += `<td class="${tdClass}">${displayValue}</td>`;
                        }
                    }
                    if (columns.includes('Results')) {
                        if (editingRow === realIdx) {
                            html += `<td><button class='btn btn-sm btn-success' onclick='saveEditRow(${realIdx})'>Save</button> <button class='btn btn-sm btn-secondary' onclick='cancelEditRow()'>Cancel</button></td>`;
                        } else {
                            html += `<td><button class='btn btn-sm btn-outline-primary' onclick='editRow(${realIdx})'>Edit</button></td>`;
                        }
                    }
                    html += '</tr>';
                }
                html += '</tbody></table></div>';
                html += `<div class='d-flex justify-content-between align-items-center mt-2'>`;
                html += `<span>Page ${page} of ${totalPages}</span>`;
                html += `<div>`;
                html += `<button class='btn btn-sm btn-outline-secondary me-1' ${page === 1 ? 'disabled' : ''} id='${containerId}_prevPageBtn'>Prev</button>`;
                html += `<button class='btn btn-sm btn-outline-secondary' ${page === totalPages ? 'disabled' : ''} id='${containerId}_nextPageBtn'>Next</button>`;
                html += `</div></div>`;
                container.innerHTML = html;

                // Save scroll position on scroll
                container.onscroll = function() {
                    lastScrollTop = container.scrollTop;
                    lastScrollLeft = container.scrollLeft;
                };

                document.getElementById(`${containerId}_prevPageBtn`).onclick = function() {
                    if (currentPage > 1) {
                        renderPage(currentPage - 1);
                    }
                };
                document.getElementById(`${containerId}_nextPageBtn`).onclick = function() {
                    if (currentPage < totalPages) {
                        renderPage(currentPage + 1);
                    }
                };
            }
            // --- Save error cell handler ---
            window.saveErrorCell = function(containerId, rowIdx, colIdx, btn) {
                const table = btn.closest('table');
                const input = btn.closest('td').querySelector('input');
                const newValue = input.value;
                // N·∫øu l√† cell warning (b√¥i v√†ng) v√† v·∫´n sai ƒë·ªãnh d·∫°ng th·ªùi gian, c·∫£nh b√°o v√† kh√¥ng g·ª≠i API
                const td = btn.closest('td');
                if (td && td.style.background === 'rgb(255, 251, 230)') { // #fffbe6
                    // Ki·ªÉm tra ƒë·ªãnh d·∫°ng HH:MM 24h
                    const time24hRegex = /^([01]?\d|2[0-3]):[0-5]\d$/;
                    if (!time24hRegex.test(newValue.trim())) {
                        var timeFormatModal = new bootstrap.Modal(document.getElementById('timeFormatWarningModal'));
                        document.querySelector('#timeFormatWarningModal .modal-body').innerHTML =
                            'Please use the correct format when importing: <b>HH:MM</b>. For example: <b>09:30</b>, <b>17:45</b>, <b>21:00</b>.';
                        timeFormatModal.show();
                        return;
                    }
                }
                // Ki·ªÉm tra √¥ Sum (OT Sum, Lieu Sum): ch·ªâ ch·∫•p nh·∫≠n s·ªë th·∫≠p ph√¢n, kh√¥ng d·∫•u ph·∫©y, kh√¥ng ch·ªØ
                const columns = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
                const colName = columns[colIdx] || '';
                if (/sum/i.test(colName)) {
                    if (!/^[0-9]+(\.[0-9]+)?$/.test(newValue.trim())) {
                        var timeFormatModal = new bootstrap.Modal(document.getElementById('timeFormatWarningModal'));
                        document.querySelector('#timeFormatWarningModal .modal-body').innerHTML =
                            'Please enter a valid decimal number for Sum. Example: <b>8.5</b>, <b>2</b>, <b>10.0</b>';
                        timeFormatModal.show();
                        return;
                    }
                }
                // X√°c ƒë·ªãnh b·∫£ng OT Lieu hay Apply d·ª±a tr√™n containerId
                let type = 'otlieu';
                if (containerId.includes('applyTableContainer')) type = 'apply';
                else if (containerId.includes('signinoutTableContainer')) type = 'signinout';
                // G·ª≠i API update (ch·ªâ cho apply v√† otlieu)
                if (type === 'signinout') {
                    // Sign In/Out data kh√¥ng c√≥ API update, ch·ªâ update cache
                    cachedTables.signinout.data[rowIdx][colIdx] = newValue;
                    // Update DOM cell
                    const allRows = table.querySelectorAll('tbody tr');
                    if (allRows[rowIdx]) {
                        const tds = allRows[rowIdx].querySelectorAll('td');
                        if (tds[colIdx]) {
                            tds[colIdx].outerHTML = `<td>${newValue}</td>`;
                        }
                    }
                    return;
                }
                
                fetch(type === 'apply' ? '/update_apply_row' : '/update_otlieu_row', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({index: rowIdx, column: columns[colIdx], value: newValue})
                })
                .then(res => res.json())
                .then(data => {
                    console.log('API response:', data, 'Value sent:', newValue, 'Index:', rowIdx, 'Col:', columns[colIdx]);
                    if (data.success) {
                        // Ch·ªâ update l·∫°i cell/d√≤ng v·ª´a ch·ªânh s·ª≠a, kh√¥ng render l·∫°i to√†n b·∫£ng
                        // C·∫≠p nh·∫≠t cache
                        if (type === 'apply') {
                            cachedTables.apply.data[rowIdx][colIdx] = newValue;
                        } else if (type === 'otlieu') {
                            cachedTables.otlieu.data[rowIdx][colIdx] = newValue;
                        }
                        // Update DOM cell
                        const allRows = table.querySelectorAll('tbody tr');
                        if (allRows[rowIdx]) {
                            const tds = allRows[rowIdx].querySelectorAll('td');
                            if (tds[colIdx]) {
                                let cell;
                                if (type === 'apply') {
                                    cell = cachedTables.apply.data[rowIdx][colIdx];
                                } else if (type === 'otlieu') {
                                    cell = cachedTables.otlieu.data[rowIdx][colIdx];
                                } else {
                                    cell = cachedTables.signinout.data[rowIdx][colIdx];
                                }
                                let displayValue = (cell && typeof cell === 'object' && 'value' in cell) ? cell.value : cell;
                                if (cell && typeof cell === 'object' && cell.error) {
                                    tds[colIdx].outerHTML = `<td style="background:#ffeaea;position:relative;"><input type="text" class="form-control form-control-sm" value="${displayValue}" style="border:1.5px solid #d32f2f;color:#d32f2f;display:inline-block;width:70px;"><div style=\"font-size:0.7em;color:#888;\">Correct value: <span style=\"color:#1976d2;font-weight:bold;\">${cell.suggest ?? ''}</span></div><button class=\"btn btn-sm btn-success\" style=\"position:absolute;right:2px;top:2px;font-size:0.7em;padding:1px 6px;\"><i class='fas fa-check'></i></button></td>`;
                                    // G√°n l·∫°i event handler cho n√∫t tick (d√πng setTimeout ƒë·ªÉ ƒë·∫£m b·∫£o DOM ƒë√£ c·∫≠p nh·∫≠t)
                                    setTimeout(function() {
                                        const newTd = allRows[rowIdx].querySelectorAll('td')[colIdx];
                                        const btn = newTd && newTd.querySelector('button.btn-success');
                                        if (btn) {
                                            btn.onclick = function() {
                                                saveErrorCell(containerId, rowIdx, colIdx, btn);
                                            };
                                        }
                                    }, 0);
                                } else if (cell && typeof cell === 'object' && cell.warning) {
                                    tds[colIdx].outerHTML = `<td style=\"background:#fffbe6;position:relative;\"><input type=\"text\" class=\"form-control form-control-sm\" value=\"${displayValue}\" style=\"border:1.5px solid #e6b800;color:#b38f00;display:inline-block;width:90px;\"><button class=\"btn btn-sm btn-success\" style=\"position:absolute;right:2px;top:2px;font-size:0.7em;padding:1px 6px;\" title=\"L∆∞u ch·ªânh s·ª≠a\"><i class='fas fa-check'></i></button><div style='font-size:0.7em;color:#b38f00;margin-top:2px;'>Format: <b>HH:MM</b></div></td>`;
                                } else if (cell && typeof cell === 'object' && cell.gray) {
                                    tds[colIdx].outerHTML = `<td style=\"background:#f2f2f2;color:#888;\">${displayValue}</td>`;
                                } else {
                                    tds[colIdx].outerHTML = `<td>${displayValue}</td>`;
                                }
                            }
                        }
                        // N·∫øu backend tr·∫£ v·ªÅ updated (sum), update lu√¥n cell sum
                        if (type === 'otlieu' && data.updated) {
                            Object.entries(data.updated).forEach(([sumCol, sumVal]) => {
                                const sumIdx = columns.indexOf(sumCol);
                                if (sumIdx !== -1 && allRows[rowIdx]) {
                                    cachedTables.otlieu.data[rowIdx][sumIdx] = sumVal;
                                    const tds = allRows[rowIdx].querySelectorAll('td');
                                    let cell = sumVal;
                                    let displayValue = (cell && typeof cell === 'object' && 'value' in cell) ? cell.value : cell;
                                    if (cell && typeof cell === 'object' && cell.error) {
                                        tds[sumIdx].outerHTML = `<td style=\"background:#ffeaea;position:relative;\"><input type=\"text\" class=\"form-control form-control-sm\" value=\"${displayValue}\" style=\"border:1.5px solid #d32f2f;color:#d32f2f;display:inline-block;width:70px;\"><div style=\\\"font-size:0.7em;color:#888;\\">Correct value: <span style=\\\"color:#1976d2;font-weight:bold;\\">${cell.suggest ?? ''}</span></div><button class=\\\"btn btn-sm btn-success\\\" style=\\\"position:absolute;right:2px;top:2px;font-size:0.7em;padding:1px 6px;\\"><i class='fas fa-check'></i></button></td>`;
                                        // G√°n l·∫°i event handler cho n√∫t tick (d√πng setTimeout ƒë·ªÉ ƒë·∫£m b·∫£o DOM ƒë√£ c·∫≠p nh·∫≠t)
                                        setTimeout(function() {
                                            const newTd = allRows[rowIdx].querySelectorAll('td')[sumIdx];
                                            const btn = newTd && newTd.querySelector('button.btn-success');
                                            if (btn) {
                                                btn.onclick = function() {
                                                    saveErrorCell(containerId, rowIdx, sumIdx, btn);
                                                };
                                            }
                                        }, 0);
                                    } else {
                                        tds[sumIdx].outerHTML = `<td>${displayValue}</td>`;
                                    }
                                }
                            });
                        }
                    } else {
                        alert('Update failed: ' + (data.error||''));
                    }
                });
            };
            window.editRow = function(idx) {
                // Save scroll position before re-render
                const container = document.getElementById(containerId);
                lastScrollTop = container.scrollTop;
                lastScrollLeft = container.scrollLeft;
                editingRow = idx;
                renderPage(Math.floor(idx / pageSize) + 1);
            };
            window.cancelEditRow = function() {
                // Save scroll position before re-render
                const container = document.getElementById(containerId);
                lastScrollTop = container.scrollTop;
                lastScrollLeft = container.scrollLeft;
                editingRow = null;
                renderPage(currentPage);
            };
            window.saveEditRow = function(idx) {
                const updates = {};
                if (document.getElementById(`edit_Type_${idx}`)) {
                    updates['Type'] = document.getElementById(`edit_Type_${idx}`).value;
                }
                if (document.getElementById(`edit_Leave_Type_${idx}`)) {
                    updates['Leave Type'] = document.getElementById(`edit_Leave_Type_${idx}`).value;
                }
                if (document.getElementById(`editResults_${idx}`)) {
                    updates['Results'] = document.getElementById(`editResults_${idx}`).value;
                }
                // G·ª≠i t·ª´ng update
                const updatePromises = Object.entries(updates).map(([col, value]) =>
                    fetch('/update_apply_row', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({index: idx, column: col, value: value})
                    }).then(res => res.json())
                );
                Promise.all(updatePromises).then(results => {
                    let ok = results.every(r => r.success);
                    if (ok) {
                        if ('Type' in updates) rows[idx][columns.indexOf('Type')] = updates['Type'];
                        if ('Leave Type' in updates) rows[idx][columns.indexOf('Leave Type')] = updates['Leave Type'];
                        if ('Results' in updates) rows[idx][columns.indexOf('Results')] = updates['Results'];
                        editingRow = null;
                        renderPage(Math.floor(idx / pageSize) + 1);
                    } else {
                        alert('Update failed!');
                    }
                });
            };
            renderPage(currentPage);
        }
        
        // EMPLOYEE IMPORT FORM HANDLER
        (function() {
            const importForm = document.getElementById('employeeImportForm');
            if(importForm) {
                importForm.onsubmit = function(e) {
                    e.preventDefault();
                    const fileInput = document.getElementById('employeeImportFile');
                    if (!fileInput.files[0]) return alert('Choose a file.');
                    const formData = new FormData();
                    formData.append('file', fileInput.files[0]);
                    fetch('/upload_employee_list', {
                        method: 'POST',
                        body: formData
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message);
                            reloadEmployeeList();
                        } else {
                            alert(data.error);
                        }
                    });
                };
            }
        })();
        // Ensure reloadEmployeeList is defined
        function reloadEmployeeList() {
            fetch('/employee_list')
                .then(res => res.text())
                .then(html => {
                    document.getElementById('employeeListContent').innerHTML = html;
                });
        }

        // Employee Filter Functions
        function applyEmployeeFilter() {
            const dept = document.getElementById('filterDept').value;
            const intern = document.getElementById('filterIntern').value;
            
            // Build query string
            const params = new URLSearchParams();
            if (dept) params.append('dept', dept);
            if (intern) params.append('intern', intern);
            
            // Show loading
            document.getElementById('employeeListContent').innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Filtering employees...</p></div>';
            
            fetch(`/employee_list_filtered?${params.toString()}`)
                .then(res => res.text())
                .then(html => {
                    document.getElementById('employeeListContent').innerHTML = html;
                    // Update filter status
                    updateFilterStatus(dept, intern);
                })
                .catch(error => {
                    console.error('Error applying filter:', error);
                    document.getElementById('employeeListContent').innerHTML = '<div class="text-danger">Error applying filter. Please try again.</div>';
                });
        }

        function updateFilterStatus(dept, intern) {
            const activeFilters = [];
            if (dept) activeFilters.push(`Dept: ${dept}`);
            if (intern) activeFilters.push(`Intern: ${intern}`);
            
            // Show active filters if any
            const filterStatusDiv = document.getElementById('filterStatus');
            if (activeFilters.length > 0) {
                if (!filterStatusDiv) {
                    const statusDiv = document.createElement('div');
                    statusDiv.id = 'filterStatus';
                    statusDiv.className = 'alert alert-info alert-sm mb-2';
                    statusDiv.innerHTML = `<strong>Active Filters:</strong> ${activeFilters.join(', ')}`;
                    document.getElementById('employeeListContent').insertBefore(statusDiv, document.getElementById('employeeListContent').firstChild);
                } else {
                    filterStatusDiv.innerHTML = `<strong>Active Filters:</strong> ${activeFilters.join(', ')}`;
                }
            } else if (filterStatusDiv) {
                filterStatusDiv.remove();
            }
        }

        function clearEmployeeFilter() {
            // Clear all filter inputs
            document.getElementById('filterDept').value = '';
            document.getElementById('filterIntern').value = '';
            
            // Remove filter status
            const filterStatusDiv = document.getElementById('filterStatus');
            if (filterStatusDiv) {
                filterStatusDiv.remove();
            }
            
            // Reload the full employee list
            reloadEmployeeList();
        }

        // Add keyboard shortcuts for filtering
        document.addEventListener('DOMContentLoaded', function() {
            // Add Enter key support for filter inputs
            const filterInputs = ['filterDept', 'filterIntern'];
            filterInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            applyEmployeeFilter();
                        }
                    });
                }
            });
            
            // Add event listeners for date range inputs
            const dateInputs = ['dataStartDate', 'dataEndDate'];
            dateInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', updateDateRangeStatus);
                }
            });
        });
        // EMPLOYEE ADD FORM HANDLER
        (function() {
            const addForm = document.getElementById('addEmployeeForm');
            if(addForm) {
                addForm.onsubmit = function(e) {
                    e.preventDefault();
                    const name = addForm.elements['Name'].value.trim();
                    const idNumber = addForm.elements['ID Number'].value.trim();
                    const dept = addForm.elements['Dept'].value.trim();
                    let internship = addForm.elements['Internship'].value.trim();
                    if (!name || !idNumber) {
                        alert('Name and ID Number are required!');
                        return;
                    }
                    // Convert Internship: Yes -> 'Intern', No/blank -> ''
                    if (internship === 'Yes') internship = 'Intern';
                    else internship = '';
                    fetch('/add_employee', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({Name: name, 'ID Number': idNumber, Dept: dept, Internship: internship})
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            reloadEmployeeList();
                            addForm.reset();
                        } else {
                            alert(data.error);
                        }
                    });
                };
            }
        })();
        function removeEmployee(idx) {
            if (!confirm('Are you sure you want to delete this employee?')) return;
            fetch('/remove_employee', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({index: idx})
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    reloadEmployeeList();
                } else {
                    alert(data.error);
                }
            });
        }

        // RULES TABLE LOGIC
        let rulesTableData = {columns: [], rows: []};
        let rulesTableEdits = {};
        function loadRulesTable() {
            fetch('/get_rules_table')
                .then(res => res.json())
                .then(data => {
                    rulesTableData = data;
                    rulesTableEdits = {};
                    renderRulesTable(data.columns, data.rows);
                });
        }

        function renderRulesTable(columns, rows) {
            let html = '<div class="table-responsive"><table class="table table-bordered special-rules-table"><thead><tr>';
            columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr></thead><tbody>';
            const hyperlinkColumns = [
                "chek in/out screen capture",
                "proof for pre-approval",
                "capture screen (3) check in and check out time",
                "proof about leaders arrange (2) capture screen call/messages",
                "title"
            ];
            function normalizeColName(name) {
                return String(name).trim().toLowerCase();
            }
            rows.forEach((row, idx) => {
                html += '<tr>';
                row.forEach((cell, j) => {
                    const colName = columns[j];
                    const normColName = normalizeColName(colName);
                    // Hyperlink logic for specific columns (case-insensitive, trimmed)
                    if (hyperlinkColumns.includes(normColName)) {
                        const cellStr = String(cell).trim();
                        // If it's a URL, render as link
                        if (cellStr.startsWith('http://') || cellStr.startsWith('https://')) {
                            html += `<td><a href="${cellStr}" target="_blank" rel="noopener noreferrer">${cellStr}</a></td>`;
                        }
                        // If it's a PDF or image filename, link to /uploads/
                        else if (/\.(pdf|jpg|jpeg|png|gif)$/i.test(cellStr)) {
                            html += `<td><a href="/uploads/${encodeURIComponent(cellStr)}" target="_blank" rel="noopener noreferrer">${cellStr}</a></td>`;
                        }
                        else {
                            html += `<td>${cellStr}</td>`;
                        }
                        return;
                    }
                    const colNameLower = normColName;
                    if (
                        colNameLower.includes('date') ||
                        colNameLower === 'holiday date in this year' ||
                        colNameLower === 'special weekend' ||
                        colNameLower === 'special work day'
                    ) {
                        html += `<td style="position:relative;">
                            <input type="text" class="form-control form-control-sm flatpickr-datetime" value="${cell}" onchange="trackRuleEdit(${idx},${j},this.value)">
                            <span class="clear-cell-x" onclick="clearCell(${idx},${j}, this)" title="Clear" style="display:${cell ? 'inline' : 'none'};">&times;</span>
                            <span class="calendar-cell-icon" style="display:${cell ? 'none' : 'inline'};" title="Pick date">
                              <i class='fas fa-calendar-alt'></i>
                            </span>
                        </td>`;
                    } else {
                        html += `<td style="position:relative;" contenteditable="true" oninput="trackRuleEdit(${idx},${j},this.innerText)">
                            ${cell}
                            <span class="clear-cell-x" onclick="clearCell(${idx},${j}, this)" title="Clear">&times;</span>
                        </td>`;
                    }
                });
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            document.getElementById('rulesTableContainer').innerHTML = html;
            // Add class to Special Weekend, Holiday Date in This Year, Special Work Day headers
            setTimeout(function() {
                document.querySelectorAll('.special-rules-table th').forEach(th => {
                    const header = th.textContent.trim();
                    if (
                        header === 'Special Weekend' ||
                        header === 'Holiday Date in This Year' ||
                        header === 'Special Work Day'
                    ) {
                        th.classList.add('special-rules-header-large');
                    }
                });
                // Initialize Flatpickr on all relevant inputs
                document.querySelectorAll('.flatpickr-datetime').forEach(el => {
                    flatpickr(el, {
                        enableTime: true,
                        dateFormat: "Y-m-d H:i",
                        time_24hr: true,
                        allowInput: true
                    });
                    el.addEventListener('input', function() {
                        const td = el.closest('td');
                        const xIcon = td.querySelector('.clear-cell-x');
                        const calIcon = td.querySelector('.calendar-cell-icon');
                        if (el.value) {
                            xIcon.style.display = 'inline';
                            calIcon.style.display = 'none';
                        } else {
                            xIcon.style.display = 'none';
                            calIcon.style.display = 'inline';
                        }
                    });
                    // Trigger once on load
                    el.dispatchEvent(new Event('input'));
                });
            }, 0);
        }

        function trackRuleEdit(rowIdx, colIdx, value) {
            if (!rulesTableEdits[rowIdx]) rulesTableEdits[rowIdx] = {};
            rulesTableEdits[rowIdx][colIdx] = value;
        }

        function saveRulesTable() {
            // Gather all edits and send in one request
            const edits = [];
            for (const row in rulesTableEdits) {
                for (const col in rulesTableEdits[row]) {
                    edits.push({row: parseInt(row), col: parseInt(col), value: rulesTableEdits[row][col]});
                }
            }
            if (edits.length === 0) {
                showAlert('warning', 'No changes to save.');
                return;
            }
            fetch('/batch_update_rule_cells', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({edits: edits})
            }).then(res => res.json()).then(data => {
                if (data.success) {
                    showAlert('success', 'Rules saved successfully!');
                    var saveModal = new bootstrap.Modal(document.getElementById('saveCompletedModal'));
                    saveModal.show();
                    loadRulesTable();
                } else {
                    showAlert('danger', 'Save failed: ' + (data.error || ''));
                }
            });
        }
        
        function deleteRuleRow(idx) {
            fetch('/delete_rule_row', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({row: idx})
            }).then(res => res.json()).then(data => {
                if (data.success) loadRulesTable();
                else alert('Delete failed!');
            });
        }
        
        function addRuleRow() {
            fetch('/add_rule_row', {method: 'POST'})
                .then(res => res.json())
                .then(data => { if (data.success) loadRulesTable(); else alert('Add failed!'); });
        }

        function clearCell(rowIdx, colIdx, el) {
            // Find the input or contenteditable in the same cell and clear it
            const td = el.closest('td');
            const input = td.querySelector('input');
            if (input) {
                input.value = '';
                input.dispatchEvent(new Event('change'));
                // Reset UI: ·∫©n X, hi·ªán l·∫°i icon calendar
                const xIcon = td.querySelector('.clear-cell-x');
                const calIcon = td.querySelector('.calendar-cell-icon');
                if (xIcon) xIcon.style.display = 'none';
                if (calIcon) calIcon.style.display = 'inline';
            } else {
                td.innerText = '';
                trackRuleEdit(rowIdx, colIdx, '');
                // Re-add the X icon after clearing
                td.appendChild(el);
            }
        }

        // Go to Report Tab
        function goToReport() {
            // Check OT Lieu data for error/warning cells
            const otlieu = cachedTables.otlieu && cachedTables.otlieu.data ? cachedTables.otlieu.data : [];
            let hasError = false, hasWarning = false;
            for (let i = 0; i < otlieu.length; i++) {
                for (let j = 0; j < otlieu[i].length; j++) {
                    const cell = otlieu[i][j];
                    if (cell && typeof cell === 'object') {
                        if (cell.error) hasError = true;
                        if (cell.warning) hasWarning = true;
                    }
                }
            }
            if (hasError || hasWarning) {
                let msg = 'Please resolve all highlighted cells in OT Lieu data before proceeding to the report.<br>';
                if (hasError) msg += '- <b>Red cells</b>: Invalid or inconsistent values.<br>';
                if (hasWarning) msg += '- <b>Yellow cells</b>: Invalid or missing time format (should be HH:MM).';
                document.getElementById('otlieuValidationModalBody').innerHTML = msg;
                var otlieuModal = new bootstrap.Modal(document.getElementById('otlieuValidationModal'));
                otlieuModal.show();
                return;
            }
            // Switch to report tab directly with loading
            showSection('reportSection');
            showReportLoading();
        }

        // Back to Edit
        if(document.getElementById('backToEditBtn')) {
            document.getElementById('backToEditBtn').onclick = function() {
                showSection('mainSection');
            };
        }
        
        // Review Data
        if(document.getElementById('reviewDataBtn')) {
            document.getElementById('reviewDataBtn').onclick = function() {
                var reviewModal = new bootstrap.Modal(document.getElementById('reviewDataModal'));
                reviewModal.show();
                // Fetch v√† render d·ªØ li·ªáu t·ª´ file t·∫°m v√†o c√°c tab
                Promise.all([
                    fetch('/get_temp_signinout_data').then(res=>res.json()),
                    fetch('/get_temp_apply_data').then(res=>res.json()),
                    fetch('/get_temp_otlieu_data').then(res=>res.json())
                ]).then(([signinout, apply, otlieu]) => {
                    renderPreviewTable('reviewSigninoutTab', signinout.columns, signinout.data);
                    renderPreviewTable('reviewApplyTab', apply.columns, apply.data);
                    renderPreviewTable('reviewOtlieuTab', otlieu.columns, otlieu.data);
                });
            };
        }
      
        function renderPreviewTable(containerId, columns, rows) {
            const container = document.getElementById(containerId);
            if (!columns || columns.length === 0) {
                container.innerHTML = '<div class="text-muted">No data loaded.</div>';
                return;
            }
            const pageSize = 50;
            let currentPage = 1;
            const totalPages = Math.ceil(rows.length / pageSize);


            function renderPage(page) {
                currentPage = page;
                let html = '<div class="table-responsive"><table class="table table-bordered">';

                // Total Attendance Detail Tab Logic
                if (containerId === 'totalAttendanceDetailTab') {
                    const baseCols = [
                        'No', '14 Digits Employee ID', "Employee's name", 'Group'
                    ];
                    const attendanceCols = [
                        'Normal working days',
                        'Annual leave (100% salary)',
                        'Sick leave (50% salary)',
                        'Unpaid leave (0% salary)',
                        'Welfare leave (100% salary)',
                        'Total'
                    ];
                    const violationCols = [
                        'Late/Leave early (mins)',
                        'Late/Leave early (times)',
                        'Forget scanning',
                        'Violation'
                    ];
                    const remainCols = [
                        'Remark',
                        'Attendance for salary payment'
                    ];

                    html += '<thead><tr>';
                    baseCols.forEach(c => html += `<th rowspan="2">${c}</th>`);
                    html += `<th colspan="6" style="background:#e0f7fa;">Attendance</th>`;
                    html += `<th colspan="4" style="background:#ffeaea;">Violation</th>`;
                    remainCols.forEach(c => html += `<th rowspan="2">${c}</th>`);
                    html += '</tr><tr>';
                    attendanceCols.forEach(c => html += `<th style="background:#e0f7fa;">${c}</th>`);
                    violationCols.forEach(c => html += `<th style="background:#ffeaea;">${c}</th>`);
                    html += '</tr></thead>';
                }
                
                // OT Lieu Report Tab Logic
                else if (containerId === 'otlieuReportTab') {
                    // X√°c ƒë·ªãnh nh√≥m c·ªôt
                    const baseCols = ['No', 'Employee ID', 'Employee Name'];
                    const otPayCols = ['OT weekday 150%', 'OT weekday night 200%', 'OT weekly holiday 200%', 'OT weekly holiday night 270%', 'OT public holiday 300%', 'OT public holiday night 390%'];
                    const otLieuCols = ['OT weekday 150% (lieu)', 'OT weekday night 200% (lieu)', 'OT weekly holiday 200% (lieu)', 'OT weekly holiday night 270% (lieu)', 'OT public holiday 300% (lieu)', 'OT public holiday night 390% (lieu)', 'Transferred to normal working hours'];
                    const timeoffCols = ['Date', 'Total used hours in month'];
                    const remainCols = ['Remain unused time off in lieu', 'Total OT paid'];

                    // Header d√≤ng 1
                    html += '<thead><tr>';
                    baseCols.forEach(c => html += `<th rowspan="2">${c}</th>`);
                    html += `<th colspan="6" class="ot-payment-col">OVERTIME (For payment)</th>`;
                    html += `<th colspan="7" class="lieu-col">OVERTIME (No pay, For later time in lieu)</th>`;
                    html += `<th colspan="2" class="timeoff-col">Time off in lieu (hour)</th>`;
                    remainCols.forEach(c => html += `<th rowspan="2">${c}</th>`);
                    html += '</tr><tr>';
                    
                    otPayCols.forEach(c => html += `<th class="ot-payment-col">${c}</th>`);
                    otLieuCols.forEach(c => html += `<th class="lieu-col">${c}</th>`);
                    timeoffCols.forEach(c => html += `<th class="timeoff-col">${c}</th>`);
                    html += '</tr></thead>';
                }
                
                // OT Lieu Before tab logic
                else if (containerId === 'otlieuBeforeTab') {
                    // X√°c ƒë·ªãnh nh√≥m c·ªôt
                    // Gi·∫£ s·ª≠: OT Payment l√† c√°c c·ªôt c√≥ "OT" ho·∫∑c "Payment", Change in Lieu l√† c√°c c·ªôt c√≥ "Lieu" ho·∫∑c "Change"
                    const otPaymentCols = [];
                    const changeInLieuCols = [];
                    const otherCols = [];
                    columns.forEach((col, idx) => {
                        if (col.startsWith('OT Payment: ')) otPaymentCols.push(idx);
                        else if (col.startsWith('Change in lieu: ')) changeInLieuCols.push(idx);
                        else otherCols.push(idx);
                    });

                    // Header d√≤ng 1
                    html += '<thead><tr>';
                    // C√°c c·ªôt ƒë·∫ßu (n·∫øu c√≥)
                    if (otherCols.length > 0) {
                        otherCols.forEach(idx => {
                            html += `<th rowspan="2">${columns[idx]}</th>`;
                        });
                    }
                    if (otPaymentCols.length > 0) {
                        html += `<th colspan="${otPaymentCols.length}" style="background:#b3e0ff;">OT Payment</th>`;
                    }
                    if (changeInLieuCols.length > 0) {
                        html += `<th colspan="${changeInLieuCols.length}" style="background:#fff7b3;">Change in Lieu</th>`;
                    }
                    html += '</tr><tr>';
                    // D√≤ng 2: t√™n c·ªôt con
                    if (otPaymentCols.length > 0) {
                        otPaymentCols.forEach(idx => {
                            html += `<th style="background:#e3f2fd;">${columns[idx].replace('OT Payment: ', '')}</th>`;
                        });
                    }
                    if (changeInLieuCols.length > 0) {
                        changeInLieuCols.forEach(idx => {
                            html += `<th style="background:#fffde7;">${columns[idx].replace('Change in lieu: ', '')}</th>`;
                        });
                    }
                    html += '</tr></thead>';
                    // Body
                    html += '<tbody>';
                    const start = (page - 1) * pageSize;
                    const end = Math.min(start + pageSize, rows.length);
                    for (let i = start; i < end; i++) {
                        html += '<tr>';
                        // Other cols
                        otherCols.forEach(idx => {
                            let displayValue = (rows[i][idx] && typeof rows[i][idx] === 'object' && 'value' in rows[i][idx]) ? rows[i][idx].value : rows[i][idx];
                            html += `<td>${displayValue}</td>`;
                        });
            // OT Payment
            otPaymentCols.forEach(idx => {
                let displayValue = (rows[i][idx] && typeof rows[i][idx] === 'object' && 'value' in rows[i][idx]) ? rows[i][idx].value : rows[i][idx];
                if (
                    displayValue === '' || displayValue === null || displayValue === undefined ||
                    (typeof displayValue === 'number' && isNaN(displayValue)) ||
                    parseFloat(displayValue) === 0
                ) {
                    displayValue = '-';
                }
                html += `<td>${displayValue}</td>`;
            });
            // Change in Lieu
            changeInLieuCols.forEach(idx => {
                let displayValue = (rows[i][idx] && typeof rows[i][idx] === 'object' && 'value' in rows[i][idx]) ? rows[i][idx].value : rows[i][idx];
                if (
                    displayValue === '' || displayValue === null || displayValue === undefined ||
                    (typeof displayValue === 'number' && isNaN(displayValue)) ||
                    parseFloat(displayValue) === 0
                ) {
                    displayValue = '-';
                }
                html += `<td>${displayValue}</td>`;
            });
                        html += '</tr>';
                    }
                    html += '</tbody></table></div>';
                    html += `<div class='d-flex justify-content-between align-items-center mt-2'>`;
                    html += `<span>Page ${page} of ${totalPages}</span>`;
                    html += `<div>`;
                    html += `<button class='btn btn-sm btn-outline-secondary me-1' ${page === 1 ? 'disabled' : ''} id='${containerId}_prevPageBtn'>Prev</button>`;
                    html += `<button class='btn btn-sm btn-outline-secondary' ${page === totalPages ? 'disabled' : ''} id='${containerId}_nextPageBtn'>Next</button>`;
                    html += `</div></div>`;
                    container.innerHTML = html;
                    document.getElementById(`${containerId}_prevPageBtn`).onclick = function() {
                        if (currentPage > 1) renderPage(currentPage - 1);
                    };
                    document.getElementById(`${containerId}_nextPageBtn`).onclick = function() {
                        if (currentPage < totalPages) renderPage(currentPage + 1);
                    };
                    return; // D·ª´ng ·ªü ƒë√¢y, kh√¥ng render c√°c tab kh√°c
                }


                // Attendance Report Tab Logic
                else if (containerId === 'attendanceReportTab') {
                    console.log('Rendering Attendance Report tab...');
                    console.log('Columns:', columns);
                    console.log('First row:', rows[0]);
                    
                    // T√≠nh s·ªë ng√†y ƒë·ªông - c·∫•u tr√∫c: Department, Name, Shift, Date columns, Summary columns
                    const dayStartIdx = 3; // sau Department, Name, Shift
                    const dayEndIdx = columns.length - 8; // 8 c·ªôt t·ªïng h·ª£p cu·ªëi
                    const dayCols = columns.slice(dayStartIdx, dayEndIdx);
                    
                    console.log('Day columns:', dayCols);
                    console.log('Day start idx:', dayStartIdx, 'Day end idx:', dayEndIdx);

                    // Header 1
                    html += `<thead><tr>
                        <th rowspan="3" style="background:#fff;" data-col="Department">Department</th>
                        <th rowspan="3" style="background:#fff;text-align:center;" data-col="Name">Name</th>
                        <th colspan="${dayCols.length}">Date</th>
                        <th rowspan="3" style="background:#4caf50;color:#fff;" data-col="Normal">Normal<br><span style="font-size:0.8em;">Times</span></th>
                        <th rowspan="3" style="background:#fbc02d;" data-col="Leave">Leave<br><span style="font-size:0.8em;">Times</span></th>
                        <th rowspan="3" style="background:#b39ddb;" data-col="Trip">Trip<br><span style="font-size:0.8em;">Times</span></th>
                        <th rowspan="3" style="background:#f44336;color:#fff;" data-col="Miss">Miss<br><span style="font-size:0.8em;">Times</span></th>
                        <th colspan="3" style="background:#29b6f6;" data-col="Late/Soon">Late/Soon</th>
                        <th rowspan="3" style="background:#ffd54f;" data-col="Lieu">Lieu<br><span style="font-size:0.8em;">Hours</span></th>
                        <th rowspan="3" style="background:#ffb74d;" data-col="OT">OT<br><span style="font-size:0.8em;">Hours</span></th>
                        <th rowspan="3" style="background:#4dd0e1;" data-col="Supplement">Supplement<br><span style="font-size:0.8em;">Times</span></th>
                    </tr>`;

                    // Header 2: th·ª© trong tu·∫ßn
                    html += `<tr>`;
                    dayCols.forEach((col) => {
                        let d = new Date(col);
                        let wd = isNaN(d.getTime()) ? '' : ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()];
                        let color = (d.getDay() === 6 || d.getDay() === 0) ? 'background:#CCF8FE;' : '';
                        html += `<th style="text-align:center;${color}" data-col="${col}">${wd}</th>`;
                    });
                    html += `<th style="background:#29b6f6;">Times</th>`;
                    html += `<th style="background:#e0e0e0;">Times</th>`;
                    html += `<th style="background:#fff9c4;">Minus</th>`;
                    html += `</tr>`;

                    // Header 3: ng√†y s·ªë
                    html += `<tr>`;
                    dayCols.forEach((col) => {
                        let d = new Date(col);
                        let day = isNaN(d.getTime()) ? '' : d.getDate();
                        let color = (d.getDay() === 6 || d.getDay() === 0) ? 'background:#CCF8FE;' : '';
                        html += `<th style="text-align:center;${color}" data-col="${col}">${day}</th>`;
                    });
                                         html += `<th></th><th></th><th></th>`; // LateSoon summary
                     html += `</tr></thead><tbody>`;
                     
                     // Body: hi·ªÉn th·ªã d·ªØ li·ªáu t·ª´ backend (ƒë√£ c√≥ s·∫µn 2 d√≤ng cho m·ªói nh√¢n vi√™n)
                     const start = (page - 1) * pageSize;
                     const end = Math.min(start + pageSize, rows.length);
                     for (let i = start; i < end; i++) {
                         let row = rows[i];
                         html += `<tr>`;
                         
                         // Department v√† Name (ch·ªâ hi·ªÉn th·ªã ·ªü d√≤ng ƒë·∫ßu ti√™n c·ªßa m·ªói nh√¢n vi√™n)
                         if (i % 2 === 0) {
                             // T√¨m d√≤ng ti·∫øp theo ƒë·ªÉ t√≠nh rowspan
                             let rowspan = 1;
                             if (i + 1 < rows.length && rows[i + 1][1] === row[1]) {
                                 rowspan = 2;
                             }
                             html += `<td rowspan="${rowspan}" style="background:#fff;vertical-align:middle;text-align:center;" data-col="Department">${row[0]}</td>`;
                             html += `<td rowspan="${rowspan}" style="background:#fff;vertical-align:middle;text-align:left;" data-col="Name">${row[1]}</td>`;
                         }
                         
                         for (let d = dayStartIdx; d < dayEndIdx; d++) {
                             let val = row[d];
                                 let cellColor = '';
                                 
                                 // Logic t√¥ m√†u d·ª±a tr√™n gi√° tr·ªã t·ª´ backend
                                 if (val === 'Miss') {
                                     cellColor = 'background:#ffcdd2;color:#d32f2f;font-weight:bold;'; // Miss - n·ªÅn ƒë·ªè, ch·ªØ ƒë·ªè ƒë·∫≠m
                                 } else if (val === 'Leave') {
                                     cellColor = 'background:#ffe0b2;font-weight:bold;'; // Leave - v√†ng nh·∫°t
                                 } else if (val === 'Trip') {
                                     cellColor = 'background:#bbdefb;font-weight:bold;'; // Trip - xanh d∆∞∆°ng nh·∫°t
                                 } else if (val === 'Supplement') {
                                     cellColor = 'background:#c5cae9;font-weight:bold;'; // Supplement - t√≠m nh·∫°t
                                 } else if (val === 'Lieu') {
                                     cellColor = 'background:#e1bee7;font-weight:bold;'; // Lieu - h·ªìng nh·∫°t
                                 } else if (val === 'Late/Soon') {
                                     cellColor = 'background:#fff9c4;color:#d32f2f;font-weight:bold;'; // Late/Soon - n·ªÅn v√†ng, ch·ªØ ƒë·ªè ƒë·∫≠m
                                 } else if (val === '') {
                                     cellColor = 'background:#fffff;'; // Tr·ªëng - x√°m
                                 } else if (val && val.startsWith('LATE:')) {
                                     // Late/Soon v·ªõi th·ªùi gian th·ª±c t·∫ø
                                     cellColor = 'background:#fff9c4;color:#d32f2f;font-weight:bold;'; // N·ªÅn v√†ng, ch·ªØ ƒë·ªè ƒë·∫≠m
                                     val = val.replace('LATE:', ''); // Ch·ªâ hi·ªÉn th·ªã th·ªùi gian
                                 } else if (val && val.startsWith('NORMAL:')) {
                                     // Normal v·ªõi th·ªùi gian th·ª±c t·∫ø
                                     cellColor = 'background:#c8e6c9;font-weight:bold;'; // N·ªÅn xanh l√°
                                     val = val.replace('NORMAL:', ''); // Ch·ªâ hi·ªÉn th·ªã th·ªùi gian
                                 } else if (val === 'Normal') {
                                     cellColor = 'background:#c8e6c9;font-weight:bold;'; // Normal - n·ªÅn xanh l√°
                                 }
                                 
                                 html += `<td style="text-align:center;${cellColor}" data-col="${columns[d]}">${val || ''}</td>`;
                             }
                             
                             // T·ªïng h·ª£p (ch·ªâ hi·ªÉn th·ªã ·ªü d√≤ng ƒë·∫ßu ti√™n c·ªßa m·ªói nh√¢n vi√™n)
                             if (i % 2 === 0) {
                                 // T√¨m d√≤ng ti·∫øp theo ƒë·ªÉ t√≠nh rowspan
                                 let rowspan = 1;
                                 if (i + 1 < rows.length && rows[i + 1][1] === row[1]) {
                                     rowspan = 2;
                                 }
                                 
                                 for (let d = dayEndIdx; d < columns.length; d++) {
                                     let colName = columns[d];
                                     if (colName === 'Late/Soon') {
                                         // Hi·ªÉn th·ªã 3 c·ªôt cho Late/Soon
                                         html += `<td rowspan="${rowspan}" style="text-align:center;" data-col="Late/Soon">${row[d]}</td>`; // Times 1
                                         html += `<td rowspan="${rowspan}" style="text-align:center;" data-col="Late/Soon">0</td>`; // Times 2
                                         html += `<td rowspan="${rowspan}" style="text-align:center;" data-col="Late/Soon">0</td>`; // Minus
                                     } else {
                                         html += `<td rowspan="${rowspan}" style="text-align:center;" data-col="${colName}">${row[d]}</td>`;
                                     }
                                 }
                             }
                             html += `</tr>`;
                     }
                     html += `</tbody></table></div>`;
                     
                     // Pagination
                     html += `<div class='d-flex justify-content-between align-items-center mt-2'>`;
                     html += `<span>Page ${page} of ${totalPages}</span>`;
                     html += `<div>`;
                     html += `<button class='btn btn-sm btn-outline-secondary me-1' ${page === 1 ? 'disabled' : ''} id='${containerId}_prevPageBtn'>Prev</button>`;
                     html += `<button class='btn btn-sm btn-outline-secondary' ${page === totalPages ? 'disabled' : ''} id='${containerId}_nextPageBtn'>Next</button>`;
                     html += `</div></div>`;
                     
                     console.log('Setting container HTML...');
                     console.log('Container:', container);
                     console.log('HTML length:', html.length);
                     container.innerHTML = html;
                     console.log('Container HTML set successfully');
                     
                     // Add pagination buttons if they exist
                     const prevBtn = document.getElementById(`${containerId}_prevPageBtn`);
                     const nextBtn = document.getElementById(`${containerId}_nextPageBtn`);
                     
                     if (prevBtn) {
                         prevBtn.onclick = function() {
                             if (currentPage > 1) renderPage(currentPage - 1);
                         };
                     }
                     if (nextBtn) {
                         nextBtn.onclick = function() {
                             if (currentPage < totalPages) renderPage(currentPage + 1);
                         };
                     }
                     return; // D·ª´ng ·ªü ƒë√¢y, kh√¥ng render c√°c tab kh√°c
                }

                else {
                    html += '<thead><tr>';
                    columns.forEach(col => html += `<th>${col}</th>`);
                    html += '</tr></thead>';
                }
                
                html += '<tbody>';
                const start = (page - 1) * pageSize;
                const end = Math.min(start + pageSize, rows.length);
                for (let i = start; i < end; i++) {
                    html += '<tr>';
                    let row = rows[i];
                    for (let j = 0; j < columns.length; j++) {
                        let displayValue = (row[j] && typeof row[j] === 'object' && 'value' in row[j]) ? row[j].value : row[j];
                        
                        // X·ª≠ l√Ω hi·ªÉn th·ªã cho Total Attendance Detail tab
                        if (containerId === 'totalAttendanceDetailTab') {
                            const colName = columns[j];
                            // C√°c c·ªôt s·ªë c·∫ßn hi·ªÉn th·ªã "-" n·∫øu gi√° tr·ªã l√† 0 ho·∫∑c r·ªóng
                            const numericCols = [
                                'Normal working days',
                                'Annual leave (100% salary)',
                                'Sick leave (50% salary)',
                                'Unpaid leave (0% salary)',
                                'Welfare leave (100% salary)',
                                'Total',
                                'Late/Leave early (mins)',
                                'Late/Leave early (times)',
                                'Forget scanning',
                                'Violation',
                                'Attendance for salary payment'
                            ];
                            
                            if (numericCols.includes(colName)) {
                                // Ki·ªÉm tra n·∫øu gi√° tr·ªã l√† 0, 0.0, r·ªóng ho·∫∑c null
                                if (displayValue === '' || displayValue === null || displayValue === undefined ||
                                    displayValue === '0' || displayValue === '0.0' || 
                                    (typeof displayValue === 'number' && displayValue === 0)) {
                                    displayValue = '-';
                                }
                            }
                        }
                        
                        // X·ª≠ l√Ω hi·ªÉn th·ªã cho OT Lieu Report tab
                        else if (containerId === 'otlieuReportTab') {
                            const colName = columns[j];
                            // C√°c c·ªôt s·ªë c·∫ßn hi·ªÉn th·ªã "-" n·∫øu gi√° tr·ªã l√† 0 ho·∫∑c r·ªóng
                            const numericCols = [
                                'OT weekday 150%',
                                'OT weekday night 200%',
                                'OT weekly holiday 200%',
                                'OT weekly holiday night 270%',
                                'OT public holiday 300%',
                                'OT public holiday night 390%',
                                'OT weekday 150% (lieu)',
                                'OT weekday night 200% (lieu)',
                                'OT weekly holiday 200% (lieu)',
                                'OT weekly holiday night 270% (lieu)',
                                'OT public holiday 300% (lieu)',
                                'OT public holiday night 390% (lieu)',
                                'Transferred to normal working hours',
                                'Date',
                                'Total used hours in month',
                                'Remain unused time off in lieu',
                                'Total OT paid'
                            ];
                            
                            if (numericCols.includes(colName)) {
                                // Ki·ªÉm tra n·∫øu gi√° tr·ªã l√† 0, 0.0, r·ªóng ho·∫∑c null
                                if (displayValue === '' || displayValue === null || displayValue === undefined ||
                                    displayValue === '0' || displayValue === '0.0' || 
                                    (typeof displayValue === 'number' && displayValue === 0)) {
                                    displayValue = '-';
                                }
                                
                                // Highlight cho c·ªôt "Total OT paid" khi > 25
                                if (colName === 'Total OT paid' && displayValue !== '-') {
                                    const otValue = parseFloat(displayValue);
                                    if (!isNaN(otValue) && otValue > 25) {
                                        displayValue = `<span style="background-color: #ffebee; color: #d32f2f; font-weight: bold; padding: 2px 6px; border-radius: 3px; border: 1px solid #d32f2f;">${displayValue}</span>`;
                                    }
                                }
                            }
                        }
                        
                        html += `<td>${displayValue}</td>`;
                    }
                    html += '</tr>';
                }
                html += '</tbody></table></div>';
                html += `<div class='d-flex justify-content-between align-items-center mt-2'>`;
                html += `<span>Page ${page} of ${totalPages}</span>`;
                html += `<div>`;
                html += `<button class='btn btn-sm btn-outline-secondary me-1' ${page === 1 ? 'disabled' : ''} id='${containerId}_prevPageBtn'>Prev</button>`;
                html += `<button class='btn btn-sm btn-outline-secondary' ${page === totalPages ? 'disabled' : ''} id='${containerId}_nextPageBtn'>Next</button>`;
                html += `</div></div>`;
                container.innerHTML = html;
                document.getElementById(`${containerId}_prevPageBtn`).onclick = function() {
                    if (currentPage > 1) renderPage(currentPage - 1);
                };
                document.getElementById(`${containerId}_nextPageBtn`).onclick = function() {
                    if (currentPage < totalPages) renderPage(currentPage + 1);
                };
            }
            renderPage(currentPage);
        }

        // Lieu Followup modal logic
        if(document.getElementById('lieuFollowupBtn')) {
            document.getElementById('lieuFollowupBtn').onclick = function() {
                var modal = new bootstrap.Modal(document.getElementById('lieuFollowupModal'));
                loadLieuFollowupTable();
                modal.show();
            };
        }
        function loadLieuFollowupTable() {
            fetch('/get_lieu_followup').then(res=>res.json()).then(data => {
                renderLieuFollowupTable(data.columns, data.data);
            });
        }
        function renderLieuFollowupTable(columns, rows) {
            const container = document.getElementById('lieuFollowupTableContainer');
            if (!columns || columns.length === 0) {
                container.innerHTML = '<div class="text-muted">No data loaded.</div>';
                return;
            }
            let html = '<div class="table-responsive"><table class="table table-bordered"><thead><tr>';
            columns.forEach(col => html += `<th>${col}</th>`);
            html += '<th>Action</th></tr></thead><tbody>';
            rows.forEach((row, idx) => {
                html += '<tr>';
                row.forEach((cell, j) => {
                    if (columns[j] === 'Lieu remain previous month') {
                        html += `<td><input type="number" class="form-control form-control-sm" value="${cell}" onchange="updateLieuFollowupRow(${idx},'${columns[j]}',this.value)"></td>`;
                    } else if (columns[j] === 'Name') {
                        html += `<td><input type="text" class="form-control form-control-sm" value="${cell}" onchange="updateLieuFollowupRow(${idx},'${columns[j]}',this.value)"></td>`;
                    } else {
                        html += `<td>${cell}</td>`;
                    }
                });
                html += `<td><button class='btn btn-sm btn-danger' onclick='deleteLieuFollowupRow(${idx})'>Delete</button></td>`;
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }
        function updateLieuFollowupRow(idx, col, value) {
            fetch('/update_lieu_followup_row', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({index: idx, column: col, value: value})
            }).then(res => res.json()).then(data => {
                if (!data.success) alert(data.error||'Update failed!');
            });
        }
        function deleteLieuFollowupRow(idx) {
            if (!confirm('Delete this row?')) return;
            fetch('/delete_lieu_followup_row', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({index: idx})
            }).then(res => res.json()).then(data => {
                if (data.success) loadLieuFollowupTable();
                else alert(data.error||'Delete failed!');
            });
        }
        document.getElementById('lieuFollowupImportBtn').onclick = function() {
            const fileInput = document.getElementById('lieuFollowupImportFile');
            if (!fileInput.files[0]) return alert('Choose a file.');
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            fetch('/import_lieu_followup', {
                method: 'POST',
                body: formData
            }).then(res => res.json()).then(data => {
                if (data.success) loadLieuFollowupTable();
                else alert(data.error||'Import failed!');
            });
        };
        document.getElementById('lieuFollowupAddBtn').onclick = function() {
            const name = prompt('Employee name?');
            if (!name) return;
            const remain = prompt('Lieu remain previous month?', '0');
            fetch('/add_lieu_followup_row', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({Name: name, 'Lieu remain previous month': remain})
            }).then(res => res.json()).then(data => {
                if (data.success) loadLieuFollowupTable();
                else alert(data.error||'Add failed!');
            });
        };

        // OT Lieu Before tab logic
        function loadOtlieuBeforeTab() {
            const container = document.getElementById('otlieuBeforeTab');
            if (window.reportData && window.reportData.otlieuBefore) {
                renderPreviewTable('otlieuBeforeTab', window.reportData.otlieuBefore.columns, window.reportData.otlieuBefore.data);
            } else {
                container.innerHTML = '<div class="text-muted">Loading...</div>';
                fetch('/get_otlieu_before').then(res=>res.json()).then(data => {
                    renderPreviewTable('otlieuBeforeTab', data.columns, data.data);
                });
            }
        }
        // G·ªçi khi chuy·ªÉn tab OT Lieu Before
        if(document.getElementById('nav-otlieu-before')) {
            document.getElementById('nav-otlieu-before').addEventListener('shown.bs.tab', loadOtlieuBeforeTab);
        }

        // Ch·∫∑n chuy·ªÉn sang tab Report n·∫øu thi·∫øu d·ªØ li·ªáu
        if(document.getElementById('navReport')) {
            document.getElementById('navReport').onclick = function(e) {
                // Ki·ªÉm tra cachedTables ƒë√£ c√≥ d·ªØ li·ªáu ch∆∞a
                if (!cachedTables.signinout || !cachedTables.signinout.data || cachedTables.signinout.data.length === 0 ||
                    !cachedTables.apply || !cachedTables.apply.data || cachedTables.apply.data.length === 0 ||
                    !cachedTables.otlieu || !cachedTables.otlieu.data || cachedTables.otlieu.data.length === 0) {
                    e.preventDefault();
                    var modal = new bootstrap.Modal(document.getElementById('missingDataModal'));
                    modal.show();
                    return false;
                }
                // N·∫øu ƒë·ªß d·ªØ li·ªáu th√¨ cho chuy·ªÉn tab v√† hi·ªÉn th·ªã loading
                showSection('reportSection');
                showReportLoading();
            };
        }
        
        // Hi·ªÉn th·ªã loading screen cho Report
        function showReportLoading() {
            document.getElementById('reportLoadingScreen').style.display = 'flex';
            document.getElementById('reportContent').style.display = 'none';
            
            // Reset progress bar
            const progressBar = document.querySelector('.loading-progress-bar');
            progressBar.style.width = '0%';
            
            // Load t·∫•t c·∫£ d·ªØ li·ªáu report c·∫ßn thi·∫øt
            const currentMonth = new Date().getMonth() + 1;
            const currentYear = new Date().getFullYear();
            
            // T·∫°o array c√°c promises v·ªõi progress tracking
            const promises = [
                fetch('/get_otlieu_before').then(res => res.json()),
                fetch('/get_otlieu_report').then(res => res.json()),
                fetch('/get_total_attendance_detail').then(res => res.json()),
                fetch('/get_attendance_report?month=' + currentMonth + '&year=' + currentYear).then(res => res.json())
            ];
            
            let completedCount = 0;
            const totalCount = promises.length;
            
            // Wrap each promise to track progress
            const trackedPromises = promises.map((promise, index) => {
                return promise.then(result => {
                    completedCount++;
                    const progress = (completedCount / totalCount) * 100;
                    progressBar.style.width = progress + '%';
                    return result;
                });
            });
            
            Promise.all(trackedPromises).then(([otlieuBefore, otlieuReport, totalAttendance, attendanceReport]) => {
                // Cache d·ªØ li·ªáu
                window.reportData = {
                    otlieuBefore: otlieuBefore,
                    otlieuReport: otlieuReport,
                    totalAttendance: totalAttendance,
                    attendanceReport: {
                        ...attendanceReport,
                        month: currentMonth,
                        year: currentYear
                    }
                };
                
                // Complete progress bar
                progressBar.style.width = '100%';
                
                // ·∫®n loading v√† hi·ªÉn th·ªã content
                setTimeout(() => {
                    document.getElementById('reportLoadingScreen').style.display = 'none';
                    document.getElementById('reportContent').style.display = 'block';
                    
                    // Load tab ƒë·∫ßu ti√™n
                    loadOtlieuBeforeTab();
                }, 300); // Delay nh·ªè ƒë·ªÉ UX m∆∞·ª£t m√† h∆°n
            }).catch(error => {
                console.error('Error loading report data:', error);
                // ·∫®n loading v√† hi·ªÉn th·ªã content ngay c·∫£ khi c√≥ l·ªói
                setTimeout(() => {
                    document.getElementById('reportLoadingScreen').style.display = 'none';
                    document.getElementById('reportContent').style.display = 'block';
                }, 500);
            });
        }

        // OT Lieu Report tab logic
        function loadOtlieuReportTab() {
            const container = document.getElementById('otlieuReportTab');
            if (window.reportData && window.reportData.otlieuReport) {
                renderPreviewTable('otlieuReportTab', window.reportData.otlieuReport.columns, window.reportData.otlieuReport.data);
            } else {
                container.innerHTML = '<div class="text-muted">Loading...</div>';
                fetch('/get_otlieu_report').then(res=>res.json()).then(data => {
                    renderPreviewTable('otlieuReportTab', data.columns, data.data);
                });
            }
        }
        if(document.getElementById('nav-otlieu-report')) {
            document.getElementById('nav-otlieu-report').addEventListener('shown.bs.tab', loadOtlieuReportTab);
        }

        // Total Attendance Detail tab logic
        function loadTotalAttendanceDetailTab() {
            const container = document.getElementById('totalAttendanceDetailTab');
            if (window.reportData && window.reportData.totalAttendance) {
                renderPreviewTable('totalAttendanceDetailTab', window.reportData.totalAttendance.columns, window.reportData.totalAttendance.data);
            } else {
                container.innerHTML = '<div class="text-muted">Loading...</div>';
                fetch('/get_total_attendance_detail').then(res=>res.json()).then(data => {
                    renderPreviewTable('totalAttendanceDetailTab', data.columns, data.data);
                });
            }
        }
        if(document.getElementById('nav-total-attendance')) {
            document.getElementById('nav-total-attendance').addEventListener('shown.bs.tab',loadTotalAttendanceDetailTab)
        }

        // Attendance Report Tab Logic
        function loadAttendanceReportTab() {
            const monthSel = document.getElementById('attendanceMonth');
            const yearSel = document.getElementById('attendanceYear');
            if (monthSel && monthSel.options.length === 0) {
                for (let m = 1; m <= 12; m++) {
                    monthSel.innerHTML += `<option value="${m}">${m}</option>`;
                }
                const now = new Date();
                for (let y = now.getFullYear() - 1; y <= now.getFullYear() + 1; y++) {
                    yearSel.innerHTML += `<option value="${y}">${y}</option>`;
                }
                monthSel.value = now.getMonth() + 1;
                yearSel.value = now.getFullYear();
            }
            monthSel.onchange = loadAttendanceReportTable;
            yearSel.onchange = loadAttendanceReportTable;
            loadAttendanceReportTable();
        }

        function loadAttendanceReportTable() {
            // L·∫ßn ƒë·∫ßu load: kh√¥ng g·ª≠i parameter ƒë·ªÉ backend t·ª± ƒë·ªông x√°c ƒë·ªãnh
            const month = document.getElementById('attendanceMonth').value;
            const year = document.getElementById('attendanceYear').value;
            
            console.log('Loading attendance report...');
            
            // Ki·ªÉm tra xem c√≥ d·ªØ li·ªáu cache cho th√°ng/nƒÉm hi·ªán t·∫°i kh√¥ng
            if (window.reportData && window.reportData.attendanceReport && 
                window.reportData.attendanceReport.month == month && 
                window.reportData.attendanceReport.year == year) {
                renderPreviewTable('attendanceReportTab', window.reportData.attendanceReport.columns, window.reportData.attendanceReport.rows);
                updateAttendanceReportPeriod(window.reportData.attendanceReport);
            } else {
                // Fetch d·ªØ li·ªáu m·ªõi - kh√¥ng g·ª≠i parameter ƒë·ªÉ backend t·ª± ƒë·ªông x√°c ƒë·ªãnh
                fetch(`/get_attendance_report`)
                    .then(res => res.json())
                    .then(data => {
                        console.log('Received data:', data);
                        console.log('Columns:', data.columns);
                        console.log('Rows count:', data.rows ? data.rows.length : 0);
                        console.log('First row:', data.rows ? data.rows[0] : 'No rows');
                        console.log('Period element exists:', !!document.getElementById('attendanceReportPeriod'));
                        
                        // Cache d·ªØ li·ªáu m·ªõi
                        if (window.reportData) {
                            window.reportData.attendanceReport = {
                                ...data,
                                month: month,
                                year: year
                            };
                        }
                        console.log('About to render table...');
                        try {
                            renderPreviewTable('attendanceReportTab', data.columns, data.rows);
                            console.log('Table rendered successfully');
                        } catch (error) {
                            console.error('Error rendering table:', error);
                        }
                        updateAttendanceReportPeriod(data);
                        
                        // C·∫≠p nh·∫≠t dropdown theo th√°ng ƒë∆∞·ª£c x√°c ƒë·ªãnh t·ª´ backend
                        updateDropdownFromData(data);
                    })
                    .catch(error => {
                        console.error('Error loading attendance report:', error);
                    });
            }
        }
        
        function updateDropdownFromData(data) {
            if (data.columns && data.columns.length > 0) {
                // T√¨m c·ªôt ng√†y ƒë·∫ßu ti√™n v√† cu·ªëi c√πng
                const dayColumns = data.columns.slice(3, -8); // B·ªè qua Department, Name, Shift v√† 8 c·ªôt t·ªïng h·ª£p cu·ªëi
                if (dayColumns.length > 0) {
                    const firstDate = new Date(dayColumns[0]);
                    const lastDate = new Date(dayColumns[dayColumns.length - 1]);
                    
                    if (!isNaN(firstDate.getTime()) && !isNaN(lastDate.getTime())) {
                        // L·∫•y th√°ng/nƒÉm t·ª´ ng√†y gi·ªØa
                        const middleDate = new Date((firstDate.getTime() + lastDate.getTime()) / 2);
                        const detectedMonth = middleDate.getMonth() + 1; // getMonth() tr·∫£ v·ªÅ 0-11
                        const detectedYear = middleDate.getFullYear();
                        
                        // C·∫≠p nh·∫≠t dropdown
                        const monthSel = document.getElementById('attendanceMonth');
                        const yearSel = document.getElementById('attendanceYear');
                        
                        if (monthSel && yearSel) {
                            monthSel.value = detectedMonth;
                            yearSel.value = detectedYear;
                        }
                    }
                }
            }
        }
        
        function updateAttendanceReportPeriod(data) {
            let periodElement = document.getElementById('attendanceReportPeriod');
            if (!periodElement) {
                // T·∫°o element n·∫øu kh√¥ng t·ªìn t·∫°i
                const headerDiv = document.getElementById('attendanceReportHeader');
                if (headerDiv) {
                    periodElement = document.createElement('div');
                    periodElement.id = 'attendanceReportPeriod';
                    periodElement.className = 'text-muted mb-2';
                    periodElement.style.fontSize = '0.9rem';
                    headerDiv.insertBefore(periodElement, headerDiv.children[1]); // Insert after h2
                    console.log('Created period element dynamically');
                } else {
                    console.log('Header div not found, skipping period update');
                    return;
                }
            }
            
            if (data.columns && data.columns.length > 0) {
                // T√¨m c·ªôt ng√†y ƒë·∫ßu ti√™n v√† cu·ªëi c√πng
                const dayColumns = data.columns.slice(3, -8); // B·ªè qua Department, Name, Shift v√† 8 c·ªôt t·ªïng h·ª£p cu·ªëi
                if (dayColumns.length > 0) {
                    const firstDate = dayColumns[0];
                    const lastDate = dayColumns[dayColumns.length - 1];
                    
                    // Parse ng√†y th√°ng
                    const startDate = new Date(firstDate);
                    const endDate = new Date(lastDate);
                    
                    if (!isNaN(startDate.getTime()) && !isNaN(endDate.getTime())) {
                        const startStr = startDate.toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' });
                        const endStr = endDate.toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' });
                        periodElement.innerHTML = `<strong>Period:</strong> ${startStr} - ${endStr} <span class="text-info">(Auto-detected from data)</span>`;
                    } else {
                        periodElement.innerHTML = '<span class="text-warning">Unable to determine period from data</span>';
                    }
                } else {
                    periodElement.innerHTML = '<span class="text-warning">No date columns found</span>';
                }
            } else {
                periodElement.innerHTML = '<span class="text-warning">No data available</span>';
            }
        }

        if(document.getElementById('nav-attendance-report')) {
            document.getElementById('nav-attendance-report').addEventListener('shown.bs.tab', loadAttendanceReportTab)
        }

        // Kh·ªüi t·∫°o dropdown th√°ng/nƒÉm khi v√†o report l·∫ßn ƒë·∫ßu
        let attendanceMonthInit = false;
        function initAttendanceMonthYearDropdown() {
            if (attendanceMonthInit) return;
            const monthSel = document.getElementById('attendanceMonth');
            const yearSel = document.getElementById('attendanceYear');
            if (monthSel && monthSel.options.length === 0) {
                for (let m = 1; m <= 12; m++) {
                    monthSel.innerHTML += `<option value="${m}">${m}</option>`;
                }
                const now = new Date();
                for (let y = now.getFullYear() - 1; y <= now.getFullYear() + 1; y++) {
                    yearSel.innerHTML += `<option value="${y}">${y}</option>`;
                }
                monthSel.value = now.getMonth() + 1;
                yearSel.value = now.getFullYear();
            }
            monthSel.onchange = loadAttendanceReportTab;
            yearSel.onchange = loadAttendanceReportTab;
            attendanceMonthInit = true;
        }
        // G·ªçi khi v√†o reportSection
        const oldShowSection = showSection;
        showSection = function(sectionId) {
            oldShowSection(sectionId);
            if(sectionId==='reportSection') {
                initAttendanceMonthYearDropdown();
                loadAttendanceReportTab();
            }
        }

        // Dynamic title and favicon management
        let originalTitle = document.title;
        let originalFavicon = document.querySelector('link[rel="icon"]').href;
        
        function updatePageTitle(message, type = 'info') {
            if (message) {
                const prefix = type === 'error' ? '‚ö†Ô∏è ' : type === 'success' ? '‚úÖ ' : '‚ÑπÔ∏è ';
                document.title = `${prefix}${message} - ${originalTitle}`;
            } else {
                document.title = originalTitle;
            }
        }
        
        function updateFavicon(type = 'default') {
            const faviconLink = document.querySelector('link[rel="icon"]');
            if (type === 'error') {
                faviconLink.href = "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><circle cx='16' cy='16' r='15' fill='%23f44336'/><text x='16' y='22' text-anchor='middle' fill='white' font-size='16' font-weight='bold'>!</text></svg>";
            } else if (type === 'success') {
                faviconLink.href = "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><circle cx='16' cy='16' r='15' fill='%233bb273'/><text x='16' y='22' text-anchor='middle' fill='white' font-size='16' font-weight='bold'>‚úì</text></svg>";
            } else {
                faviconLink.href = originalFavicon;
            }
        }
        
        // Override showAlert to update title and favicon
        const originalShowAlert = showAlert;
        showAlert = function(type, message) {
            originalShowAlert(type, message);
            updatePageTitle(message, type);
            updateFavicon(type);
            
            // Reset after 5 seconds
            if (message) {
                setTimeout(() => {
                    updatePageTitle('');
                    updateFavicon('default');
                }, 5000);
            }
        };

        // Export button handler
        document.addEventListener('DOMContentLoaded', function() {
            const exportBtn = document.getElementById('exportAttendanceReportBtn');
            if (exportBtn) {
                exportBtn.addEventListener('click', function() {
                    showLoading(true);
                    showAlert('', '');
                    
                    fetch('/export')
                        .then(response => {
                            showLoading(false);
                            if (!response.ok) {
                                throw new Error('Export failed');
                            }
                            return response.blob();
                        })
                        .then(blob => {
                            // Create download link
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.style.display = 'none';
                            a.href = url;
                            a.download = `AttendanceReport_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.xlsx`;
                            document.body.appendChild(a);
                            a.click();
                            window.URL.revokeObjectURL(url);
                            document.body.removeChild(a);
                            
                            showAlert('success', 'Export completed successfully!');
                        })
                        .catch(error => {
                            showLoading(false);
                            console.error('Export error:', error);
                            showAlert('danger', 'Export failed. Please try again.');
                        });
                });
            }
        });

    </script>
</body>
</html> 